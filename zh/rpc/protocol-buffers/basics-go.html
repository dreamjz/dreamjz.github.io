<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Protocol Buffer Basics: Go | 今朝のブログ</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
    <link rel="shortcut icon" herf="favicon.ico">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-3RQ3LRSTKM"></script>
    <script>window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());
		  
			gtag('config', 'G-3RQ3LRSTKM');</script>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="google-site-verification" content="lHBWOiWCnBWvc1h4REqjllalv9ZpQbXbHDdM8chFuuw">
    
    <link rel="preload" href="/assets/css/0.styles.af604b7b.css" as="style"><link rel="preload" href="/assets/js/app.35ae0727.js" as="script"><link rel="preload" href="/assets/js/6.af237152.js" as="script"><link rel="preload" href="/assets/js/1.44a00389.js" as="script"><link rel="preload" href="/assets/js/105.cf4e4bdc.js" as="script"><link rel="prefetch" href="/assets/js/10.2deab33d.js"><link rel="prefetch" href="/assets/js/100.e98c1a94.js"><link rel="prefetch" href="/assets/js/101.3b124b5f.js"><link rel="prefetch" href="/assets/js/102.d8136b95.js"><link rel="prefetch" href="/assets/js/103.cc0ae299.js"><link rel="prefetch" href="/assets/js/104.f9224530.js"><link rel="prefetch" href="/assets/js/106.f6de6afc.js"><link rel="prefetch" href="/assets/js/107.20ff0b05.js"><link rel="prefetch" href="/assets/js/108.01a5515e.js"><link rel="prefetch" href="/assets/js/109.69841539.js"><link rel="prefetch" href="/assets/js/11.6ad8e275.js"><link rel="prefetch" href="/assets/js/12.ebe6955f.js"><link rel="prefetch" href="/assets/js/13.1475d5b5.js"><link rel="prefetch" href="/assets/js/14.5e479794.js"><link rel="prefetch" href="/assets/js/15.af2cf359.js"><link rel="prefetch" href="/assets/js/16.d4fff34f.js"><link rel="prefetch" href="/assets/js/17.74bff51a.js"><link rel="prefetch" href="/assets/js/18.ed91f954.js"><link rel="prefetch" href="/assets/js/19.86a7ba1d.js"><link rel="prefetch" href="/assets/js/2.1c1078ee.js"><link rel="prefetch" href="/assets/js/20.e2589558.js"><link rel="prefetch" href="/assets/js/21.ffafb8e8.js"><link rel="prefetch" href="/assets/js/22.4ec79f50.js"><link rel="prefetch" href="/assets/js/23.f3438343.js"><link rel="prefetch" href="/assets/js/24.1f20e112.js"><link rel="prefetch" href="/assets/js/25.deb44a9c.js"><link rel="prefetch" href="/assets/js/26.c9f40697.js"><link rel="prefetch" href="/assets/js/27.dcf399c7.js"><link rel="prefetch" href="/assets/js/28.38ef51e6.js"><link rel="prefetch" href="/assets/js/29.551b1b44.js"><link rel="prefetch" href="/assets/js/30.a47b6792.js"><link rel="prefetch" href="/assets/js/31.f63696b0.js"><link rel="prefetch" href="/assets/js/32.bcc4aee5.js"><link rel="prefetch" href="/assets/js/33.4a22ca1e.js"><link rel="prefetch" href="/assets/js/34.9899e948.js"><link rel="prefetch" href="/assets/js/35.997f7e42.js"><link rel="prefetch" href="/assets/js/36.e4c69bde.js"><link rel="prefetch" href="/assets/js/37.f3a61195.js"><link rel="prefetch" href="/assets/js/38.561e7ec7.js"><link rel="prefetch" href="/assets/js/39.42a3d758.js"><link rel="prefetch" href="/assets/js/40.79bdb1be.js"><link rel="prefetch" href="/assets/js/41.a2ff04d8.js"><link rel="prefetch" href="/assets/js/42.c1b3c6a9.js"><link rel="prefetch" href="/assets/js/43.c9a24c6c.js"><link rel="prefetch" href="/assets/js/44.7206d672.js"><link rel="prefetch" href="/assets/js/45.1360c981.js"><link rel="prefetch" href="/assets/js/46.c539d8e0.js"><link rel="prefetch" href="/assets/js/47.61dbc5ea.js"><link rel="prefetch" href="/assets/js/48.fcebbb03.js"><link rel="prefetch" href="/assets/js/49.e34f9c8f.js"><link rel="prefetch" href="/assets/js/5.15fd78d1.js"><link rel="prefetch" href="/assets/js/50.30d28c91.js"><link rel="prefetch" href="/assets/js/51.cdf19830.js"><link rel="prefetch" href="/assets/js/52.51898f96.js"><link rel="prefetch" href="/assets/js/53.32d091fd.js"><link rel="prefetch" href="/assets/js/54.6ee8055d.js"><link rel="prefetch" href="/assets/js/55.da2dff2c.js"><link rel="prefetch" href="/assets/js/56.1982c440.js"><link rel="prefetch" href="/assets/js/57.ba1bd3bb.js"><link rel="prefetch" href="/assets/js/58.f120f334.js"><link rel="prefetch" href="/assets/js/59.456a951d.js"><link rel="prefetch" href="/assets/js/60.d0e3420e.js"><link rel="prefetch" href="/assets/js/61.77d9ffe3.js"><link rel="prefetch" href="/assets/js/62.b3c372ca.js"><link rel="prefetch" href="/assets/js/63.57902a13.js"><link rel="prefetch" href="/assets/js/64.f7d005e6.js"><link rel="prefetch" href="/assets/js/65.99f7fc78.js"><link rel="prefetch" href="/assets/js/66.afbc059e.js"><link rel="prefetch" href="/assets/js/67.e982be0e.js"><link rel="prefetch" href="/assets/js/68.afc753b9.js"><link rel="prefetch" href="/assets/js/69.d3a6a8c6.js"><link rel="prefetch" href="/assets/js/7.5ba40ed1.js"><link rel="prefetch" href="/assets/js/70.086ffef1.js"><link rel="prefetch" href="/assets/js/71.011366f2.js"><link rel="prefetch" href="/assets/js/72.20bf0590.js"><link rel="prefetch" href="/assets/js/73.dd303726.js"><link rel="prefetch" href="/assets/js/74.6b587967.js"><link rel="prefetch" href="/assets/js/75.b4a04ac4.js"><link rel="prefetch" href="/assets/js/76.aab6e073.js"><link rel="prefetch" href="/assets/js/77.f1458c86.js"><link rel="prefetch" href="/assets/js/78.b750ec54.js"><link rel="prefetch" href="/assets/js/79.24372947.js"><link rel="prefetch" href="/assets/js/8.716769a4.js"><link rel="prefetch" href="/assets/js/80.1b3677d0.js"><link rel="prefetch" href="/assets/js/81.c4831305.js"><link rel="prefetch" href="/assets/js/82.1e2f9c34.js"><link rel="prefetch" href="/assets/js/83.54137483.js"><link rel="prefetch" href="/assets/js/84.1f275cdf.js"><link rel="prefetch" href="/assets/js/85.88f053cc.js"><link rel="prefetch" href="/assets/js/86.1cdb6099.js"><link rel="prefetch" href="/assets/js/87.3bea4fb1.js"><link rel="prefetch" href="/assets/js/88.56682a60.js"><link rel="prefetch" href="/assets/js/89.a9d245ee.js"><link rel="prefetch" href="/assets/js/9.12d6a935.js"><link rel="prefetch" href="/assets/js/90.00f0a818.js"><link rel="prefetch" href="/assets/js/91.b128d13e.js"><link rel="prefetch" href="/assets/js/92.6167b0f4.js"><link rel="prefetch" href="/assets/js/93.14c843f7.js"><link rel="prefetch" href="/assets/js/94.d28886fb.js"><link rel="prefetch" href="/assets/js/95.ab9365cd.js"><link rel="prefetch" href="/assets/js/96.813d6c38.js"><link rel="prefetch" href="/assets/js/97.0de2ab4d.js"><link rel="prefetch" href="/assets/js/98.9022dabc.js"><link rel="prefetch" href="/assets/js/99.e4920114.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.f184c8e3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.af604b7b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-0f44a727><div data-v-0f44a727><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-0f44a727 data-v-0f44a727><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-355e03f9 data-v-0f44a727 data-v-0f44a727><h3 class="title" data-v-355e03f9 data-v-355e03f9>今朝のブログ</h3> <p class="description" data-v-355e03f9 data-v-355e03f9></p> <label id="box" class="inputBox" data-v-355e03f9 data-v-355e03f9><input type="password" value="" data-v-355e03f9> <span data-v-355e03f9>Konck! Knock!</span> <button data-v-355e03f9>OK</button></label> <div class="footer" data-v-355e03f9 data-v-355e03f9><span data-v-355e03f9><i class="iconfont reco-theme" data-v-355e03f9></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-355e03f9>vuePress-theme-reco</a></span> <span data-v-355e03f9><i class="iconfont reco-copyright" data-v-355e03f9></i> <a data-v-355e03f9><span data-v-355e03f9>今朝</span>
            
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-0f44a727><header class="navbar" data-v-0f44a727><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/image/hero.jpg" alt="今朝のブログ" class="logo"> <span class="site-name">今朝のブログ</span></a> <div class="links"><!----> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/index.html" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><a href="/reading-note/index.html" class="nav-link"><i class="iconfont reco-document"></i>
  Reading Note
</a></div><div class="nav-item"><a href="/lang/index.html" class="nav-link"><i class="iconfont reco-message"></i>
  Language
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/categories/golang/" class="nav-link"><i class="iconfont reco-category"></i>
  Category
</a></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tags
</a></div><div class="nav-item"><a href="https://github.com/dreamjz" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-0f44a727></div> <aside class="sidebar" data-v-0f44a727><div class="personal-info-wrapper" data-v-5aaeb100 data-v-0f44a727><img src="/image/hero.jpg" alt="author-avatar" class="personal-img" data-v-5aaeb100> <h3 class="name" data-v-5aaeb100>
    今朝
  </h3> <div class="num" data-v-5aaeb100><div data-v-5aaeb100><h3 data-v-5aaeb100>82</h3> <h6 data-v-5aaeb100>文章</h6></div> <div data-v-5aaeb100><h3 data-v-5aaeb100>23</h3> <h6 data-v-5aaeb100>标签</h6></div></div> <ul class="social-links" data-v-5aaeb100></ul> <hr data-v-5aaeb100></div> <nav class="nav-links"><div class="nav-item"><a href="/zh/index.html" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><a href="/reading-note/index.html" class="nav-link"><i class="iconfont reco-document"></i>
  Reading Note
</a></div><div class="nav-item"><a href="/lang/index.html" class="nav-link"><i class="iconfont reco-message"></i>
  Language
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/categories/golang/" class="nav-link"><i class="iconfont reco-category"></i>
  Category
</a></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tags
</a></div><div class="nav-item"><a href="https://github.com/dreamjz" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <ul class="sidebar-links"><li><a href="/zh/" aria-current="page" class="sidebar-link">Welcome</a></li><li><a href="/zh/retaining_computer_science_knowledge.html" class="sidebar-link">Retaining Computer Science Knowledge</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Golang</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Leet Code</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>RPC</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nginx</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Raspberry Pi</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Front End</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-355e03f9 data-v-0f44a727><h3 class="title" data-v-355e03f9 data-v-355e03f9>Protocol Buffer Basics: Go</h3> <!----> <label id="box" class="inputBox" data-v-355e03f9 data-v-355e03f9><input type="password" value="" data-v-355e03f9> <span data-v-355e03f9>Konck! Knock!</span> <button data-v-355e03f9>OK</button></label> <div class="footer" data-v-355e03f9 data-v-355e03f9><span data-v-355e03f9><i class="iconfont reco-theme" data-v-355e03f9></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-355e03f9>vuePress-theme-reco</a></span> <span data-v-355e03f9><i class="iconfont reco-copyright" data-v-355e03f9></i> <a data-v-355e03f9><span data-v-355e03f9>今朝</span>
            
          <!---->
          2022
        </a></span></div></div> <div data-v-0f44a727><div id="particles-js" color="#dedede" particleOpacity="0.7" linesColor="#dedede" particlesNumber="80" shapeType="circle" particleSize="4" linesWidth="1" lineLinked="true" lineOpacity="0.4" linesDistance="150" moveSpeed="3" hoverEffect="true" hoverMode="grab" clickEffect="true" clickMode="push" class="bg-particles"></div> <main class="page"><section><div class="page-title"><h1 class="title">Protocol Buffer Basics: Go</h1> <div data-v-ff1aa866><i class="iconfont reco-account" data-v-ff1aa866><span data-v-ff1aa866>今朝</span></i> <i class="iconfont reco-date" data-v-ff1aa866><span data-v-ff1aa866>2021/12/22</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h1 id="protocol-buffer-basics-go"><a href="#protocol-buffer-basics-go" class="header-anchor">#</a> Protocol Buffer Basics: Go</h1> <p>This tutorial provides a basic Go programmer’s introduction to working with protocol buffers, using the <code>proto3</code> version of the protocol buffers language. By walking through creating a simple example application, it shows you how to</p> <ul><li>Define message formats in a <code>.proto</code> file</li> <li>Use the protocol buffer compiler</li> <li>Use the Go protocol buffer API to write and read message</li></ul> <h2 id="_1-why-use-protocol-buffers"><a href="#_1-why-use-protocol-buffers" class="header-anchor">#</a> 1. Why use protocol buffers</h2> <p>The example we are going to use is a very simple “address book” application that can read and write people’s contact details to and from a file. Each person in the address book has a name, an ID, an email address, and a contact phone number.</p> <p>How do you serialize and retrieve structured data like this? There are a few ways to solve this problem:</p> <ul><li>Use <code>gobs</code> to serialize the Go data structures. This is good solution in a Go-specific environment, but it doesn’t work well if you need to share data with applications written for other platforms</li> <li>You can invent an ad-hoc way to encode the data items into a single string - such as encoding 4 ints as “12:3:-23:67”. This is a simple and flexible approach, although it does require writing one-off encoding and parsing code, and the parsing impose a small run-time cost. This works best for encoding very simple data</li> <li>Serialize the data to XML. This approach can be very attractive since XML is (sort of) human readable and there are binding libraries for lots of languages. This can be a good choice if you wan to share data with other applications/projects. However, XML is notoriously space intensive, and encoding/decoding it can impose a huge performance penalty on applications. Also, navigating an XML DOM tree is considerably more complicated than navigating simple fields in a class normally would be</li></ul> <p>Protocol buffers are the flexible, efficient, automated solution to solve exactly this problem. With protocol buffers, you write a <code>.proto</code> description of the data structure you wish to store. From that, the protocol buffer compiler creates a class that implements automatic encoding and parsing of the protocol buffer data with an efficient binary format. The generated class provides getters and setters for the fields that make up a protocol buffer and takes care of the details of reading and writing the protocol buffer as a unit. Importantly, the protocol buffer format supports the idea of extending the format over time in such a way that the code still read data encoded with the old format.</p> <h2 id="_2-defining-your-protocol-format"><a href="#_2-defining-your-protocol-format" class="header-anchor">#</a> 2. Defining your protocol format</h2> <p>To create your address book application, you will need to start with a <code>.proto</code> file. The definitions in a <code>.proto</code> file are simple: you add a <em>message</em> for each data structure you want to serialize, the specify a name and a type for each field in the message. In our example, the <code>.proto</code> file that defines the message is <code>addressbook.proto</code>.</p> <p>The <code>.proto</code> file starts with a package declaration, which helps to prevent naming conflicts between different projects.</p> <div class="language-protobuf line-numbers-mode"><pre class="language-protobuf"><code><span class="token keyword">syntax</span> <span class="token operator">=</span> <span class="token string">&quot;proto3&quot;</span>
<span class="token keyword">package</span> tutorial

<span class="token keyword">import</span> <span class="token string">&quot;google/protobuf/timestamp.proto&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>The <code>go_package</code> option defines the import path of the package which will contain all the generated code for this file. The Go package name will be the last path component of the import path. For example, our example will use a package name of “tutorialpb”.</p> <div class="language-protobuf line-numbers-mode"><pre class="language-protobuf"><code><span class="token keyword">option</span> go_pacakge <span class="token operator">=</span> <span class="token string">&quot;protobuffers&quot;</span> <span class="token comment">// 这里将生成的 go 文件和 proto 文件放在同一目录下 </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Next, you have your message definitions. A message is just an aggregate containing a set of typed fields. Many standard simple data types are available as field types, including <code>bool</code>,<code>int32</code>, <code>double</code>, and <code>string</code>. You can also add further structure to your messages by using other message types as field types.</p> <div class="language-protobuf line-numbers-mode"><pre class="language-protobuf"><code><span class="token keyword">message</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token builtin">string</span> name <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token builtin">int32</span> id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// Unique ID number for this person</span>
  <span class="token builtin">string</span> email <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

  <span class="token keyword">enum</span> <span class="token class-name">PhoneType</span> <span class="token punctuation">{</span>
    MOBILE <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    HOME <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    WORK <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">message</span> <span class="token class-name">PhoneNumber</span> <span class="token punctuation">{</span>
    <span class="token builtin">string</span> number <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token positional-class-name class-name">PhoneType</span> type <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">repeated</span> <span class="token positional-class-name class-name">PhoneNumber</span> phones <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
  <span class="token positional-class-name class-name">google<span class="token punctuation">.</span>protobuf<span class="token punctuation">.</span>Timestamp</span> last_updated <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Our address book file is just one of these</span>
<span class="token keyword">message</span> <span class="token class-name">AddressBook</span> <span class="token punctuation">{</span>
  <span class="token keyword">repeated</span> <span class="token positional-class-name class-name">Person</span> people <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>In the above example, the <code>Person</code> message contains <code>PhoneNumber</code> messages, while the <code>AddressBook</code> message contains <code>Person</code> messages. You can even define message types nested inside other messages - as you can see, the <code>PhoneNumber</code> type is defined inside <code>Person</code>. You can also define <code>enum</code> types if you want one of your fields to have one of a predefined list of values - here you want to specify that a phone number can be one of <code>MOBILE</code>, <code>HOME</code>, or <code>WORK</code>.</p> <p>The “=1”, “=2” markers on each element identify the unique “tag” that field uses in the binary encoding. Tag numbers 1-15 require one less byte to encode than higher numbers, so as an optimization you can decide to use those tags for the commonly used or repeated elements, leaving tags 16 and higher for less-commonly used optional elements. Each element in a repeated field requires re-encoding the tag number, so repeated fields are particularly good candidates for the optimization.</p> <p>If a field value is not set, a default value is used: zero for numeric types, the empty string for strings, false for bools. For embedded messages, the default value is always the “default instance” or “prototype” of the message, which has none of its fields set. Calling the accessor to get the value of a field which has not been explicitly set always returns that field’s default value.</p> <p>If a field is <code>repeated</code>, the field may be repeated any number of times (including zero). The order of the repeated values will be preserved in the protocol buffer. Think of repeated fields as dynamically sized arrays.</p> <p>Do not go looking for facilities similar to class inheritance, though - protocol buffers don’t do that.</p> <h2 id="_3-compiling-your-protocol-buffers"><a href="#_3-compiling-your-protocol-buffers" class="header-anchor">#</a> 3. Compiling your protocol buffers</h2> <p>Now that you have a <code>.proto</code>, the next thing you need to do is generate the classes you will need to read and write <code>AddressBook</code> (and hence <code>Person</code> and <code>PhoneNumber</code>) messages. To do this, you need to run the protocol buffer compiler <code>protoc</code> on your <code>.proto</code>:</p> <ol><li><p>If you haven’t installed the compiler, <a href="https://developers.google.com/protocol-buffers/docs/downloads" target="_blank" rel="noopener noreferrer">download the package<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and follow the instructions in the README.</p></li> <li><p>Run the following command to install the Go protocol buffers plugin:</p></li></ol> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>go <span class="token function">install</span> google.golang.org/protobuf/cmd/protoc-gen-go@latest
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>The compiler plugin <code>protoc-gen-go</code> will be installed in <code>$GIBIN</code>, defaulting to <code>$GOPATH/bin</code>. It must be in your <code>$PATH</code> for the protocol compiler <code>protoc</code> to find it.</p> <ol start="3"><li><p>Now run the compiler, specifying the source directory (where your application’s source code lives - the current directory is used if you don’t provide a value), the destination directory (where you want the generated code to go; often the same as <code>$SRC_DIR</code>), and the path to you <code>.proto</code>. In this case, you would invoke:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>protoc -I<span class="token operator">=</span><span class="token variable">$SRC_DIR</span> --go_out<span class="token operator">=</span><span class="token variable">$DST_DIR</span> <span class="token variable">$SRC_DIR</span>/addressbook.proto
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Because you want Go code, you use the <code>--go_out</code> option - similar options are provided for other supported languages.</p></li></ol> <p>生成 code 之后需要安装 <code>google.golang.org/protobuf/proto</code> 依赖</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>go get -u google.golang.org/protobuf/proto
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_4-the-protocol-buffer-api"><a href="#_4-the-protocol-buffer-api" class="header-anchor">#</a> 4. The Protocol Buffer API</h2> <p>Generating <code>addressbook.pb.go</code> gives you the following useful types:</p> <ul><li>An <code>AddressBook</code> structure with a <code>People</code> field</li> <li>A <code>Person</code> structure with fields for <code>Name</code>, <code>Id</code>, <code>Email</code>, and <code>Phones</code></li> <li>A <code>Person_PhoneNumber</code> structure, with fields for <code>Number</code> and <code>Type</code></li> <li>The type <code>Person_PhoneType</code> and a value defined for each value in the <code>Person.PhoneType</code> enum</li></ul> <p>Here’s an example from the <code>list_people</code> command’s unit tests of how you might create an instance of Person:</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>p <span class="token operator">:=</span> pb<span class="token punctuation">.</span>Person<span class="token punctuation">{</span>
        Id<span class="token punctuation">:</span>    <span class="token number">1234</span><span class="token punctuation">,</span>
        Name<span class="token punctuation">:</span>  <span class="token string">&quot;John Doe&quot;</span><span class="token punctuation">,</span>
        Email<span class="token punctuation">:</span> <span class="token string">&quot;jdoe@example.com&quot;</span><span class="token punctuation">,</span>
        Phones<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>pb<span class="token punctuation">.</span>Person_PhoneNumber<span class="token punctuation">{</span>
                <span class="token punctuation">{</span>Number<span class="token punctuation">:</span> <span class="token string">&quot;555-4321&quot;</span><span class="token punctuation">,</span> Type<span class="token punctuation">:</span> pb<span class="token punctuation">.</span>Person_HOME<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="_5-writing-a-message"><a href="#_5-writing-a-message" class="header-anchor">#</a> 5. Writing a Message</h2> <p>The whole purpose of using protocol buffers is to serialize your data so that it can be parsed elsewhere. In Go, you use the <code>proto</code> library’s Marshal function to serialize your protocol buffer data. A pointer to a protocol buffer message’s <code>struct</code> implements the <code>proto.Message</code> interface. Calling <code>proto.Marshal</code> returns the protocol buffer, encoded in its wire format. For example, we use this function in the <code>add_person</code> command:</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>book <span class="token operator">:=</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>AddressBook<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment">// ...</span>

<span class="token comment">// Write the new address book back to disk.</span>
out<span class="token punctuation">,</span> err <span class="token operator">:=</span> proto<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to encode address book:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> out<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to write address book:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="_6-reading-a-message"><a href="#_6-reading-a-message" class="header-anchor">#</a> 6. Reading a Message</h2> <p>To parse an encoded message, you use the <code>proto</code> library’s Unmarshal function. Calling this parses the data in <code>in</code> as a protocol buffer and places the result in <code>book</code>. So to parse the file in the <code>list_people</code> command, we use :</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Read the existing address book.</span>
in<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>fname<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span><span class="token string">&quot;Error reading file:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
book <span class="token operator">:=</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>AddressBook<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">if</span> err <span class="token operator">:=</span> proto<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> book<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to parse address book:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="_7-extending-a-protocol-buffer"><a href="#_7-extending-a-protocol-buffer" class="header-anchor">#</a> 7. Extending a Protocol Buffer</h2> <p>Sooner or later after you release the code that uses your protocol buffer, you will undoubtedly want to “improve” the protocol buffer’s definition. If you want your new buffers to be backwards-compatible, and your old buffers to be forward-compatible - and you almost certainly do want this - then there are some rules you need to follow. In the new version of the protocol buffer:</p> <ul><li>you <em>must</em> do not change the tag numbers of any existing fields</li> <li>you <em>may</em> delete fields</li> <li>you <em>may</em> add new fields but you must use fresh tag numbers (i.e. tag numbers that were never used in this protocol buffer, not even by deleted fields)</li></ul> <p>(There are <a href="https://developers.google.com/protocol-buffers/docs/proto3#updating" target="_blank" rel="noopener noreferrer">some exceptions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to these rules, but they are rarely used.)</p> <p>If you follow these rules, old code will happily read new messages and simply ignore any new fields. To the old code, singular fields that were deleted will simply have their default value, and deleted repeated fields will be empty. New code will also transparently read old messages.</p> <p>However, keep in mind that new fields will not be present in old messages, so you will need to do something reasonable with the default value. A type-specific default value is used: for strings, the default value is empty string. For booleans, the default value is false. For numeric types, the default value is zero.</p> <h3 id="reference"><a href="#reference" class="header-anchor">#</a> Reference</h3> <ol><li><a href="https://developers.google.com/protocol-buffers/docs/gotutorial" target="_blank" rel="noopener noreferrer">Basics: Go<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> protocol buffer tutorial</li></ol></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2021/12/28 22:06:27</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/zh/rpc/protocol-buffers/preface.html" class="prev">
            Preface
          </a></span> <span class="next"><a href="/zh/rpc/protocol-buffers/language-guide-proto3.html">
            Language Guide proto3
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-898d6c54><li class="level-2" data-v-898d6c54><a href="/zh/rpc/protocol-buffers/basics-go.html#_1-why-use-protocol-buffers" class="sidebar-link reco-side-_1-why-use-protocol-buffers" data-v-898d6c54>1. Why use protocol buffers</a></li><li class="level-2" data-v-898d6c54><a href="/zh/rpc/protocol-buffers/basics-go.html#_2-defining-your-protocol-format" class="sidebar-link reco-side-_2-defining-your-protocol-format" data-v-898d6c54>2. Defining your protocol format</a></li><li class="level-2" data-v-898d6c54><a href="/zh/rpc/protocol-buffers/basics-go.html#_3-compiling-your-protocol-buffers" class="sidebar-link reco-side-_3-compiling-your-protocol-buffers" data-v-898d6c54>3. Compiling your protocol buffers</a></li><li class="level-2" data-v-898d6c54><a href="/zh/rpc/protocol-buffers/basics-go.html#_4-the-protocol-buffer-api" class="sidebar-link reco-side-_4-the-protocol-buffer-api" data-v-898d6c54>4. The Protocol Buffer API</a></li><li class="level-2" data-v-898d6c54><a href="/zh/rpc/protocol-buffers/basics-go.html#_5-writing-a-message" class="sidebar-link reco-side-_5-writing-a-message" data-v-898d6c54>5. Writing a Message</a></li><li class="level-2" data-v-898d6c54><a href="/zh/rpc/protocol-buffers/basics-go.html#_6-reading-a-message" class="sidebar-link reco-side-_6-reading-a-message" data-v-898d6c54>6. Reading a Message</a></li><li class="level-2" data-v-898d6c54><a href="/zh/rpc/protocol-buffers/basics-go.html#_7-extending-a-protocol-buffer" class="sidebar-link reco-side-_7-extending-a-protocol-buffer" data-v-898d6c54>7. Extending a Protocol Buffer</a></li><li class="level-3" data-v-898d6c54><a href="/zh/rpc/protocol-buffers/basics-go.html#reference" class="sidebar-link reco-side-reference" data-v-898d6c54>Reference</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><canvas id="vuepress-canvas-cursor"></canvas><div></div><div id="goTop" class="hide-cat" data-v-bf92849a></div></div></div>
    <script src="/assets/js/app.35ae0727.js" defer></script><script src="/assets/js/6.af237152.js" defer></script><script src="/assets/js/1.44a00389.js" defer></script><script src="/assets/js/105.cf4e4bdc.js" defer></script>
  </body>
</html>
