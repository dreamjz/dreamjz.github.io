<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Get Started | 今朝のブログ</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
    <link rel="shortcut icon" herf="favicon.ico">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-3RQ3LRSTKM"></script>
    <script>window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());
		  
			gtag('config', 'G-3RQ3LRSTKM');</script>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="google-site-verification" content="lHBWOiWCnBWvc1h4REqjllalv9ZpQbXbHDdM8chFuuw">
    
    <link rel="preload" href="/assets/css/0.styles.af604b7b.css" as="style"><link rel="preload" href="/assets/js/app.b1f6eb89.js" as="script"><link rel="preload" href="/assets/js/5.c521e6dd.js" as="script"><link rel="preload" href="/assets/js/1.d89c676b.js" as="script"><link rel="preload" href="/assets/js/17.ac8637ed.js" as="script"><link rel="prefetch" href="/assets/js/10.6cb8f95a.js"><link rel="prefetch" href="/assets/js/11.a82182c9.js"><link rel="prefetch" href="/assets/js/12.d43ad85b.js"><link rel="prefetch" href="/assets/js/13.5eb44535.js"><link rel="prefetch" href="/assets/js/14.21408dcb.js"><link rel="prefetch" href="/assets/js/15.65f5deb3.js"><link rel="prefetch" href="/assets/js/16.3160c4da.js"><link rel="prefetch" href="/assets/js/18.25b9978a.js"><link rel="prefetch" href="/assets/js/19.e45d98c6.js"><link rel="prefetch" href="/assets/js/2.b24054a6.js"><link rel="prefetch" href="/assets/js/20.c817ae1f.js"><link rel="prefetch" href="/assets/js/21.b46442b9.js"><link rel="prefetch" href="/assets/js/22.f1a6b8a3.js"><link rel="prefetch" href="/assets/js/23.651bdf5a.js"><link rel="prefetch" href="/assets/js/24.72808bb2.js"><link rel="prefetch" href="/assets/js/25.31111437.js"><link rel="prefetch" href="/assets/js/26.f4329b4b.js"><link rel="prefetch" href="/assets/js/27.c43e75aa.js"><link rel="prefetch" href="/assets/js/28.0d47ff0c.js"><link rel="prefetch" href="/assets/js/29.53fb9053.js"><link rel="prefetch" href="/assets/js/30.8cefde2a.js"><link rel="prefetch" href="/assets/js/31.7c5835e5.js"><link rel="prefetch" href="/assets/js/32.c47868e5.js"><link rel="prefetch" href="/assets/js/33.2441a92d.js"><link rel="prefetch" href="/assets/js/34.20440e94.js"><link rel="prefetch" href="/assets/js/35.92316ebe.js"><link rel="prefetch" href="/assets/js/36.786c9f05.js"><link rel="prefetch" href="/assets/js/37.54257658.js"><link rel="prefetch" href="/assets/js/38.b2e0d5ee.js"><link rel="prefetch" href="/assets/js/39.76d23c94.js"><link rel="prefetch" href="/assets/js/40.898c4255.js"><link rel="prefetch" href="/assets/js/41.48a9a52f.js"><link rel="prefetch" href="/assets/js/42.1c85921e.js"><link rel="prefetch" href="/assets/js/43.d506ce94.js"><link rel="prefetch" href="/assets/js/44.97824ee6.js"><link rel="prefetch" href="/assets/js/45.92bde139.js"><link rel="prefetch" href="/assets/js/46.9142c38d.js"><link rel="prefetch" href="/assets/js/47.37787e52.js"><link rel="prefetch" href="/assets/js/48.d6fbe703.js"><link rel="prefetch" href="/assets/js/49.02119e82.js"><link rel="prefetch" href="/assets/js/50.92c17d9f.js"><link rel="prefetch" href="/assets/js/51.dfad0fe3.js"><link rel="prefetch" href="/assets/js/52.de11c437.js"><link rel="prefetch" href="/assets/js/53.2b22f8c2.js"><link rel="prefetch" href="/assets/js/54.d2f48938.js"><link rel="prefetch" href="/assets/js/55.bf0d57ee.js"><link rel="prefetch" href="/assets/js/56.b7092272.js"><link rel="prefetch" href="/assets/js/57.2ba65b9b.js"><link rel="prefetch" href="/assets/js/58.b78643a1.js"><link rel="prefetch" href="/assets/js/59.ae9f5910.js"><link rel="prefetch" href="/assets/js/6.2bdebdf1.js"><link rel="prefetch" href="/assets/js/60.d887dbcc.js"><link rel="prefetch" href="/assets/js/61.799c3fa2.js"><link rel="prefetch" href="/assets/js/62.668f7a57.js"><link rel="prefetch" href="/assets/js/63.1c51b3fd.js"><link rel="prefetch" href="/assets/js/64.f97d33b2.js"><link rel="prefetch" href="/assets/js/65.2a3dd666.js"><link rel="prefetch" href="/assets/js/66.6af4d2a0.js"><link rel="prefetch" href="/assets/js/67.58903c99.js"><link rel="prefetch" href="/assets/js/68.b6d01308.js"><link rel="prefetch" href="/assets/js/69.1eb6b7a1.js"><link rel="prefetch" href="/assets/js/7.21f58fa7.js"><link rel="prefetch" href="/assets/js/70.bd5b1335.js"><link rel="prefetch" href="/assets/js/71.fdcb7cec.js"><link rel="prefetch" href="/assets/js/72.8fa6dacb.js"><link rel="prefetch" href="/assets/js/73.2a61f85b.js"><link rel="prefetch" href="/assets/js/74.ea4f9a29.js"><link rel="prefetch" href="/assets/js/75.d8860842.js"><link rel="prefetch" href="/assets/js/76.9a178497.js"><link rel="prefetch" href="/assets/js/77.f0cbeb6e.js"><link rel="prefetch" href="/assets/js/8.be38ed44.js"><link rel="prefetch" href="/assets/js/9.d2146688.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.bee36f07.js">
    <link rel="stylesheet" href="/assets/css/0.styles.af604b7b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-0f44a727><div data-v-0f44a727><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-0f44a727 data-v-0f44a727><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-355e03f9 data-v-0f44a727 data-v-0f44a727><h3 class="title" data-v-355e03f9 data-v-355e03f9>今朝のブログ</h3> <p class="description" data-v-355e03f9 data-v-355e03f9></p> <label id="box" class="inputBox" data-v-355e03f9 data-v-355e03f9><input type="password" value="" data-v-355e03f9> <span data-v-355e03f9>Konck! Knock!</span> <button data-v-355e03f9>OK</button></label> <div class="footer" data-v-355e03f9 data-v-355e03f9><span data-v-355e03f9><i class="iconfont reco-theme" data-v-355e03f9></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-355e03f9>vuePress-theme-reco</a></span> <span data-v-355e03f9><i class="iconfont reco-copyright" data-v-355e03f9></i> <a data-v-355e03f9><span data-v-355e03f9>今朝</span>
            
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-0f44a727><header class="navbar" data-v-0f44a727><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/image/hero.jpg" alt="今朝のブログ" class="logo"> <span class="site-name">今朝のブログ</span></a> <div class="links"><!----> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/index.html" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><a href="/reading-note/index.html" class="nav-link"><i class="iconfont reco-document"></i>
  Reading Note
</a></div><div class="nav-item"><a href="/lang/index.html" class="nav-link"><i class="iconfont reco-message"></i>
  Language
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/categories/golang/" class="nav-link"><i class="iconfont reco-category"></i>
  Category
</a></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tags
</a></div><div class="nav-item"><a href="https://github.com/dreamjz" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-0f44a727></div> <aside class="sidebar" data-v-0f44a727><div class="personal-info-wrapper" data-v-5aaeb100 data-v-0f44a727><img src="/image/hero.jpg" alt="author-avatar" class="personal-img" data-v-5aaeb100> <h3 class="name" data-v-5aaeb100>
    今朝
  </h3> <div class="num" data-v-5aaeb100><div data-v-5aaeb100><h3 data-v-5aaeb100>52</h3> <h6 data-v-5aaeb100>文章</h6></div> <div data-v-5aaeb100><h3 data-v-5aaeb100>16</h3> <h6 data-v-5aaeb100>标签</h6></div></div> <ul class="social-links" data-v-5aaeb100></ul> <hr data-v-5aaeb100></div> <nav class="nav-links"><div class="nav-item"><a href="/zh/index.html" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><a href="/reading-note/index.html" class="nav-link"><i class="iconfont reco-document"></i>
  Reading Note
</a></div><div class="nav-item"><a href="/lang/index.html" class="nav-link"><i class="iconfont reco-message"></i>
  Language
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/categories/golang/" class="nav-link"><i class="iconfont reco-category"></i>
  Category
</a></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tags
</a></div><div class="nav-item"><a href="https://github.com/dreamjz" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <ul class="sidebar-links"><li><a href="/zh/" aria-current="page" class="sidebar-link">Welcome</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Golang</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>RPC</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nginx</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Raspberry Pi</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Front End</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-355e03f9 data-v-0f44a727><h3 class="title" data-v-355e03f9 data-v-355e03f9>Get Started</h3> <!----> <label id="box" class="inputBox" data-v-355e03f9 data-v-355e03f9><input type="password" value="" data-v-355e03f9> <span data-v-355e03f9>Konck! Knock!</span> <button data-v-355e03f9>OK</button></label> <div class="footer" data-v-355e03f9 data-v-355e03f9><span data-v-355e03f9><i class="iconfont reco-theme" data-v-355e03f9></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-355e03f9>vuePress-theme-reco</a></span> <span data-v-355e03f9><i class="iconfont reco-copyright" data-v-355e03f9></i> <a data-v-355e03f9><span data-v-355e03f9>今朝</span>
            
          <!---->
          2022
        </a></span></div></div> <div data-v-0f44a727><div id="particles-js" color="#dedede" particleOpacity="0.7" linesColor="#dedede" particlesNumber="80" shapeType="circle" particleSize="4" linesWidth="1" lineLinked="true" lineOpacity="0.4" linesDistance="150" moveSpeed="3" hoverEffect="true" hoverMode="grab" clickEffect="true" clickMode="push" class="bg-particles"></div> <main class="page"><section><div class="page-title"><h1 class="title">Get Started</h1> <div data-v-ff1aa866><i class="iconfont reco-account" data-v-ff1aa866><span data-v-ff1aa866>今朝</span></i> <i class="iconfont reco-date" data-v-ff1aa866><span data-v-ff1aa866>2021/12/15</span></i> <!----> <i class="tags iconfont reco-tag" data-v-ff1aa866><span class="tag-item" data-v-ff1aa866>docker compose</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="get-started"><a href="#get-started" class="header-anchor">#</a> Get Started</h1> <p>本节代码参见<a href="">compose-test</a></p> <h2 id="_1-prerequisites"><a href="#_1-prerequisites" class="header-anchor">#</a> 1. Prerequisites</h2> <p>首先安装 <code>Docker Compose</code> ,</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ pacman -S docker-compose
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_2-setup"><a href="#_2-setup" class="header-anchor">#</a> 2. Setup</h2> <p>Define the application dependencies</p> <ol><li><p>Create a directory for the proejct:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">import</span> <span class="token function">time</span>

<span class="token function">import</span> redis
from flask <span class="token function">import</span> Flask

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
cache <span class="token operator">=</span> redis.Redis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'redis'</span>, <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">)</span>

def get_hit_count<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    retries <span class="token operator">=</span> <span class="token number">5</span>
    <span class="token keyword">while</span> True:
        try:
            <span class="token builtin class-name">return</span> cache.incr<span class="token punctuation">(</span><span class="token string">'hits'</span><span class="token punctuation">)</span>
        except redis.exceptions.ConnectionError as exc:
            <span class="token keyword">if</span> retries <span class="token operator">==</span> <span class="token number">0</span>:
                raise exc
            retries -<span class="token operator">=</span> <span class="token number">1</span>
            time.sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>

@app.route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
def hello<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    count <span class="token operator">=</span> get_hit_count<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token builtin class-name">return</span> <span class="token string">'Hello World! I have been seen {} times.\n'</span>.format<span class="token punctuation">(</span>count<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div></li> <li><p>Create a file <code>app.py</code> :</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> time

<span class="token keyword">import</span> redis
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
cache <span class="token operator">=</span> redis<span class="token punctuation">.</span>Redis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'redis'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">get_hit_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    retries <span class="token operator">=</span> <span class="token number">5</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> cache<span class="token punctuation">.</span>incr<span class="token punctuation">(</span><span class="token string">'hits'</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> redis<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>ConnectionError <span class="token keyword">as</span> exc<span class="token punctuation">:</span>
            <span class="token keyword">if</span> retries <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> exc
            retries <span class="token operator">-=</span> <span class="token number">1</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    count <span class="token operator">=</span> get_hit_count<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'Hello World! I have been seen {} times.\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>In this example, <code>redis</code> is the hostname of the redis container on the application’s network. We use the default port for Redis, <code>6379</code>.</p> <blockquote><h3 id="handling-transient-errors"><a href="#handling-transient-errors" class="header-anchor">#</a> Handling transient errors</h3> <p>Note the way the <code>get_hit_count</code> function is written. This basic retry loop lets us attempt our request multiple times if the redis service is not available. This is useful at startup while the application comes online, but also makes our application more resilient if the Redis service needs to be restarted anytime during the app’s lifetime. In a cluster, this also helps handling momentary connection drops between nodes.</p></blockquote></li> <li><p>Create file <code>requirements.txt</code> :</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>flask
redis
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ol> <h2 id="_3-create-a-dockerfile"><a href="#_3-create-a-dockerfile" class="header-anchor">#</a> 3. Create a Dockerfile</h2> <p>Write a Dockerfile that builds a Docker image. The imge contains all the dependencies the Python application requires, including Python iteself.</p> <p>In project directory, create a file <code>Dockerfile</code>:</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> python:3.7-alpine</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /code</span>
<span class="token instruction"><span class="token keyword">ENV</span> FLASK_APP=app.py</span>
<span class="token instruction"><span class="token keyword">ENV</span> FLASK_RUN_HOST=0.0.0.0</span>
<span class="token instruction"><span class="token keyword">RUN</span> apk add --no-cache gcc musl-dev linux-headers</span>
<span class="token instruction"><span class="token keyword">COPY</span> requirements.txt requirements.txt</span>
<span class="token instruction"><span class="token keyword">RUN</span> pip install -r requirements.txt</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 5000</span>
<span class="token instruction"><span class="token keyword">COPY</span> . .</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;flask&quot;</span>, <span class="token string">&quot;run&quot;</span>]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>This tells Docker to:</p> <ul><li>Build an image starting with Python 3.7 image</li> <li>Set the working directory to <code>/code</code> (会自动创建)</li> <li>Set environment variables used by the <code>flask</code> command</li> <li>Install gcc and other dependencies</li> <li>Copy <code>requirements.txt</code> and install the Python dependencies</li> <li>Add metadata to the image to describe that the container is listening on port 5000</li> <li>Copy the current directory <code>.</code> in the project to the workdir <code>.</code> in the image</li> <li>Set the default command for the container to <code>flask run</code></li></ul> <h2 id="_4-define-services-in-a-compose-file"><a href="#_4-define-services-in-a-compose-file" class="header-anchor">#</a> 4. Define services in a Compose file</h2> <p>Create a file <code>docker-compose.yml</code></p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.9&quot;</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">web</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span> .
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;5000:5000&quot;</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">&quot;redis:alpine&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>This Compose file defines two services: <code>web</code> and <code>redis</code></p> <h3 id="_4-1-web-service"><a href="#_4-1-web-service" class="header-anchor">#</a> 4.1 Web service</h3> <p>The <code>web</code> service uses an image that’s build from the <code>Dockerfile</code> in the current directory. It then binds the container and the host machine to the exposed port 5000 (the default port for the flask web server)</p> <h3 id="_4-2-redis-service"><a href="#_4-2-redis-service" class="header-anchor">#</a> 4.2 Redis service</h3> <p>The <code>redis</code> service uses a public Redis imges <code>redis:alpine</code></p> <h2 id="_5-build-and-run-your-app-with-compose"><a href="#_5-build-and-run-your-app-with-compose" class="header-anchor">#</a> 5. Build and run your app with Compose</h2> <ol><li><p>From the project directory, start up app by running <code>docker compose up</code></p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ docker compose up 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Compose pull a Redis iamge, builds an image for you code, and starts the services you defined. In this case, the code is statically copied into the image at build time</p></li> <li><p>Use curl to test</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ <span class="token function">curl</span> http://localhost:5000/
Hello World<span class="token operator">!</span> I have been seen <span class="token number">3</span> times.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>Switch to another terminal window, and type <code>docker image ls</code></p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ docker image <span class="token function">ls</span>
REPOSITORY                       TAG          IMAGE ID       CREATED             SIZE
docker-compose-get-started_web   latest       da30493291c0   About an hour ago   183MB
python                           <span class="token number">3.7</span>-alpine   a1034fd13493   <span class="token number">2</span> weeks ago         <span class="token number">41</span>.8MB
redis                            alpine       3900abf41552   <span class="token number">2</span> weeks ago         <span class="token number">32</span>.4MB
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>Stop the application, either by running <code>docker-compose down</code> from within your project directory in the second terminal, or by hitting CTRL+C in the original terminal where you started the app</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ docker compose down
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Running <span class="token number">3</span>/3
 ⠿ Container docker-compose-get-started-web-1    Removed                     <span class="token number">10</span>.3s
 ⠿ Container docker-compose-get-started-redis-1  Removed                      <span class="token number">0</span>.2s
 ⠿ Network docker-compose-get-started_default    Removed                      <span class="token number">0</span>.1s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ol> <p>可以看到使用 <code>docker compose down</code> 之后会将 <code>container</code> 和 <code>network</code> 删除，若使用 CTRL+C 只会删除容器而网络将不会被删除</p> <h2 id="_6-edit-the-compose-file-to-add-a-bind-mount"><a href="#_6-edit-the-compose-file-to-add-a-bind-mount" class="header-anchor">#</a> 6. Edit the Compose file to add a bind mount</h2> <p>Edit <code>docker-compose.yml</code> ito add a bind mount for the <code>web</code> service:</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.9&quot;</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">web</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span> .
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;5000:5000&quot;</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> .<span class="token punctuation">:</span>/code
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">FLASK_ENV</span><span class="token punctuation">:</span> development
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">&quot;redis:alpine&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>The <code>volumes</code> key mounts the project directory on the host to <code>/code</code> inside the container, allowing you to modify the code on the fly, without having to rebuild the image. The <code>environment</code> key sets the <code>FLASK_NEW</code> environment variable, which tells <code>flask run</code> to run in development mode and reload the code on change. This mode should only be used in development</p> <h2 id="_7-re-build-and-run-the-app-with-compose"><a href="#_7-re-build-and-run-the-app-with-compose" class="header-anchor">#</a> 7. Re-build and run the app with Compose</h2> <p>From project directory, run <code>docker compose up</code></p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ docker compose up
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_8-update-the-application"><a href="#_8-update-the-application" class="header-anchor">#</a> 8. Update the application</h2> <p>Because the application code is now mounted into the container using a volume, you can make changes to its code and see the changes instantly, without having to rebuild the image.</p> <p>Change the greeting in <code>app.py</code> and save it. For example, change the <code>Hello World!</code> message to <code>Hello from Docker!</code>:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">return</span> <span class="token string">'Hello from Docker! I have been seen {} times.\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ <span class="token function">curl</span> <span class="token string">'http://localhost:5000'</span>
Hello from Docker<span class="token operator">!</span> I have been seen <span class="token number">1</span> times.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="_9-experiment-with-some-other-commands"><a href="#_9-experiment-with-some-other-commands" class="header-anchor">#</a> 9. Experiment with some other commands</h2> <p>You can pass the <code>-d</code> flag (<code>detached</code> mode ) to <code>docker compose up</code> and use <code>docker compose ps</code> to see what is currently running:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ docker compose up -d 
<span class="token comment"># ...</span>
$ docker compose <span class="token function">ps</span>
NAME                                 COMMAND                  SERVICE             STATUS              PORTS
docker-compose-get-started-redis-1   <span class="token string">&quot;docker-entrypoint.s…&quot;</span>   redis               running             <span class="token number">6379</span>/tcp
docker-compose-get-started-web-1     <span class="token string">&quot;flask run&quot;</span>              web                 running             <span class="token number">0.0</span>.0.0:5000-<span class="token operator">&gt;</span><span class="token number">5000</span>/tcp, :::5000-<span class="token operator">&gt;</span><span class="token number">5000</span>/tcp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>The <code>docker compose run</code> command allows you to run one-off commands for your services. For example, to see what environment variables are available to the <code>web</code> service</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ docker compose run web <span class="token function">env</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>If you started Compose with <code>docker compose up -d</code>, stop your services once you’ve finished with them</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ docker compose stop
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>You can bring everything down, removing the containers entirely, with the <code>down</code> command. Pass <code>--volumes</code> to also remove the data volume used by the Redis container</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ docker compose down --volumes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="reference"><a href="#reference" class="header-anchor">#</a> Reference</h2> <ol><li><a href="https://docs.docker.com/compose/gettingstarted/" target="_blank" rel="noopener noreferrer">Get started with Docker Compose<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2021/12/18 13:10:02</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/zh/docker/docker-compose/01.1.html" class="prev">
            Overview
          </a></span> <span class="next"><a href="/zh/docker/docker-compose/01.3.html">
            Environment variables in Compose
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-898d6c54><li class="level-2" data-v-898d6c54><a href="/zh/docker/docker-compose/01.2.html#_1-prerequisites" class="sidebar-link reco-side-_1-prerequisites" data-v-898d6c54>1. Prerequisites</a></li><li class="level-2" data-v-898d6c54><a href="/zh/docker/docker-compose/01.2.html#_2-setup" class="sidebar-link reco-side-_2-setup" data-v-898d6c54>2. Setup</a></li><li class="level-3" data-v-898d6c54><a href="/zh/docker/docker-compose/01.2.html#handling-transient-errors" class="sidebar-link reco-side-handling-transient-errors" data-v-898d6c54>Handling transient errors</a></li><li class="level-2" data-v-898d6c54><a href="/zh/docker/docker-compose/01.2.html#_3-create-a-dockerfile" class="sidebar-link reco-side-_3-create-a-dockerfile" data-v-898d6c54>3. Create a Dockerfile</a></li><li class="level-2" data-v-898d6c54><a href="/zh/docker/docker-compose/01.2.html#_4-define-services-in-a-compose-file" class="sidebar-link reco-side-_4-define-services-in-a-compose-file" data-v-898d6c54>4. Define services in a Compose file</a></li><li class="level-3" data-v-898d6c54><a href="/zh/docker/docker-compose/01.2.html#_4-1-web-service" class="sidebar-link reco-side-_4-1-web-service" data-v-898d6c54>4.1 Web service</a></li><li class="level-3" data-v-898d6c54><a href="/zh/docker/docker-compose/01.2.html#_4-2-redis-service" class="sidebar-link reco-side-_4-2-redis-service" data-v-898d6c54>4.2 Redis service</a></li><li class="level-2" data-v-898d6c54><a href="/zh/docker/docker-compose/01.2.html#_5-build-and-run-your-app-with-compose" class="sidebar-link reco-side-_5-build-and-run-your-app-with-compose" data-v-898d6c54>5. Build and run your app with Compose</a></li><li class="level-2" data-v-898d6c54><a href="/zh/docker/docker-compose/01.2.html#_6-edit-the-compose-file-to-add-a-bind-mount" class="sidebar-link reco-side-_6-edit-the-compose-file-to-add-a-bind-mount" data-v-898d6c54>6. Edit the Compose file to add a bind mount</a></li><li class="level-2" data-v-898d6c54><a href="/zh/docker/docker-compose/01.2.html#_7-re-build-and-run-the-app-with-compose" class="sidebar-link reco-side-_7-re-build-and-run-the-app-with-compose" data-v-898d6c54>7. Re-build and run the app with Compose</a></li><li class="level-2" data-v-898d6c54><a href="/zh/docker/docker-compose/01.2.html#_8-update-the-application" class="sidebar-link reco-side-_8-update-the-application" data-v-898d6c54>8. Update the application</a></li><li class="level-2" data-v-898d6c54><a href="/zh/docker/docker-compose/01.2.html#_9-experiment-with-some-other-commands" class="sidebar-link reco-side-_9-experiment-with-some-other-commands" data-v-898d6c54>9. Experiment with some other commands</a></li><li class="level-2" data-v-898d6c54><a href="/zh/docker/docker-compose/01.2.html#reference" class="sidebar-link reco-side-reference" data-v-898d6c54>Reference</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><canvas id="vuepress-canvas-cursor"></canvas><div></div><div id="goTop" class="hide-cat" data-v-bf92849a></div></div></div>
    <script src="/assets/js/app.b1f6eb89.js" defer></script><script src="/assets/js/5.c521e6dd.js" defer></script><script src="/assets/js/1.d89c676b.js" defer></script><script src="/assets/js/17.ac8637ed.js" defer></script>
  </body>
</html>
