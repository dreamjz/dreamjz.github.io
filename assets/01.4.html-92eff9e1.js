import{_ as o,Z as p,$ as c,a0 as s,a1 as n,a2 as t,a3 as e,H as i}from"./framework-dee406ed.js";const u={},l=e(`<h2 id="_8-tutorials" tabindex="-1"><a class="header-anchor" href="#_8-tutorials" aria-hidden="true">#</a> 8. Tutorials</h2><h3 id="_8-1-context" tabindex="-1"><a class="header-anchor" href="#_8-1-context" aria-hidden="true">#</a> 8.1 Context</h3><p>GORM provides Context support, you can use it with method <code>WithContext</code></p><h4 id="_8-1-1-single-session-mode" tabindex="-1"><a class="header-anchor" href="#_8-1-1-single-session-mode" aria-hidden="true">#</a> 8.1.1 Single Session Mode</h4><p>Single session mode usually used when you want to perform a single operation</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_8-1-2-continuous-session-mode" tabindex="-1"><a class="header-anchor" href="#_8-1-2-continuous-session-mode" aria-hidden="true">#</a> 8.1.2 Continuous session mode</h4><p>Continuous session mode usually used when you want to perform a group of operations, for example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-1-3-context-in-hooks-callbacks" tabindex="-1"><a class="header-anchor" href="#_8-1-3-context-in-hooks-callbacks" aria-hidden="true">#</a> 8.1.3 Context in Hooks/Callbacks</h4><p>You could access the <code>Context</code> object from current <code>Statement</code>, for example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">BeforeCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ctx <span class="token operator">:=</span> tx<span class="token punctuation">.</span>Statement<span class="token punctuation">.</span>Context
  <span class="token comment">// ...</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-1-4-chi-middleware-example" tabindex="-1"><a class="header-anchor" href="#_8-1-4-chi-middleware-example" aria-hidden="true">#</a> 8.1.4 Chi Middleware Example</h4><p>Continuous session mode which might be helpful when handling API requests, for example, you can set up <code>*gorm.DB</code> with Timeout Context in middlewares, and then use the <code>*gorm.DB</code> when processing all requests</p><p>Following is a Chi middleware example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">SetDBMiddleware</span><span class="token punctuation">(</span>next http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>
  <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    timeoutContext<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
    ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;DB&quot;</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>timeoutContext<span class="token punctuation">)</span><span class="token punctuation">)</span>
    next<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

r <span class="token operator">:=</span> chi<span class="token punctuation">.</span><span class="token function">NewRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>SetDBMiddleware<span class="token punctuation">)</span>

r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  db<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">&quot;DB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span>

  <span class="token keyword">var</span> users <span class="token punctuation">[</span><span class="token punctuation">]</span>User
  db<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>

  <span class="token comment">// lots of db operations</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;/user&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  db<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">&quot;DB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span>

  <span class="token keyword">var</span> user User
  db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

  <span class="token comment">// lots of db operations</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,16),r=s("strong",null,"NOTE",-1),d=s("code",null,"Context",-1),k=s("code",null,"WithContext",-1),m={href:"https://gorm.io/docs/session.html",target:"_blank",rel:"noopener noreferrer"},v=s("h4",{id:"_8-1-5-logger",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_8-1-5-logger","aria-hidden":"true"},"#"),n(" 8.1.5 Logger")],-1),b=s("code",null,"Context",-1),g={href:"https://gorm.io/docs/logger.html",target:"_blank",rel:"noopener noreferrer"},h=s("h3",{id:"_8-2-error-handling",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_8-2-error-handling","aria-hidden":"true"},"#"),n(" 8.2 Error Handling")],-1),f=s("p",null,"In Go, error handling is important",-1),_={href:"https://gorm.io/docs/method_chaining.html#finisher_method",target:"_blank",rel:"noopener noreferrer"},q=e(`<h4 id="_8-2-1-error-handling" tabindex="-1"><a class="header-anchor" href="#_8-2-1-error-handling" aria-hidden="true">#</a> 8.2.1 Error Handling</h4><p>Error hanling in GORM is different than idiomatic Go code because of its chainable API</p><p>If any error occurs, GORM will set <code>*gorm.DB*</code>&#39;s <code>Error</code> field, you need to check it likes this:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
  <span class="token comment">// error handling...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Or</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> result <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> result<span class="token punctuation">.</span>Error <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
  <span class="token comment">// error handling...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-2-2-errrecordnotfound" tabindex="-1"><a class="header-anchor" href="#_8-2-2-errrecordnotfound" aria-hidden="true">#</a> 8.2.2 ErrRecordNotFound</h4><p>GORM returns <code>ErrRecordNotFound</code> when failed to find data with <code>First</code>,<code>Last</code>,<code>Take</code>, if there are several errors happended, you can check the <code>ErrRecordNotFound</code> error with <code>errors.Is</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Check if returns RecordNotFound error</span>
err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error
errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> gorm<span class="token punctuation">.</span>ErrRecordNotFound<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-method-chaining" tabindex="-1"><a class="header-anchor" href="#_8-3-method-chaining" aria-hidden="true">#</a> 8.3 Method Chaining</h3><p>GORM allows method chaining, so you can write code like this:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age = ?&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>There are three kinds of methods in GORM: <code>Chain Method</code>,<code>Finisher Method</code>,<code>New Session Method</code></p><h4 id="_8-3-1-chain-method" tabindex="-1"><a class="header-anchor" href="#_8-3-1-chain-method" aria-hidden="true">#</a> 8.3.1 Chain Method</h4><p>Chain methods are methods to modify or add <code>Clauses</code> to current <code>Statement</code>, like:</p><p><code>Where</code>,<code>Select</code>,<code>Omit</code>,<code>Joins</code>,<code>Scopes</code>,<code>Preload</code>,<code>Raw</code>(<code>Raw</code> can’t be used with other chainable methods to build SQL) …</p>`,16),x={href:"https://github.com/go-gorm/gorm/blob/master/chainable_api.go",target:"_blank",rel:"noopener noreferrer"},y={href:"https://gorm.io/docs/sql_builder.html",target:"_blank",rel:"noopener noreferrer"},w=s("code",null,"Clauses",-1),S=e('<h4 id="_8-3-2-finisher-mehod" tabindex="-1"><a class="header-anchor" href="#_8-3-2-finisher-mehod" aria-hidden="true">#</a> 8.3.2 Finisher Mehod</h4><p>Finishers are immediate methods that execute registered callbacks, which will generate and execute SQL, like those methods:</p><p><code>Create</code>, <code>First</code>, <code>Find</code>, <code>Take</code>, <code>Save</code>, <code>Update</code>, <code>Delete</code>, <code>Scan</code>, <code>Row</code>, <code>Rows</code>…</p>',3),C={href:"https://github.com/go-gorm/gorm/blob/master/finisher_api.go",target:"_blank",rel:"noopener noreferrer"},D=s("h4",{id:"_8-3-3-new-session-method",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_8-3-3-new-session-method","aria-hidden":"true"},"#"),n(" 8.3.3 New Session Method")],-1),E=s("p",null,[n("After a nen initialized "),s("code",null,"*gorm.DB"),n(" or a "),s("code",null,"New Session Method"),n(", following methods call will create a new "),s("code",null,"Statement"),n(" instance instead of using the current one")],-1),T=s("code",null,"Session",-1),M=s("code",null,"WithContext",-1),N=s("code",null,"Debug",-1),R=s("code",null,"New Session Method",-1),O={href:"https://gorm.io/docs/session.html",target:"_blank",rel:"noopener noreferrer"},B=e('<div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;test.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token comment">// db is a new initialized *gorm.DB, which falls under `New Session Mode`</span>\ndb<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age = ?&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>\n<span class="token comment">// `Where(&quot;name = ?&quot;, &quot;jinzhu&quot;)` is the first method call, it will create a new `Statement`</span>\n<span class="token comment">// `Where(&quot;age = ?&quot;, 18)` reuses the `Statement`, and adds conditions to the `Statement`</span>\n<span class="token comment">// `Find(&amp;users)` is a finisher, it executes registered Query Callbacks, generates and runs the following SQL:</span>\n<span class="token comment">// SELECT * FROM users WHERE name = &#39;jinzhu&#39; AND age = 18;</span>\n\ndb<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age = ?&quot;</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>\n<span class="token comment">// `Where(&quot;name = ?&quot;, &quot;jinzhu2&quot;)` is also the first method call, it creates new `Statement` too</span>\n<span class="token comment">// `Where(&quot;age = ?&quot;, 20)` reuses the `Statement`, and add conditions to the `Statement`</span>\n<span class="token comment">// `Find(&amp;users)` is a finisher, it executes registered Query Callbacks, generates and runs the following SQL:</span>\n<span class="token comment">// SELECT * FROM users WHERE name = &#39;jinzhu2&#39; AND age = 20;</span>\n\ndb<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>\n<span class="token comment">// `Find(&amp;users)` is a finisher method and also the first method call for a `New Session Mode` `*gorm.DB`</span>\n<span class="token comment">// It creates a new `Statement` and executes registered Query Callbacks, generates and runs following SQL:</span>\n<span class="token comment">// SELECT * FROM users;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;test.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token comment">// db is a new initialized *gorm.DB, which falls under `New Session Mode`</span>\ntx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span>\n<span class="token comment">// `Where(&quot;name = ?&quot;, &quot;jinzhu&quot;)` is the first method call, it creates a new `Statement` and adds conditions</span>\n\ntx<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age = ?&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>\n<span class="token comment">// `tx.Where(&quot;age = ?&quot;, 18)` REUSES above `Statement`, and adds conditions to the `Statement`</span>\n<span class="token comment">// `Find(&amp;users)` is a finisher, it executes registered Query Callbacks, generates and runs the following SQL:</span>\n<span class="token comment">// SELECT * FROM users WHERE name = &#39;jinzhu&#39; AND age = 18</span>\n\ntx<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age = ?&quot;</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>\n<span class="token comment">// `tx.Where(&quot;age = ?&quot;, 18)` REUSES above `Statement` also, and add conditions to the `Statement`</span>\n<span class="token comment">// `Find(&amp;users)` is a finisher, it executes registered Query Callbacks, generates and runs the following SQL:</span>\n<span class="token comment">// SELECT * FROM users WHERE name = &#39;jinzhu&#39; AND age = 18 AND age = 28;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>NOTE</strong></p>',3),U=s("code",null,"Statement",-1),L={href:"https://gorm.io/docs/method_chaining.html#goroutine_safe",target:"_blank",rel:"noopener noreferrer"},F=e(`<h4 id="_8-3-4-method-chain-safety-goroutine-safety" tabindex="-1"><a class="header-anchor" href="#_8-3-4-method-chain-safety-goroutine-safety" aria-hidden="true">#</a> 8.3.4 Method Chain Safety/Goroutine Safety</h4><p>Methods will create new <code>Statement</code> instance for new initialized <code>*gorm.DB</code> or after a <code>New Session Method</code>, so to reuse a <code>*gorm.DB</code> you need to make sure they are under <code>New Session Mode</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;test.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Safe for a new initialized *gorm.DB</span>
<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
  <span class="token keyword">go</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// NOT Safe as reusing Statement</span>
<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
  <span class="token keyword">go</span> tx<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

ctx<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
ctxDB <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
<span class="token comment">// Safe after a \`New Session Method\`</span>
<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
  <span class="token keyword">go</span> ctxDB<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

ctx<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
ctxDB <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
<span class="token comment">// Safe after a \`New Session Method\`</span>
<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
  <span class="token keyword">go</span> ctxDB<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span> <span class="token comment">// \`name = &#39;jinzhu&#39;\` will apply to the query</span>
<span class="token punctuation">}</span>

tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// Safe after a \`New Session Method\`</span>
<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
  <span class="token keyword">go</span> tx<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span> <span class="token comment">// \`name = &#39;jinzhu&#39;\` will apply to the query</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在并发情形下，一定要注意使用 New Session Mode 以确保线程安全</p><h3 id="_8-4-session" tabindex="-1"><a class="header-anchor" href="#_8-4-session" aria-hidden="true">#</a> 8.4 Session</h3><p>GORM provides <code>Session</code> method, which is a <code>New Session Method</code>, it allows to create a new session mode with configuration</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Session Configuration</span>
<span class="token keyword">type</span> Session <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  DryRun                   <span class="token builtin">bool</span>
  PrepareStmt              <span class="token builtin">bool</span>
  NewDB                    <span class="token builtin">bool</span>
  SkipHooks                <span class="token builtin">bool</span>
  SkipDefaultTransaction   <span class="token builtin">bool</span>
  DisableNestedTransaction <span class="token builtin">bool</span>
  AllowGlobalUpdate        <span class="token builtin">bool</span>
  FullSaveAssociations     <span class="token builtin">bool</span>
  QueryFields              <span class="token builtin">bool</span>
  CreateBatchSize          <span class="token builtin">int</span>
  Context                  context<span class="token punctuation">.</span>Context
  Logger                   logger<span class="token punctuation">.</span>Interface
  NowFunc                  <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> time<span class="token punctuation">.</span>Time
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-4-1-dryrun" tabindex="-1"><a class="header-anchor" href="#_8-4-1-dryrun" aria-hidden="true">#</a> 8.4.1 DryRun</h4><p>Generates <code>SQL</code> without executing. It can be used to prepare or test generated SQL, for example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// session mode</span>
stmt <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>DryRun<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Statement
stmt<span class="token punctuation">.</span>SQL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//=&gt; SELECT * FROM \`users\` WHERE \`id\` = $1 ORDER BY \`id\`</span>
stmt<span class="token punctuation">.</span>Vars         <span class="token comment">//=&gt; []interface{}{1}</span>

<span class="token comment">// globally mode with DryRun</span>
db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;gorm.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>DryRun<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// different databases generate different SQL</span>
stmt <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Statement
stmt<span class="token punctuation">.</span>SQL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//=&gt; SELECT * FROM \`users\` WHERE \`id\` = $1 // PostgreSQL</span>
stmt<span class="token punctuation">.</span>SQL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//=&gt; SELECT * FROM \`users\` WHERE \`id\` = ?  // MySQL</span>
stmt<span class="token punctuation">.</span>Vars         <span class="token comment">//=&gt; []interface{}{1}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>To generate the final SQL, you could use following code:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// NOTE: the SQL is not always safe to execute, GORM only uses it for logs, it might cause SQL injection</span>
db<span class="token punctuation">.</span>Dialector<span class="token punctuation">.</span><span class="token function">Explain</span><span class="token punctuation">(</span>stmt<span class="token punctuation">.</span>SQL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stmt<span class="token punctuation">.</span>Vars<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM \`users\` WHERE \`id\` = 1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-4-2-preparestmt" tabindex="-1"><a class="header-anchor" href="#_8-4-2-preparestmt" aria-hidden="true">#</a> 8.4.2 PrepareStmt</h4><p><code>PrepareStmt</code> creates prepared statements where executing any SQL and caches them to speed up future calls</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// globally mode, all DB operations will create prepared statements and cache them</span>
db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;gorm.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  PrepareStmt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// session mode</span>
tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>PrepareStmt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;Age&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>

<span class="token comment">// returns prepared statements manager</span>
stmtManger<span class="token punctuation">,</span> ok <span class="token operator">:=</span> tx<span class="token punctuation">.</span>ConnPool<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>PreparedStmtDB<span class="token punctuation">)</span>

<span class="token comment">// close prepared statements for *current session*</span>
stmtManger<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// prepared SQL for *current session*</span>
stmtManger<span class="token punctuation">.</span>PreparedSQL <span class="token comment">// =&gt; []string{}</span>

<span class="token comment">// prepared statements for current database connection pool (all sessions)</span>
stmtManger<span class="token punctuation">.</span>Stmts <span class="token comment">// map[string]*sql.Stmt</span>

<span class="token keyword">for</span> sql<span class="token punctuation">,</span> stmt <span class="token operator">:=</span> <span class="token keyword">range</span> stmtManger<span class="token punctuation">.</span>Stmts <span class="token punctuation">{</span>
  sql  <span class="token comment">// prepared SQL</span>
  stmt <span class="token comment">// prepared statement</span>
  stmt<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// close the prepared statement</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-4-3-newdb" tabindex="-1"><a class="header-anchor" href="#_8-4-3-newdb" aria-hidden="true">#</a> 8.4.3 NewDB</h4><p>Create a new DB without conditions with option <code>NewDB</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>NewDB<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

tx<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users ORDER BY id LIMIT 1</span>

tx<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token string">&quot;id = ?&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE id = 10 ORDER BY id</span>

<span class="token comment">// Without option \`NewDB\`</span>
tx2 <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
tx2<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE name = &quot;jinzhu&quot; ORDER BY id</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-4-4-skip-hooks" tabindex="-1"><a class="header-anchor" href="#_8-4-4-skip-hooks" aria-hidden="true">#</a> 8.4.4 Skip Hooks</h4><p>If you want to skip <code>Hooks</code> methods, you can use the <code>SkipHooks</code> session mode, for example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>DB<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>SkipHooks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

DB<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>SkipHooks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>

DB<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>SkipHooks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateInBatches</span><span class="token punctuation">(</span>users<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>

DB<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>SkipHooks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

DB<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>SkipHooks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>

DB<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>SkipHooks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;age &gt; ?&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-4-5-disablenestedtransaction" tabindex="-1"><a class="header-anchor" href="#_8-4-5-disablenestedtransaction" aria-hidden="true">#</a> 8.4.5 DisableNestedTransaction</h4><p>When using <code>Transaction</code> method inside a DB transaction, GORM will use <code>SavePoint(savePointName)</code>, <code>RollbackTo(savePointName)</code> to give you the nested transaction support. You can disable it by using <code>DisableNestedTransaction</code>option</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>
  DisableNestedTransaction<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateInBatches</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-4-6-allowglobalupdate" tabindex="-1"><a class="header-anchor" href="#_8-4-6-allowglobalupdate" aria-hidden="true">#</a> 8.4.6 AllowGlobalUpdate</h4><p>GORM doesn’t allow global update/delete by default, will return <code>ErrMissingWhereClause</code> error. You can set this option to true to enable it, for example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>
  AllowGlobalUpdate<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// UPDATE users SET \`name\` = &quot;jinzhu&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-4-7-fullsaveassociations" tabindex="-1"><a class="header-anchor" href="#_8-4-7-fullsaveassociations" aria-hidden="true">#</a> 8.4.7 FullSaveAssociations</h4>`,28),I={href:"https://gorm.io/docs/create.html#upsert",target:"_blank",rel:"noopener noreferrer"},A=s("code",null,"FullSaveAssociations",-1),G=e(`<div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>FullSaveAssociations<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// ...</span>
<span class="token comment">// INSERT INTO &quot;addresses&quot; (address1) VALUES (&quot;Billing Address - Address 1&quot;), (&quot;Shipping Address - Address 1&quot;) ON DUPLICATE KEY SET address1=VALUES(address1);</span>
<span class="token comment">// INSERT INTO &quot;users&quot; (name,billing_address_id,shipping_address_id) VALUES (&quot;jinzhu&quot;, 1, 2);</span>
<span class="token comment">// INSERT INTO &quot;emails&quot; (user_id,email) VALUES (111, &quot;jinzhu@example.com&quot;), (111, &quot;jinzhu-2@example.com&quot;) ON DUPLICATE KEY SET email=VALUES(email);</span>
<span class="token comment">// ...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-4-8-context" tabindex="-1"><a class="header-anchor" href="#_8-4-8-context" aria-hidden="true">#</a> 8.4.8 Context</h4><p>With the <code>Context</code> option, you can set the <code>Context</code> for following SQL operations, for example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>timeoutCtx<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>Context<span class="token punctuation">:</span> timeoutCtx<span class="token punctuation">}</span><span class="token punctuation">)</span>

tx<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span> <span class="token comment">// query with context timeoutCtx</span>
tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span> <span class="token comment">// update with context timeoutCtx</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>GORM also provides shortcut method <code>WithContext</code>, here is the definition:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>DB<span class="token punctuation">)</span> <span class="token function">WithContext</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token operator">*</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>Context<span class="token punctuation">:</span> ctx<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-4-9-logger" tabindex="-1"><a class="header-anchor" href="#_8-4-9-logger" aria-hidden="true">#</a> 8.4.9 Logger</h4><p>Gorm allows customizing built-in logger with the <code>Logger</code> option, for example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>newLogger <span class="token operator">:=</span> logger<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> <span class="token string">&quot;\\r\\n&quot;</span><span class="token punctuation">,</span> log<span class="token punctuation">.</span>LstdFlags<span class="token punctuation">)</span><span class="token punctuation">,</span>
              logger<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
                SlowThreshold<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
                LogLevel<span class="token punctuation">:</span>      logger<span class="token punctuation">.</span>Silent<span class="token punctuation">,</span>
                Colorful<span class="token punctuation">:</span>      <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>Logger<span class="token punctuation">:</span> newLogger<span class="token punctuation">}</span><span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>Logger<span class="token punctuation">:</span> logger<span class="token punctuation">.</span>Default<span class="token punctuation">.</span><span class="token function">LogMode</span><span class="token punctuation">(</span>logger<span class="token punctuation">.</span>Silent<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,9),z={href:"https://gorm.io/docs/logger.html",target:"_blank",rel:"noopener noreferrer"},W=e(`<h4 id="_8-4-10-nowfunc" tabindex="-1"><a class="header-anchor" href="#_8-4-10-nowfunc" aria-hidden="true">#</a> 8.4.10 NowFunc</h4><p><code>NowFunc</code> allows changing the function to get current time of GORM, for example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>
  NowFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> time<span class="token punctuation">.</span>Time <span class="token punctuation">{</span>
    <span class="token keyword">return</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Local</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-4-11-debug" tabindex="-1"><a class="header-anchor" href="#_8-4-11-debug" aria-hidden="true">#</a> 8.4.11 Debug</h4><p><code>Debug</code> is a shortcut method to change session’s <code>Logger</code> to debug mode, here is the definition:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>DB<span class="token punctuation">)</span> <span class="token function">Debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>tx <span class="token operator">*</span>DB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>
    Logger<span class="token punctuation">:</span>         db<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">LogMode</span><span class="token punctuation">(</span>logger<span class="token punctuation">.</span>Info<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-4-12-queryfields" tabindex="-1"><a class="header-anchor" href="#_8-4-12-queryfields" aria-hidden="true">#</a> 8.4.12 QueryFields</h4><p>Select by fields</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>QueryFields<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// SELECT \`users\`.\`name\`, \`users\`.\`age\`, ... FROM \`users\` // with this option</span>
<span class="token comment">// SELECT * FROM \`users\` // without this option</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个设置比较重要，可以避免使用 <code>SELECT *</code></p><h4 id="_8-4-13-createbatchsize" tabindex="-1"><a class="header-anchor" href="#_8-4-13-createbatchsize" aria-hidden="true">#</a> 8.4.13 CreateBatchSize</h4><p>Default batch size</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">5000</span><span class="token punctuation">]</span>User<span class="token punctuation">{</span><span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span> Pets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Pet<span class="token punctuation">{</span>pet1<span class="token punctuation">,</span> pet2<span class="token punctuation">,</span> pet3<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">...</span><span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{</span>CreateBatchSize<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// INSERT INTO users xxx (5 batches)</span>
<span class="token comment">// INSERT INTO pets xxx (15 batches)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-5-hooks" tabindex="-1"><a class="header-anchor" href="#_8-5-hooks" aria-hidden="true">#</a> 8.5 Hooks</h3><h4 id="_8-5-1-object-life-cycle" tabindex="-1"><a class="header-anchor" href="#_8-5-1-object-life-cycle" aria-hidden="true">#</a> 8.5.1 Object Life Cycle</h4><p>Hooks are functions that are called before or after creation/quering/updating/deletion</p><p>If you have defined specified methods for a model, it will be called automatically when creating, updating, querying, deleting, and if any callback returns an error, GORM will stop future operations and rollback current transaction.</p><p>The type of hook methods should be <code>func(*gorm.DB) error</code></p><h4 id="_8-5-2-creating-an-object" tabindex="-1"><a class="header-anchor" href="#_8-5-2-creating-an-object" aria-hidden="true">#</a> 8.5.2 Creating an object</h4><p>Available hooks for creating</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// begin transaction</span>
BeforeSave
BeforeCreate
<span class="token comment">// save before associations</span>
<span class="token comment">// insert into database</span>
<span class="token comment">// save after associations</span>
AfterCreate
AfterSave
<span class="token comment">// commit or rollback transaction</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Code Example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">BeforeCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  u<span class="token punctuation">.</span>UUID <span class="token operator">=</span> uuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token operator">!</span>u<span class="token punctuation">.</span><span class="token function">IsValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    err <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;can&#39;t save invalid data&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">AfterCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> u<span class="token punctuation">.</span>ID <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
    tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>NOTE</strong> Save/Delete operations in GORM are running in transactions by default, so changes made in that transaction are not visible until it is committed, if you return any error in your hooks, the change will be rollbacked</p></blockquote><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">AfterCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token operator">!</span>u<span class="token punctuation">.</span><span class="token function">IsValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;rollback invalid user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-5-3-updating-an-object" tabindex="-1"><a class="header-anchor" href="#_8-5-3-updating-an-object" aria-hidden="true">#</a> 8.5.3 Updating an object</h4><p>Available hooks for updating</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// begin transaction</span>
BeforeSave
BeforeUpdate
<span class="token comment">// save before associations</span>
<span class="token comment">// update database</span>
<span class="token comment">// save after associations</span>
AfterUpdate
AfterSave
<span class="token comment">// commit or rollback transaction</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Code Example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">BeforeUpdate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> u<span class="token punctuation">.</span><span class="token function">readonly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    err <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;read only user&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token comment">// Updating data in same transaction</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">AfterUpdate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> u<span class="token punctuation">.</span>Confirmed <span class="token punctuation">{</span>
    tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Address<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;user_id = ?&quot;</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>ID<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;verfied&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-5-4-deleting-an-object" tabindex="-1"><a class="header-anchor" href="#_8-5-4-deleting-an-object" aria-hidden="true">#</a> 8.5.4 Deleting an object</h4><p>Available hooks for deleting</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// begin transaction</span>
BeforeDelete
<span class="token comment">// delete from database</span>
AfterDelete
<span class="token comment">// commit or rollback transaction</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Code Example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Updating data in same transaction</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">AfterDelete</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> u<span class="token punctuation">.</span>Confirmed <span class="token punctuation">{</span>
    tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Address<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;user_id = ?&quot;</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>ID<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;invalid&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-5-5-querying-an-object" tabindex="-1"><a class="header-anchor" href="#_8-5-5-querying-an-object" aria-hidden="true">#</a> 8.5.5 Querying an object</h4><p>Available hooks for querying</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// load data from database</span>
<span class="token comment">// Preloading (eager loading)</span>
AfterFind
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Code Example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">AfterFind</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> u<span class="token punctuation">.</span>MemberShip <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
    u<span class="token punctuation">.</span>MemberShip <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-5-6-modify-current-operation" tabindex="-1"><a class="header-anchor" href="#_8-5-6-modify-current-operation" aria-hidden="true">#</a> 8.5.6 Modify current operation</h4><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">BeforeCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token comment">// Modify current operation through tx.Statement, e.g:</span>
  tx<span class="token punctuation">.</span>Statement<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Age&quot;</span><span class="token punctuation">)</span>
  tx<span class="token punctuation">.</span>Statement<span class="token punctuation">.</span><span class="token function">AddClause</span><span class="token punctuation">(</span>clause<span class="token punctuation">.</span>OnConflict<span class="token punctuation">{</span>DoNothing<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// tx is new session mode with the \`NewDB\` option</span>
  <span class="token comment">// operations based on it will run inside same transaction but without any current conditions</span>
  <span class="token keyword">var</span> role Role
  err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>role<span class="token punctuation">,</span> <span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>Role<span class="token punctuation">)</span><span class="token punctuation">.</span>Error
  <span class="token comment">// SELECT * FROM roles WHERE name = &quot;admin&quot;</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-6-transactions" tabindex="-1"><a class="header-anchor" href="#_8-6-transactions" aria-hidden="true">#</a> 8.6 Transactions</h3><h4 id="_8-6-1-disable-default-transaction" tabindex="-1"><a class="header-anchor" href="#_8-6-1-disable-default-transaction" aria-hidden="true">#</a> 8.6.1 Disable Default Transaction</h4><p>GORM perform write (create/update/delete) operations run inside a transaction to ensure data consistency, you can disable it during initialization if it is not required, you will gain about 30%+ performance improvement after that</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Globally disable</span>
db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;gorm.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  SkipDefaultTransaction<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Continuous session mode</span>
tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>SkipDefaultTransaction<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;Age&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-6-2-transaction" tabindex="-1"><a class="header-anchor" href="#_8-6-2-transaction" aria-hidden="true">#</a> 8.6.2 Transaction</h4><p>To perform a set of operations within a transaction, the general flow is as below</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token comment">// do some database operations in the transaction (use &#39;tx&#39; from this point, not &#39;db&#39;)</span>
  <span class="token keyword">if</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Animal<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Giraffe&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token comment">// return any error will rollback</span>
    <span class="token keyword">return</span> err
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Animal<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Lion&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> err
  <span class="token punctuation">}</span>

  <span class="token comment">// return nil will commit the whole transaction</span>
  <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-6-3-nested-transactions" tabindex="-1"><a class="header-anchor" href="#_8-6-3-nested-transactions" aria-hidden="true">#</a> 8.6.3 Nested Transactions</h4><p>GORM supports nested transactions, you can rollback a subset of operations performed within the scope of a larger transaction, for example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user1<span class="token punctuation">)</span>

  tx<span class="token punctuation">.</span><span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx2 <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    tx2<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user2<span class="token punctuation">)</span>
    <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;rollback user2&quot;</span><span class="token punctuation">)</span> <span class="token comment">// Rollback user2</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  tx<span class="token punctuation">.</span><span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx2 <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    tx2<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user3<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Commit user1, user3</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-6-4-control-the-transaction-manually" tabindex="-1"><a class="header-anchor" href="#_8-6-4-control-the-transaction-manually" aria-hidden="true">#</a> 8.6.4 Control the transaction manually</h4><p>Gorm supports calling transaction control functions (commit / rollback) directly, for example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// begin a transaction</span>
tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// do some database operations in the transaction (use &#39;tx&#39; from this point, not &#39;db&#39;)</span>
tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>

<span class="token comment">// ...</span>

<span class="token comment">// rollback the transaction in case of error</span>
tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Or commit the transaction</span>
tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-6-5-a-specific-example" tabindex="-1"><a class="header-anchor" href="#_8-6-5-a-specific-example" aria-hidden="true">#</a> 8.6.5 A Specific Example</h4><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">CreateAnimals</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token comment">// Note the use of tx as the database handle once you are within a transaction</span>
  tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> r <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> r <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> err
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Animal<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Giraffe&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
     tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token keyword">return</span> err
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Animal<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Lion&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
     tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token keyword">return</span> err
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Error
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-6-6-savepoint-rollbackto" tabindex="-1"><a class="header-anchor" href="#_8-6-6-savepoint-rollbackto" aria-hidden="true">#</a> 8.6.6 SavePoint, RollbackTo</h4><p>GORM provides <code>SavePoint</code>, <code>RollbackTo</code> to save points and roll back to a savepoint, for example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user1<span class="token punctuation">)</span>

tx<span class="token punctuation">.</span><span class="token function">SavePoint</span><span class="token punctuation">(</span><span class="token string">&quot;sp1&quot;</span><span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user2<span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">RollbackTo</span><span class="token punctuation">(</span><span class="token string">&quot;sp1&quot;</span><span class="token punctuation">)</span> <span class="token comment">// Rollback user2</span>

tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Commit user1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-7-migration" tabindex="-1"><a class="header-anchor" href="#_8-7-migration" aria-hidden="true">#</a> 8.7 Migration</h3><h4 id="_8-7-1-auto-migration" tabindex="-1"><a class="header-anchor" href="#_8-7-1-auto-migration" aria-hidden="true">#</a> 8.7.1 Auto Migration</h4><p>Automatically migrate your schema, to keep your schema up to date</p><p><strong>NOTE:</strong></p><p>AutoMigrate will create tables, missing foreign keys, constraints, columns and indexes. It will change existing column’s type if its size, precision, nullable changed. It <strong>WON’T</strong> delete unused columns to protect your data.</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Product<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Order<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Add table suffix when creating tables</span>
db<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;gorm:table_options&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ENGINE=InnoDB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>NOTE</strong></p><p>AutoMigrate creates database foreign key constraints automatically, you can disable this feature during initialization, for example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;gorm.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>  DisableForeignKeyConstraintWhenMigrating<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_8-7-2-migrator-interface" tabindex="-1"><a class="header-anchor" href="#_8-7-2-migrator-interface" aria-hidden="true">#</a> 8.7.2 Migrator Interface</h4><p>GORM provides a migrator interface, which contains unified API interfaces for each database that could be used to build your database-independent migrations, for example:</p><p>SQLite doesn’t support <code>ALTER COLUMN</code>, <code>DROP COLUMN</code>, GORM will create a new table as the one you are trying to change, copy all data, drop the old table, rename the new table</p><p>MySQL doesn’t support rename column, index for some versions, GORM will perform different SQL based on the MySQL version you are using</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Migrator <span class="token keyword">interface</span> <span class="token punctuation">{</span>
  <span class="token comment">// AutoMigrate</span>
  <span class="token function">AutoMigrate</span><span class="token punctuation">(</span>dst <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>

  <span class="token comment">// Database</span>
  <span class="token function">CurrentDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
  <span class="token function">FullDataTypeOf</span><span class="token punctuation">(</span><span class="token operator">*</span>schema<span class="token punctuation">.</span>Field<span class="token punctuation">)</span> clause<span class="token punctuation">.</span>Expr

  <span class="token comment">// Tables</span>
  <span class="token function">CreateTable</span><span class="token punctuation">(</span>dst <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">DropTable</span><span class="token punctuation">(</span>dst <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">HasTable</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
  <span class="token function">RenameTable</span><span class="token punctuation">(</span>oldName<span class="token punctuation">,</span> newName <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>

  <span class="token comment">// Columns</span>
  <span class="token function">AddColumn</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> field <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">DropColumn</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> field <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">AlterColumn</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> field <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">HasColumn</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> field <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
  <span class="token function">RenameColumn</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> oldName<span class="token punctuation">,</span> field <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">MigrateColumn</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> field <span class="token operator">*</span>schema<span class="token punctuation">.</span>Field<span class="token punctuation">,</span> columnType <span class="token operator">*</span>sql<span class="token punctuation">.</span>ColumnType<span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">ColumnTypes</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>sql<span class="token punctuation">.</span>ColumnType<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

  <span class="token comment">// Constraints</span>
  <span class="token function">CreateConstraint</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">DropConstraint</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">HasConstraint</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>

  <span class="token comment">// Indexes</span>
  <span class="token function">CreateIndex</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">DropIndex</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
  <span class="token function">HasIndex</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
  <span class="token function">RenameIndex</span><span class="token punctuation">(</span>dst <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> oldName<span class="token punctuation">,</span> newName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-7-3-currentdatabase" tabindex="-1"><a class="header-anchor" href="#_8-7-3-currentdatabase" aria-hidden="true">#</a> 8.7.3 CurrentDatabase</h4><p>Returns current using database name</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CurrentDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_8-7-4-tables" tabindex="-1"><a class="header-anchor" href="#_8-7-4-tables" aria-hidden="true">#</a> 8.7.4 Tables</h4><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Create table for \`User\`</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateTable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Append &quot;ENGINE=InnoDB&quot; to the creating table SQL for \`User\`</span>
db<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;gorm:table_options&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ENGINE=InnoDB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateTable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Check table for \`User\` exists or not</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasTable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasTable</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// Drop table if exists (will ignore or delete foreign key constraints when dropping)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DropTable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DropTable</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// Rename old table to new table</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RenameTable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>UserInfo<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RenameTable</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;user_infos&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-7-5-columns" tabindex="-1"><a class="header-anchor" href="#_8-7-5-columns" aria-hidden="true">#</a> 8.7.5 Columns</h4><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  Name <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// Add name field</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddColumn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Name&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// Drop name field</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DropColumn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Name&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// Alter name field</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AlterColumn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Name&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// Check column exists</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasColumn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Name&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  Name    <span class="token builtin">string</span>
  NewName <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// Rename column to new name</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RenameColumn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;NewName&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RenameColumn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;new_name&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// ColumnTypes</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ColumnTypes</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>sql<span class="token punctuation">.</span>ColumnType<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-7-6-constraints" tabindex="-1"><a class="header-anchor" href="#_8-7-6-constraints" aria-hidden="true">#</a> 8.7.6 Constraints</h4><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> UserIndex <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  Name  <span class="token builtin">string</span> <span class="token string">\`gorm:&quot;check:name_checker,name &lt;&gt; &#39;jinzhu&#39;&quot;\`</span>
<span class="token punctuation">}</span>

<span class="token comment">// Create constraint</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateConstraint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;name_checker&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// Drop constraint</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DropConstraint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;name_checker&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// Check constraint exists</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasConstraint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;name_checker&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Create foreign keys for relations</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  CreditCards <span class="token punctuation">[</span><span class="token punctuation">]</span>CreditCard
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CreditCard <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Number <span class="token builtin">string</span>
  UserID <span class="token builtin">uint</span>
<span class="token punctuation">}</span>

<span class="token comment">// create database foreign key for user &amp; credit_cards</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateConstraint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;CreditCards&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateConstraint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;fk_users_credit_cards&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// ALTER TABLE \`credit_cards\` ADD CONSTRAINT \`fk_users_credit_cards\` FOREIGN KEY (\`user_id\`) REFERENCES \`users\`(\`id\`)</span>

<span class="token comment">// check database foreign key for user &amp; credit_cards exists or not</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasConstraint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;CreditCards&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasConstraint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;fk_users_credit_cards&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// drop database foreign key for user &amp; credit_cards</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DropConstraint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;CreditCards&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DropConstraint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;fk_users_credit_cards&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-7-7-indexes" tabindex="-1"><a class="header-anchor" href="#_8-7-7-indexes" aria-hidden="true">#</a> 8.7.7 Indexes</h4><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Name <span class="token builtin">string</span> <span class="token string">\`gorm:&quot;size:255;index:idx_name,unique&quot;\`</span>
<span class="token punctuation">}</span>

<span class="token comment">// Create index for Name field</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateIndex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Name&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateIndex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;idx_name&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// Drop index for Name field</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DropIndex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Name&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DropIndex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;idx_name&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// Check Index exists</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasIndex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Name&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasIndex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;idx_name&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  Name  <span class="token builtin">string</span> <span class="token string">\`gorm:&quot;size:255;index:idx_name,unique&quot;\`</span>
  Name2 <span class="token builtin">string</span> <span class="token string">\`gorm:&quot;size:255;index:idx_name_2,unique&quot;\`</span>
<span class="token punctuation">}</span>
<span class="token comment">// Rename index name</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RenameIndex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Name2&quot;</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Migrator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RenameIndex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;idx_name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;idx_name_2&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-7-8-constraints" tabindex="-1"><a class="header-anchor" href="#_8-7-8-constraints" aria-hidden="true">#</a> 8.7.8 Constraints</h4>`,88),j={href:"https://gorm.io/docs/constraints.html",target:"_blank",rel:"noopener noreferrer"},Q={href:"https://gorm.io/docs/indexes.html",target:"_blank",rel:"noopener noreferrer"},P=e('<h4 id="_8-7-9-other-migration-tools" tabindex="-1"><a class="header-anchor" href="#_8-7-9-other-migration-tools" aria-hidden="true">#</a> 8.7.9 Other Migration Tools</h4><p>GORM’s AutoMigrate works well for most cases, but if you are looking for more serious migration tools, GORM provides a generic DB interface that might be helpful for you.</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// returns `*sql.DB`</span>\ndb<span class="token punctuation">.</span><span class="token function">DB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div>',3),H={href:"https://gorm.io/docs/generic_interface.html",target:"_blank",rel:"noopener noreferrer"},V=s("h3",{id:"_8-8-logger",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_8-8-logger","aria-hidden":"true"},"#"),n(" 8.8 Logger")],-1),Y={href:"https://github.com/go-gorm/gorm/blob/master/logger/logger.go",target:"_blank",rel:"noopener noreferrer"},J=e(`<p>The logger accepts few options, you can customize it during initialization</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>newLogger <span class="token operator">:=</span> logger<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>
  log<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> <span class="token string">&quot;\\r\\n&quot;</span><span class="token punctuation">,</span> log<span class="token punctuation">.</span>LstdFlags<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// io writer</span>
  logger<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
    SlowThreshold<span class="token punctuation">:</span>              time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>   <span class="token comment">// Slow SQL threshold</span>
    LogLevel<span class="token punctuation">:</span>                   logger<span class="token punctuation">.</span>Silent<span class="token punctuation">,</span> <span class="token comment">// Log level</span>
    IgnoreRecordNotFoundError<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>           <span class="token comment">// Ignore ErrRecordNotFound error for logger</span>
    Colorful<span class="token punctuation">:</span>                  <span class="token boolean">false</span><span class="token punctuation">,</span>          <span class="token comment">// Disable color</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token comment">// Globally mode</span>
db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;test.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  Logger<span class="token punctuation">:</span> newLogger<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Continuous session mode</span>
tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>Logger<span class="token punctuation">:</span> newLogger<span class="token punctuation">}</span><span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;Age&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-8-1-log-levels" tabindex="-1"><a class="header-anchor" href="#_8-8-1-log-levels" aria-hidden="true">#</a> 8.8.1 Log Levels</h4><p>GORM defined log levels: <code>Slient</code>,<code>Error</code>,<code>Warn</code>,<code>Info</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;test.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  Logger<span class="token punctuation">:</span> logger<span class="token punctuation">.</span>Default<span class="token punctuation">.</span><span class="token function">LogMode</span><span class="token punctuation">(</span>logger<span class="token punctuation">.</span>Silent<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-8-2-debug" tabindex="-1"><a class="header-anchor" href="#_8-8-2-debug" aria-hidden="true">#</a> 8.8.2 Debug</h4>`,6),K={href:"http://logger.Info",target:"_blank",rel:"noopener noreferrer"},X=e(`<div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_8-8-3-customize-logger" tabindex="-1"><a class="header-anchor" href="#_8-8-3-customize-logger" aria-hidden="true">#</a> 8.8.3 Customize Logger</h4>`,2),$={href:"https://github.com/go-gorm/gorm/blob/master/logger/logger.go",target:"_blank",rel:"noopener noreferrer"},Z=e(`<p>The logger needs to implement the following interface, it accepts <code>context</code>, so you can use it for log tracing</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Interface <span class="token keyword">interface</span> <span class="token punctuation">{</span>
  <span class="token function">LogMode</span><span class="token punctuation">(</span>LogLevel<span class="token punctuation">)</span> Interface
  <span class="token function">Info</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">Warn</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">Error</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">Trace</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> begin time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> fc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sql <span class="token builtin">string</span><span class="token punctuation">,</span> rowsAffected <span class="token builtin">int64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-9-generic-database-interface-sql-db" tabindex="-1"><a class="header-anchor" href="#_8-9-generic-database-interface-sql-db" aria-hidden="true">#</a> 8.9 Generic Database Interface sql.DB</h3>`,3),nn=s("code",null,"DB",-1),sn={href:"https://pkg.go.dev/database/sql#DB",target:"_blank",rel:"noopener noreferrer"},an=s("code",null,"*gorm.DB",-1),tn=e(`<div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Get generic database object sql.DB to use its functions</span>
sqlDB<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">DB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Ping</span>
sqlDB<span class="token punctuation">.</span><span class="token function">Ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Close</span>
sqlDB<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Returns database statistics</span>
sqlDB<span class="token punctuation">.</span><span class="token function">Stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>NOTE</strong></p><p>If the underlying database connection is not a <code>*sql.DB</code>, like in a transaction, it will returns error</p><h4 id="_8-9-1-connection-pool" tabindex="-1"><a class="header-anchor" href="#_8-9-1-connection-pool" aria-hidden="true">#</a> 8.9.1 Connection Pool</h4><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Get generic database object sql.DB to use its functions</span>
sqlDB<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">DB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// SetMaxIdleConns sets the maximum number of connections in the idle connection pool.</span>
sqlDB<span class="token punctuation">.</span><span class="token function">SetMaxIdleConns</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

<span class="token comment">// SetMaxOpenConns sets the maximum number of open connections to the database.</span>
sqlDB<span class="token punctuation">.</span><span class="token function">SetMaxOpenConns</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>

<span class="token comment">// SetConnMaxLifetime sets the maximum amount of time a connection may be reused.</span>
sqlDB<span class="token punctuation">.</span><span class="token function">SetConnMaxLifetime</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-10-performance" tabindex="-1"><a class="header-anchor" href="#_8-10-performance" aria-hidden="true">#</a> 8.10 Performance</h3><p>GORM optimizes many things to improve the performance, the default performance should goog for most applications, but there are still some tips for how to improve it for your application</p><h4 id="_8-10-1-disable-default-transaction" tabindex="-1"><a class="header-anchor" href="#_8-10-1-disable-default-transaction" aria-hidden="true">#</a> 8.10.1 Disable Default Transaction</h4><p>GORM perform write (create/update/delete) operations run inside a transaction to ensure data consistency, which is bad for performance, you can disable it during initialization</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;gorm.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  SkipDefaultTransaction<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-10-2-caches-prepared-statement" tabindex="-1"><a class="header-anchor" href="#_8-10-2-caches-prepared-statement" aria-hidden="true">#</a> 8.10.2 Caches Prepared Statement</h4><p>Creates a prepared statement when executing any SQL and caches them to speed up future calls</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Globally mode</span>
db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;gorm.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  PrepareStmt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Session mode</span>
tx <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>PrepareStmt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
tx<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;Age&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>NOTE</strong></p>`,14),en={href:"https://github.com/go-sql-driver/mysql#interpolateparams",target:"_blank",rel:"noopener noreferrer"},on=e(`<h4 id="_8-10-3-sql-builder-with-preparedstmt" tabindex="-1"><a class="header-anchor" href="#_8-10-3-sql-builder-with-preparedstmt" aria-hidden="true">#</a> 8.10.3 SQL Builder with PreparedStmt</h4><p>Prepared Statement works with RAW SQL also, for example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>sqlite<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;gorm.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
  PrepareStmt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

db<span class="token punctuation">.</span><span class="token function">Raw</span><span class="token punctuation">(</span><span class="token string">&quot;select sum(age) from users where role = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>age<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3),pn={href:"https://gorm.io/docs/session.html",target:"_blank",rel:"noopener noreferrer"},cn={href:"https://gorm.io/docs/session.html",target:"_blank",rel:"noopener noreferrer"},un=e(`<h4 id="_8-10-4-select-fields" tabindex="-1"><a class="header-anchor" href="#_8-10-4-select-fields" aria-hidden="true">#</a> 8.10.4 Select Fields</h4><p>By default GORM select all fields when quering, you can use <code>Select</code> to specify fields you want</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>db.Select(&quot;Name&quot;, &quot;Age&quot;).Find(&amp;Users{})
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,3),ln={href:"https://gorm.io/docs/advanced_query.html",target:"_blank",rel:"noopener noreferrer"},rn=e(`<div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID     <span class="token builtin">uint</span>
  Name   <span class="token builtin">string</span>
  Age    <span class="token builtin">int</span>
  Gender <span class="token builtin">string</span>
  <span class="token comment">// hundreds of fields</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> APIUser <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID   <span class="token builtin">uint</span>
  Name <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// Select \`id\`, \`name\` automatically when query</span>
db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>APIUser<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// SELECT \`id\`, \`name\` FROM \`users\` LIMIT 10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-10-5-iteration-findinbatches" tabindex="-1"><a class="header-anchor" href="#_8-10-5-iteration-findinbatches" aria-hidden="true">#</a> 8.10.5 Iteration/FindInBatches</h4><p>Query and process records with iteration or in batches</p><h4 id="_8-10-6-index-hints" tabindex="-1"><a class="header-anchor" href="#_8-10-6-index-hints" aria-hidden="true">#</a> 8.10.6 Index Hints</h4>`,4),dn={href:"https://gorm.io/docs/indexes.html",target:"_blank",rel:"noopener noreferrer"},kn=s("code",null,"Index Hints",-1),mn=e('<div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token string">&quot;gorm.io/hints&quot;</span>\n\ndb<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>hints<span class="token punctuation">.</span><span class="token function">UseIndex</span><span class="token punctuation">(</span><span class="token string">&quot;idx_user_name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token comment">// SELECT * FROM `users` USE INDEX (`idx_user_name`)</span>\n\ndb<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>hints<span class="token punctuation">.</span><span class="token function">ForceIndex</span><span class="token punctuation">(</span><span class="token string">&quot;idx_user_name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;idx_user_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ForJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token comment">// SELECT * FROM `users` FORCE INDEX FOR JOIN (`idx_user_name`,`idx_user_id`)&quot;</span>\n\ndb<span class="token punctuation">.</span><span class="token function">Clauses</span><span class="token punctuation">(</span>\n  hints<span class="token punctuation">.</span><span class="token function">ForceIndex</span><span class="token punctuation">(</span><span class="token string">&quot;idx_user_name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;idx_user_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ForOrderBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  hints<span class="token punctuation">.</span><span class="token function">IgnoreIndex</span><span class="token punctuation">(</span><span class="token string">&quot;idx_user_name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ForGroupBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token comment">// SELECT * FROM `users` FORCE INDEX FOR ORDER BY (`idx_user_name`,`idx_user_id`) IGNORE INDEX FOR GROUP BY (`idx_user_name`)&quot;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-10-7-read-write-splitting" tabindex="-1"><a class="header-anchor" href="#_8-10-7-read-write-splitting" aria-hidden="true">#</a> 8.10.7 Read/Write Splitting</h4>',2),vn={href:"https://gorm.io/docs/dbresolver.html",target:"_blank",rel:"noopener noreferrer"},bn=s("h3",{id:"_8-11-customize-data-types",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_8-11-customize-data-types","aria-hidden":"true"},"#"),n(" 8.11 Customize Data Types")],-1),gn=s("p",null,"GORM provides few interfaces that allow users to define well-supported customized data types for GORM",-1),hn=s("h4",{id:"_8-11-1-scanner-valuer",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_8-11-1-scanner-valuer","aria-hidden":"true"},"#"),n(" 8.11.1 Scanner / Valuer")],-1),fn={href:"https://pkg.go.dev/database/sql#Scanner",target:"_blank",rel:"noopener noreferrer"},_n={href:"https://pkg.go.dev/database/sql/driver#Valuer",target:"_blank",rel:"noopener noreferrer"},qn=e(`<p>For example:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>type JSON json.RawMessage

// Scan scan value into Jsonb, implements sql.Scanner interface
func (j *JSON) Scan(value interface{}) error {
  bytes, ok := value.([]byte)
  if !ok {
    return errors.New(fmt.Sprint(&quot;Failed to unmarshal JSONB value:&quot;, value))
  }

  result := json.RawMessage{}
  err := json.Unmarshal(bytes, &amp;result)
  *j = JSON(result)
  return err
}

// Value return json value, implement driver.Valuer interface
func (j JSON) Value() (driver.Value, error) {
  if len(j) == 0 {
    return nil, nil
  }
  return json.RawMessage(j).MarshalJSON()
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>There are many third party packages implement the <code>Scanner</code>/<code>Valuer</code> interface, which can be used with GORM together, for example:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>import (
  &quot;github.com/google/uuid&quot;
  &quot;github.com/lib/pq&quot;
)

type Post struct {
  ID     uuid.UUID \`gorm:&quot;type:uuid;default:uuid_generate_v4()&quot;\`
  Title  string
  Tags   pq.StringArray \`gorm:&quot;type:text[]&quot;\`
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-11-2-gormdatatypeinterface" tabindex="-1"><a class="header-anchor" href="#_8-11-2-gormdatatypeinterface" aria-hidden="true">#</a> 8.11.2 GormDataTypeInterface</h4>`,5),xn={href:"https://gorm.io/docs/models.html#tags",target:"_blank",rel:"noopener noreferrer"},yn=s("code",null,"type",-1),wn=s("code",null,"GormDBDataTypeInterface",-1),Sn=s("code",null,"GormDataTypeInterface",-1),Cn=e(`<div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>type GormDataTypeInterface interface {
  GormDataType() string
}

type GormDBDataTypeInterface interface {
  GormDBDataType(*gorm.DB, *schema.Field) string
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),Dn=s("code",null,"GormDataType",-1),En=s("code",null,"schema.Field",-1),Tn=s("code",null,"DataType",-1),Mn={href:"https://gorm.io/docs/write_plugins.html",target:"_blank",rel:"noopener noreferrer"},Nn={href:"https://gorm.io/docs/hooks.html",target:"_blank",rel:"noopener noreferrer"},Rn=e(`<div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>func (JSON) GormDataType() string {
  return &quot;json&quot;
}

type User struct {
  Attrs JSON
}

func (user User) BeforeCreate(tx *gorm.DB) {
  field := tx.Statement.Schema.LookUpField(&quot;Attrs&quot;)
  if field.DataType == &quot;json&quot; {
    // do something
  }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>GormDBDataType</code> usually returns the right data type for current driver when migrating, for example:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>func (JSON) GormDBDataType(db *gorm.DB, field *schema.Field) string {
  // use field.Tag, field.TagSettings gets field&#39;s tags
  // checkout https://github.com/go-gorm/gorm/blob/master/schema/field.go for all options

  // returns different database type based on driver name
  switch db.Dialector.Name() {
  case &quot;mysql&quot;, &quot;sqlite&quot;:
    return &quot;JSON&quot;
  case &quot;postgres&quot;:
    return &quot;JSONB&quot;
  }
  return &quot;&quot;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>If the struct hasn’t implemented the <code>GormDBDataTypeInterface</code> or <code>GormDataTypeInterface</code> interface, GORM will guess its data type from the struct’s first field, for example, will use <code>string</code> for <code>NullString</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>type NullString struct {
  String string // use the first field&#39;s data type
  Valid  bool
}

type User struct {
  Name NullString // data type will be string
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-11-3-gormvaluerinterface" tabindex="-1"><a class="header-anchor" href="#_8-11-3-gormvaluerinterface" aria-hidden="true">#</a> 8.11.3 GormValuerInterface</h4><p>GORM provides a <code>GormValuerInterface</code> interface, which can allow to create/update from SQL Expr or value based on context, for example:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>// GORM Valuer interface
type GormValuerInterface interface {
  GormValue(ctx context.Context, db *gorm.DB) clause.Expr
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-11-4-create-update-from-sql-expr" tabindex="-1"><a class="header-anchor" href="#_8-11-4-create-update-from-sql-expr" aria-hidden="true">#</a> 8.11.4 Create/Update from SQL Expr</h4><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Location <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  X<span class="token punctuation">,</span> Y <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>loc Location<span class="token punctuation">)</span> <span class="token function">GormDataType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">&quot;geometry&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>loc Location<span class="token punctuation">)</span> <span class="token function">GormValue</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> clause<span class="token punctuation">.</span>Expr <span class="token punctuation">{</span>
  <span class="token keyword">return</span> clause<span class="token punctuation">.</span>Expr<span class="token punctuation">{</span>
    SQL<span class="token punctuation">:</span>  <span class="token string">&quot;ST_PointFromText(?)&quot;</span><span class="token punctuation">,</span>
    Vars<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;POINT(%d %d)&quot;</span><span class="token punctuation">,</span> loc<span class="token punctuation">.</span>X<span class="token punctuation">,</span> loc<span class="token punctuation">.</span>Y<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Scan implements the sql.Scanner interface</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>loc <span class="token operator">*</span>Location<span class="token punctuation">)</span> <span class="token function">Scan</span><span class="token punctuation">(</span>v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token comment">// Scan a value into struct from database driver</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID       <span class="token builtin">int</span>
  Name     <span class="token builtin">string</span>
  Location Location
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span>
  Name<span class="token punctuation">:</span>     <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span>
  Location<span class="token punctuation">:</span> Location<span class="token punctuation">{</span>X<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> Y<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// INSERT INTO \`users\` (\`name\`,\`point\`) VALUES (&quot;jinzhu&quot;,ST_PointFromText(&quot;POINT(100 100)&quot;))</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span>ID<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Updates</span><span class="token punctuation">(</span>User<span class="token punctuation">{</span>
  Name<span class="token punctuation">:</span>  <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span>
  Location<span class="token punctuation">:</span> Location<span class="token punctuation">{</span>X<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> Y<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// UPDATE \`user_with_points\` SET \`name\`=&quot;jinzhu&quot;,\`location\`=ST_PointFromText(&quot;POINT(100 100)&quot;) WHERE \`id\` = 1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,10),On={href:"https://gorm.io/docs/create.html#create_from_sql_expr",target:"_blank",rel:"noopener noreferrer"},Bn={href:"https://gorm.io/docs/update.html#update_from_sql_expr",target:"_blank",rel:"noopener noreferrer"},Un=e(`<h4 id="_8-11-5-value-based-on-context" tabindex="-1"><a class="header-anchor" href="#_8-11-5-value-based-on-context" aria-hidden="true">#</a> 8.11.5 Value based on Context</h4><p>If you want to create or update a value depends on current context, you can also implements the <code>GormValuerInterface</code> interface, for example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> EncryptedString <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  Value <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>es EncryptedString<span class="token punctuation">)</span> <span class="token function">GormValue</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span>expr clause<span class="token punctuation">.</span>Expr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> encryptionKey<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">&quot;TenantEncryptionKey&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
    <span class="token keyword">return</span> clause<span class="token punctuation">.</span>Expr<span class="token punctuation">{</span>SQL<span class="token punctuation">:</span> <span class="token string">&quot;?&quot;</span><span class="token punctuation">,</span> Vars<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token function">Encrypt</span><span class="token punctuation">(</span>es<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> encryptionKey<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">.</span><span class="token function">AddError</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;invalid encryption key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-11-6-clause-expression" tabindex="-1"><a class="header-anchor" href="#_8-11-6-clause-expression" aria-hidden="true">#</a> 8.11.6 Clause Expression</h4><p>If you want to build some query helpers, you can make a struct that implements the <code>clause.Expression</code> interface:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Expression <span class="token keyword">interface</span> <span class="token punctuation">{</span>
  <span class="token function">Build</span><span class="token punctuation">(</span>builder Builder<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,6),Ln={href:"https://github.com/go-gorm/datatypes/blob/master/json.go",target:"_blank",rel:"noopener noreferrer"},Fn={href:"https://gorm.io/docs/sql_builder.html#clauses",target:"_blank",rel:"noopener noreferrer"},In=e(`<div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Generates SQL with clause Expression</span>
db<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> datatypes<span class="token punctuation">.</span><span class="token function">JSONQuery</span><span class="token punctuation">(</span><span class="token string">&quot;attributes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasKey</span><span class="token punctuation">(</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> datatypes<span class="token punctuation">.</span><span class="token function">JSONQuery</span><span class="token punctuation">(</span><span class="token string">&quot;attributes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasKey</span><span class="token punctuation">(</span><span class="token string">&quot;orgs&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;orga&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// MySQL</span>
<span class="token comment">// SELECT * FROM \`users\` WHERE JSON_EXTRACT(\`attributes\`, &#39;$.role&#39;) IS NOT NULL</span>
<span class="token comment">// SELECT * FROM \`users\` WHERE JSON_EXTRACT(\`attributes\`, &#39;$.orgs.orga&#39;) IS NOT NULL</span>

<span class="token comment">// PostgreSQL</span>
<span class="token comment">// SELECT * FROM &quot;user&quot; WHERE &quot;attributes&quot;::jsonb ? &#39;role&#39;</span>
<span class="token comment">// SELECT * FROM &quot;user&quot; WHERE &quot;attributes&quot;::jsonb -&gt; &#39;orgs&#39; ? &#39;orga&#39;</span>

db<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> datatypes<span class="token punctuation">.</span><span class="token function">JSONQuery</span><span class="token punctuation">(</span><span class="token string">&quot;attributes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// MySQL</span>
<span class="token comment">// SELECT * FROM \`user\` WHERE JSON_EXTRACT(\`attributes\`, &#39;$.name&#39;) = &quot;jinzhu&quot;</span>

<span class="token comment">// PostgreSQL</span>
<span class="token comment">// SELECT * FROM &quot;user&quot; WHERE json_extract_path_text(&quot;attributes&quot;::json,&#39;name&#39;) = &#39;jinzhu&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-11-7-customized-data-types-collections" tabindex="-1"><a class="header-anchor" href="#_8-11-7-customized-data-types-collections" aria-hidden="true">#</a> 8.11.7 Customized Data Types Collections</h4>`,2),An={href:"https://github.com/go-gorm/datatypes",target:"_blank",rel:"noopener noreferrer"},Gn=e(`<h3 id="_8-12-scopes" tabindex="-1"><a class="header-anchor" href="#_8-12-scopes" aria-hidden="true">#</a> 8.12 Scopes</h3><p>Scopes allow you to re-use commonly used logic, the shared logic needs to be defined as type <code>func(*gorm.DB) *gorm.DB</code></p><h4 id="_8-12-1-query" tabindex="-1"><a class="header-anchor" href="#_8-12-1-query" aria-hidden="true">#</a> 8.12.1 Query</h4><p>Scope examples for querying</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">AmountGreaterThan1000</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;amount &gt; ?&quot;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">PaidWithCreditCard</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;pay_mode = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;card&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">PaidWithCod</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;pay_mode = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cod&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">OrderStatus</span><span class="token punctuation">(</span>status <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
    <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span>AmountGreaterThan1000<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;status IN (?)&quot;</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span>AmountGreaterThan1000<span class="token punctuation">,</span> PaidWithCreditCard<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>orders<span class="token punctuation">)</span>
<span class="token comment">// Find all credit card orders and amount greater than 1000</span>

db<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span>AmountGreaterThan1000<span class="token punctuation">,</span> PaidWithCod<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>orders<span class="token punctuation">)</span>
<span class="token comment">// Find all COD orders and amount greater than 1000</span>

db<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span>AmountGreaterThan1000<span class="token punctuation">,</span> <span class="token function">OrderStatus</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;paid&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;shipped&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>orders<span class="token punctuation">)</span>
<span class="token comment">// Find all paid, shipped orders that amount greater than 1000</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-12-2-pagination" tabindex="-1"><a class="header-anchor" href="#_8-12-2-pagination" aria-hidden="true">#</a> 8.12.2 Pagination</h4><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Paginate</span><span class="token punctuation">(</span>r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
    page<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">&quot;page&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> page <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
      page <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>

    pageSize<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">&quot;page_size&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">switch</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> pageSize <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">:</span>
      pageSize <span class="token operator">=</span> <span class="token number">100</span>
    <span class="token keyword">case</span> pageSize <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
      pageSize <span class="token operator">=</span> <span class="token number">10</span>
    <span class="token punctuation">}</span>

    offset <span class="token operator">:=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize
    <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span><span class="token function">Paginate</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span><span class="token function">Paginate</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>articles<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-12-3-dynamically-table" tabindex="-1"><a class="header-anchor" href="#_8-12-3-dynamically-table" aria-hidden="true">#</a> 8.12.3 Dynamically Table</h4><p>Use <code>Scopes</code> to dynamically set the query Table</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TableOfYear</span><span class="token punctuation">(</span>user <span class="token operator">*</span>User<span class="token punctuation">,</span> year <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
    tableName <span class="token operator">:=</span> user<span class="token punctuation">.</span><span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>year<span class="token punctuation">)</span>
    <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

DB<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span><span class="token function">TableOfYear</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token number">2019</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users_2019;</span>

DB<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span><span class="token function">TableOfYear</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token number">2020</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users_2020;</span>

<span class="token comment">// Table form different database</span>
<span class="token keyword">func</span> <span class="token function">TableOfOrg</span><span class="token punctuation">(</span>user <span class="token operator">*</span>User<span class="token punctuation">,</span> dbName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
    tableName <span class="token operator">:=</span> dbName <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

DB<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span><span class="token function">TableOfOrg</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token string">&quot;org1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM org1.users;</span>

DB<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span><span class="token function">TableOfOrg</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token string">&quot;org2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM org1.users;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-12-4-updates" tabindex="-1"><a class="header-anchor" href="#_8-12-4-updates" aria-hidden="true">#</a> 8.12.4 Updates</h4><p>Scope examples for updating/deleting</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">CurOrganization</span><span class="token punctuation">(</span>r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
    org <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">&quot;org&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> org <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> organization Organization
      <span class="token keyword">if</span> db<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Session<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>organization<span class="token punctuation">,</span> <span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> org<span class="token punctuation">)</span><span class="token punctuation">.</span>Error <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;org_id = ?&quot;</span><span class="token punctuation">,</span> organization<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    db<span class="token punctuation">.</span><span class="token function">AddError</span><span class="token punctuation">(</span><span class="token string">&quot;invalid organization&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> db
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>article<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span><span class="token function">CurOrganization</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name 1&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// UPDATE articles SET name = &quot;name 1&quot; WHERE org_id = 111</span>
db<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span><span class="token function">CurOrganization</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Article<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// DELETE FROM articles WHERE org_id = 111</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-13-conventions" tabindex="-1"><a class="header-anchor" href="#_8-13-conventions" aria-hidden="true">#</a> 8.13 Conventions</h3><h4 id="_8-13-1-id-as-primary-key" tabindex="-1"><a class="header-anchor" href="#_8-13-1-id-as-primary-key" aria-hidden="true">#</a> 8.13.1 <code>ID</code> as Primary Key</h4><p>GORM uses the field with the name <code>ID</code> as the tables’s primary key by default</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID   <span class="token builtin">string</span> <span class="token comment">// field named \`ID\` will be used as a primary field by default</span>
  Name <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>You can set other fields as primary key with tag <code>primaryKey</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Set field \`UUID\` as primary field</span>
<span class="token keyword">type</span> Animal <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ID     <span class="token builtin">int64</span>
  UUID   <span class="token builtin">string</span> <span class="token string">\`gorm:&quot;primaryKey&quot;\`</span>
  Name   <span class="token builtin">string</span>
  Age    <span class="token builtin">int64</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-13-2-pluralized-table-name" tabindex="-1"><a class="header-anchor" href="#_8-13-2-pluralized-table-name" aria-hidden="true">#</a> 8.13.2 Pluralized Table Name</h4><p>GORM pluralizes struct name to <code>snake_cases</code> as table name, for struct <code>User</code>, its table name is <code>users</code> by convention</p><p><strong>TableName</strong></p><p>You can change the default table name by implementing the <code>Tabler</code> interface</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Tabler <span class="token keyword">interface</span> <span class="token punctuation">{</span>
  <span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// TableName overrides the table name used by User to \`profiles\`</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>User<span class="token punctuation">)</span> <span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">&quot;profiles&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>NOTE</strong></p><p>TableName doesn’t allow dynamic name, its result will be cached for future, to use dynamic name, you can use Scopes</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">UserTable</span><span class="token punctuation">(</span>user User<span class="token punctuation">)</span> <span class="token keyword">func</span> <span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">func</span> <span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">{</span>
    <span class="token keyword">if</span> user<span class="token punctuation">.</span>Admin <span class="token punctuation">{</span>
      <span class="token keyword">return</span> tx<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;admin_users&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> tx<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span><span class="token function">Scopes</span><span class="token punctuation">(</span><span class="token function">UserTable</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Temporarily specify a name</strong></p><p>Temporarily specify table name with <code>Table</code> method, for example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Create table \`deleted_users\` with struct User&#39;s fields</span>
db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;deleted_users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Query data from another table</span>
<span class="token keyword">var</span> deletedUsers <span class="token punctuation">[</span><span class="token punctuation">]</span>User
db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;deleted_users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>deletedUsers<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM deleted_users;</span>

db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">&quot;deleted_users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">&quot;name = ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// DELETE FROM deleted_users WHERE name = &#39;jinzhu&#39;;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,30),zn={href:"https://gorm.io/docs/advanced_query.html#from_subquery",target:"_blank",rel:"noopener noreferrer"},Wn=s("p",null,[s("strong",null,"NamingStrategy")],-1),jn=s("code",null,"NamingStrategy",-1),Qn=s("code",null,"TableName",-1),Pn=s("code",null,"ColumnName",-1),Hn=s("code",null,"JoinTableName",-1),Vn=s("code",null,"RelationshipFKName",-1),Yn=s("code",null,"CheckerName",-1),Jn=s("code",null,"IndexName",-1),Kn={href:"https://gorm.io/docs/gorm_config.html#naming_strategy",target:"_blank",rel:"noopener noreferrer"},Xn=e('<h4 id="_8-13-3-column-name" tabindex="-1"><a class="header-anchor" href="#_8-13-3-column-name" aria-hidden="true">#</a> 8.13.3 Column Name</h4><p>Column name uses the field’s name’s <code>snake_case</code> by convention</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>\n  ID        <span class="token builtin">uint</span>      <span class="token comment">// column name is `id`</span>\n  Name      <span class="token builtin">string</span>    <span class="token comment">// column name is `name`</span>\n  Birthday  time<span class="token punctuation">.</span>Time <span class="token comment">// column name is `birthday`</span>\n  CreatedAt time<span class="token punctuation">.</span>Time <span class="token comment">// column name is `created_at`</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>',3),$n=s("code",null,"column",-1),Zn={href:"https://gorm.io/docs/conventions.html#naming_strategy",target:"_blank",rel:"noopener noreferrer"},ns=s("code",null,"NamingStrategy",-1),ss=e('<div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Animal <span class="token keyword">struct</span> <span class="token punctuation">{</span>\n  AnimalID <span class="token builtin">int64</span>     <span class="token string">`gorm:&quot;column:beast_id&quot;`</span>         <span class="token comment">// set name to `beast_id`</span>\n  Birthday time<span class="token punctuation">.</span>Time <span class="token string">`gorm:&quot;column:day_of_the_beast&quot;`</span> <span class="token comment">// set name to `day_of_the_beast`</span>\n  Age      <span class="token builtin">int64</span>     <span class="token string">`gorm:&quot;column:age_of_the_beast&quot;`</span> <span class="token comment">// set name to `age_of_the_beast`</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-13-4-timestamp-tracking" tabindex="-1"><a class="header-anchor" href="#_8-13-4-timestamp-tracking" aria-hidden="true">#</a> 8.13.4 Timestamp Tracking</h4><p><strong>CreatedAt</strong></p><p>For models having <code>CreatedAt</code> field, the field will be set to the current time when the record is first created if its value is zero</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span> <span class="token comment">// set `CreatedAt` to current time</span>\n\nuser2 <span class="token operator">:=</span> User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;jinzhu&quot;</span><span class="token punctuation">,</span> CreatedAt<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\ndb<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user2<span class="token punctuation">)</span> <span class="token comment">// user2&#39;s `CreatedAt` won&#39;t be changed</span>\n\n<span class="token comment">// To change its value, you could use `Update`</span>\ndb<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">&quot;CreatedAt&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>UpdatedAt</strong></p><p>For models having <code>UpdatedAt</code> field, the field will be set to the current time when the record is updated or created if its value is zero</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>db.Save(&amp;user) // set `UpdatedAt` to current time\n\ndb.Model(&amp;user).Update(&quot;name&quot;, &quot;jinzhu&quot;) // will set `UpdatedAt` to current time\n\ndb.Model(&amp;user).UpdateColumn(&quot;name&quot;, &quot;jinzhu&quot;) // `UpdatedAt` won&#39;t be changed\n\nuser2 := User{Name: &quot;jinzhu&quot;, UpdatedAt: time.Now()}\ndb.Create(&amp;user2) // user2&#39;s `UpdatedAt` won&#39;t be changed when creating\n\nuser3 := User{Name: &quot;jinzhu&quot;, UpdatedAt: time.Now()}\ndb.Save(&amp;user3) // user3&#39;s `UpdatedAt` will change to current time when updating\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>',8),as=s("strong",null,"NOTE",-1),ts={href:"https://gorm.io/docs/models.html#time_tracking",target:"_blank",rel:"noopener noreferrer"},es=e(`<h3 id="_8-14-settings" tabindex="-1"><a class="header-anchor" href="#_8-14-settings" aria-hidden="true">#</a> 8.14 Settings</h3><p>GORM provides <code>Set</code>,<code>Get</code>,<code>InstanceSet</code>,<code>InstanceGet</code> methods allow users pass values to hooks or other methods</p><p>GORM uses this for some features, like pass creating table options when migratinig table</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Add table suffix when creating tables</span>
db<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;gorm:table_options&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ENGINE=InnoDB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-14-1-set-get" tabindex="-1"><a class="header-anchor" href="#_8-14-1-set-get" aria-hidden="true">#</a> 8.14.1 Set/Get</h4><p>Use <code>Set</code> / <code>Get</code> pass settings to hooks methods, for example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  CreditCard CreditCard
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">BeforeCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  myValue<span class="token punctuation">,</span> ok <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;my_value&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">// ok =&gt; true</span>
  <span class="token comment">// myValue =&gt; 123</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CreditCard <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>card <span class="token operator">*</span>CreditCard<span class="token punctuation">)</span> <span class="token function">BeforeCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  myValue<span class="token punctuation">,</span> ok <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;my_value&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">// ok =&gt; true</span>
  <span class="token comment">// myValue =&gt; 123</span>
<span class="token punctuation">}</span>

myValue <span class="token operator">:=</span> <span class="token number">123</span>
db<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;my_value&quot;</span><span class="token punctuation">,</span> myValue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-14-2-instanceset-instanceget" tabindex="-1"><a class="header-anchor" href="#_8-14-2-instanceset-instanceget" aria-hidden="true">#</a> 8.14.2 InstanceSet/InstanceGet</h4><p>Use <code>InstanceSet</code> / <code>InstanceGet</code> pass settings to current <code>*Statement</code>‘s hooks methods, for example:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  CreditCard CreditCard
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">BeforeCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  myValue<span class="token punctuation">,</span> ok <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">InstanceGet</span><span class="token punctuation">(</span><span class="token string">&quot;my_value&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">// ok =&gt; true</span>
  <span class="token comment">// myValue =&gt; 123</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CreditCard <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  gorm<span class="token punctuation">.</span>Model
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// When creating associations, GORM creates a new \`*Statement\`, so can&#39;t read other instance&#39;s settings</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>card <span class="token operator">*</span>CreditCard<span class="token punctuation">)</span> <span class="token function">BeforeCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  myValue<span class="token punctuation">,</span> ok <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">InstanceGet</span><span class="token punctuation">(</span><span class="token string">&quot;my_value&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">// ok =&gt; false</span>
  <span class="token comment">// myValue =&gt; nil</span>
<span class="token punctuation">}</span>

myValue <span class="token operator">:=</span> <span class="token number">123</span>
db<span class="token punctuation">.</span><span class="token function">InstanceSet</span><span class="token punctuation">(</span><span class="token string">&quot;my_value&quot;</span><span class="token punctuation">,</span> myValue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="reference" tabindex="-1"><a class="header-anchor" href="#reference" aria-hidden="true">#</a> Reference</h2>`,11),os=s("li",null,[s("a",{href:"%5Bhttps://gorm.io%5D(https://gorm.io/)"},"gorm")],-1),ps={href:"https://github.com/go-gorm/gorm/issues/4218",target:"_blank",rel:"noopener noreferrer"},cs=s("code",null,"Find",-1),is=s("code",null,"Scan",-1),us=s("code",null,"Scan",-1),ls=s("code",null,"Find",-1),rs={href:"https://stackoverflow.com/questions/45953553/what-is-the-syntax-for-select-in-statement-for-sqlite",target:"_blank",rel:"noopener noreferrer"},ds={href:"https://www.sqlitetutorial.net/sqlite-full-outer-join/",target:"_blank",rel:"noopener noreferrer"};function ks(ms,vs){const a=i("ExternalLinkIcon");return p(),c("div",null,[l,s("blockquote",null,[s("p",null,[r,n(" Set "),d,n(" with "),k,n(" is goroutine-safe, refer "),s("a",m,[n("Session"),t(a)]),n(" for details")])]),v,s("p",null,[n("Logger accepts "),b,n(" too, you can use it for log tracking, refer "),s("a",g,[n("Logger"),t(a)]),n(" for details")]),h,f,s("p",null,[n("You are encouraged to do error check after any "),s("a",_,[n("Finisher Methods"),t(a)])]),q,s("p",null,[n("Here is "),s("a",x,[n("the full lists"),t(a)]),n(", also check out the "),s("a",y,[n("SQL Builder"),t(a)]),n(" for more details about "),w,n(".")]),S,s("p",null,[n("Check out "),s("a",C,[n("the full lists"),t(a)]),n(" here.")]),D,E,s("p",null,[n("GORM defined "),T,n(","),M,n(","),N,n(" methods as "),R,n(",refer "),s("a",O,[n("Session"),t(a)]),n(" for more details")]),B,s("p",null,[n("In example 2, the first query affected the second generated SQL, as GORM reused the "),U,n(". This might cause unexpected issues, refer to "),s("a",L,[n("Goroutine Safety"),t(a)]),n(" for how to avoid it.")]),F,s("p",null,[n("GORM will auto-save associations and its reference using "),s("a",I,[n("Upsert"),t(a)]),n(" when creating/updating a record. If you want to update associations’ data, you should use the "),A,n(" mode, for example:")]),G,s("p",null,[n("Checkout "),s("a",z,[n("Logger"),t(a)]),n(" for more details.")]),W,s("p",null,[n("GORM creates constraints when auto migrating or creating table, see "),s("a",j,[n("Constraints"),t(a)]),n(" or "),s("a",Q,[n("Database Indexes"),t(a)]),n(" for details")]),P,s("p",null,[n("Refer to "),s("a",H,[n("Generic Interface"),t(a)]),n(" for more details.")]),V,s("p",null,[n("GORM has a "),s("a",Y,[n("default logger implementation"),t(a)]),n(", it will print Slow SQL and happening errors by default")]),J,s("p",null,[n("Debug a single operation, change current operation’s log level to "),s("a",K,[n("logger.Info"),t(a)])]),X,s("p",null,[n("Refer to GORM’s "),s("a",$,[n("default logger"),t(a)]),n(" for how to define your own one")]),Z,s("p",null,[n("GORM provides the method "),nn,n(" which returns a generic database interface "),s("a",sn,[n("*sql.DB"),t(a)]),n(" from the current "),an]),tn,s("p",null,[n("Also refer how to enable interpolateparams for MySQL to reduce roundtrip "),s("a",en,[n("https://github.com/go-sql-driver/mysql#interpolateparams"),t(a)])]),on,s("p",null,[n("You can also use GORM API to prepare SQL with "),s("a",pn,[n("DryRun Mode"),t(a)]),n(", and execute it with prepared statement later, checkout "),s("a",cn,[n("Session Mode"),t(a)]),n(" for details")]),un,s("p",null,[n("Or define a smaller API struct to use the "),s("a",ln,[n("smart select fields feature"),t(a)])]),rn,s("p",null,[s("a",dn,[n("Index"),t(a)]),n(" is used to speed up data search and SQL query performance. "),kn,n(" gives the optimizer information about how to choose indexes during query processing, which gives the flexibility to choose a more efficient execution plan than the optimizer")]),mn,s("p",null,[n("Increase data throughput through read/write splitting, check out "),s("a",vn,[n("Database Resolver"),t(a)])]),bn,gn,hn,s("p",null,[n("The customized data type has to implement the "),s("a",fn,[n("Scanner"),t(a)]),n(" and "),s("a",_n,[n("Valuer"),t(a)]),n(" interfaces, so GORM knowns to how to receive/save it into the database")]),qn,s("p",null,[n("GORM will read column’s database type from "),s("a",xn,[n("tag"),t(a)]),n(),yn,n(", if not found, will check if the struct implemented interface "),wn,n(" or "),Sn,n(" and will use its result as data type")]),Cn,s("p",null,[n("The result of "),Dn,n(" will be used as the general data type and can be obtained from "),En,n("‘s field "),Tn,n(", which might be helpful when "),s("a",Mn,[n("writing plugins"),t(a)]),n(" or "),s("a",Nn,[n("hooks"),t(a)]),n(" for example:")]),Rn,s("p",null,[n("You can also create/update with SQL Expr from map, checkout "),s("a",On,[n("Create From SQL Expr"),t(a)]),n(" and "),s("a",Bn,[n("Update with SQL Expression"),t(a)]),n(" for details")]),Un,s("p",null,[n("Checkout "),s("a",Ln,[n("JSON"),t(a)]),n(" and "),s("a",Fn,[n("SQL Builder"),t(a)]),n(" for details, the following is an example of usage:")]),In,s("p",null,[n("We created a Github repo for customized data types collections "),s("a",An,[n("https://github.com/go-gorm/datatypes"),t(a)])]),Gn,s("p",null,[n("Check out "),s("a",zn,[n("From SubQuery"),t(a)]),n(" for how to use SubQuery in FROM clause")]),Wn,s("p",null,[n("GORM allows users change the default naming conventions by overriding the default "),jn,n(", which is used to build "),Qn,n(", "),Pn,n(", "),Hn,n(", "),Vn,n(", "),Yn,n(", "),Jn,n(", Check out "),s("a",Kn,[n("GORM Config"),t(a)]),n(" for details")]),Xn,s("p",null,[n("You can override the column name with tag "),$n,n(" or use "),s("a",Zn,[ns,t(a)])]),ss,s("p",null,[as,n(" GORM supports having multiple time tracking fields and track with UNIX (nano/milli) seconds, checkout "),s("a",ts,[n("Models"),t(a)]),n(" for more details")]),es,s("ol",null,[os,s("li",null,[s("a",ps,[n("What is the difference between "),cs,n(" and "),is,n("， Can I replace "),us,n(" with "),ls,n(" ？"),t(a)]),n(" grom issue")]),s("li",null,[s("a",rs,[n("What is the syntax for SELECT IN statement for SQLITE?"),t(a)]),n(" stackoverflow")]),s("li",null,[s("a",ds,[n("SQLite FULL OUTER JOIN Emulation"),t(a)]),n(" sqlitetutorial")])])])}const gs=o(u,[["render",ks],["__file","01.4.html.vue"]]);export{gs as default};
