import{_ as i,Y as c,Z as l,$ as n,a0 as s,a1 as a,a2 as t,F as o}from"./framework-d955655f.js";const u={},r=t('<h2 id="_1-跨域认证问题" tabindex="-1"><a class="header-anchor" href="#_1-跨域认证问题" aria-hidden="true">#</a> 1 跨域认证问题</h2><p>传统的 session 的认证流程如下:</p><ol><li>用户向服务器发送用户名和密码</li><li>服务器验证通过后,将相关信息保存至 session 中</li><li>服务器将 session ID 返回给客户端并存储至 cookie 中</li><li>用户请求时会附上 session ID,服务器会根据 session ID 来得知用户身份</li></ol><h3 id="_1-1-传统-session-认证的问题" tabindex="-1"><a class="header-anchor" href="#_1-1-传统-session-认证的问题" aria-hidden="true">#</a> 1.1 传统 session 认证的问题</h3><p><strong>Session</strong>: 每个用户经过服务认证之后,会将 session 信息保存至内存中,当用户的数量增加时服务器的负荷会增大</p><p><strong>扩展性(Scaling)</strong>: 在分布式系统中,用户需在保存其 session 信息的服务器中才可以获取授权,限制了应用的扩展能力</p><p><strong>CSRF:</strong> 因为是基于 cokkie 进行识别的,若 cokkie 被截获,用户容易受到跨站请求攻击</p><h3 id="_1-2-基于-token-的鉴权机制" tabindex="-1"><a class="header-anchor" href="#_1-2-基于-token-的鉴权机制" aria-hidden="true">#</a> 1.2 基于 Token 的鉴权机制</h3><p>基于 token 的认证和传统的 session 方式不同,token 信息存放在客户端而不是服务端</p><p>其认证流程如下:</p><ol><li>用户向服务器发送用户名和密码</li><li>服务器验证用户信息</li><li>验证通过后向用户签发 token</li><li>用户请求时附上 token,服务器验证 token 来进行授权</li></ol><p>token 在每次请求时发送给服务端,其应放在请求头中并要求服务端支持 CORS(跨域资源共享)</p><h2 id="_2-jwt" tabindex="-1"><a class="header-anchor" href="#_2-jwt" aria-hidden="true">#</a> 2. JWT</h2><h3 id="_2-1-what-is-json-web-token" tabindex="-1"><a class="header-anchor" href="#_2-1-what-is-json-web-token" aria-hidden="true">#</a> 2.1 What is JSON Web Token</h3>',14),d={href:"https://tools.ietf.org/html/rfc7519",target:"_blank",rel:"noopener noreferrer"},k=t(`<p>Although JWTs can be encrypted to also provide secrecy between parties, we will focus on <em>signed</em> tokens. Signedt tokens can verify the <em>integrity</em> of the claims contained within it, while encryted tokens <em>hide</em> those claimes from other parties. When tokens are signed usign pulic/private key pairs, the signature also certifies that only the party holding the private key is the one that signed it.</p><h3 id="_2-2-when-should-you-use-json-web-tokens" tabindex="-1"><a class="header-anchor" href="#_2-2-when-should-you-use-json-web-tokens" aria-hidden="true">#</a> 2.2 When should you use JSON Web Tokens</h3><p>Here are some scenarios where JSON Web Tokens are useful:</p><ul><li><strong>Authorization</strong>: This is the most common scenario for using JWT. Once the user is logged in, each subsequent request will include the JWT, allowing the user to access routes, services, and resources that are permitted with that token. Single Sign On is a feature that widely uses JWT nowadays, because of its samll overhead and its ability to be easily used across different domains.</li><li><strong>Information Exchange</strong>: JSON Web Tokens are a good way of securely transmitting information between parties. Because JWTs can be signed, for example, using pulic/private key pairs you can be sure the senders are who they say they are. Addtionally, as hte signature is calculated using the header and the payload, you can also verify that the content hasn’t been tampered with.</li></ul><h3 id="_2-3-what-is-the-json-web-token-structure" tabindex="-1"><a class="header-anchor" href="#_2-3-what-is-the-json-web-token-structure" aria-hidden="true">#</a> 2.3 What is the JSON Web Token structure</h3><p>In its compact form, JSON Web Tokens consist of three parts separated by dots <code>.</code>, which are :</p><ul><li>Header</li><li>Payload</li><li>Signature</li></ul><p>Therefore, a JWT typically looks like the following:</p><p><code>xxxx.yyyy.zzzz</code></p><h4 id="_2-3-1-header" tabindex="-1"><a class="header-anchor" href="#_2-3-1-header" aria-hidden="true">#</a> 2.3.1 Header</h4><p>The header typically consists of two prats: the type of the token, which is JWT, and the signing algorithm being usesd, such as HMAC SHA256 or RSA</p><div class="language-JSON line-numbers-mode" data-ext="JSON"><pre class="language-JSON"><code>{
  &quot;alg&quot;: &quot;HS256&quot;,
  &quot;typ&quot;: &quot;JWT&quot;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Then, this JSON is <strong>Base64Url</strong> encoded to form the first part of the JWT</p><h4 id="_2-3-2-payload" tabindex="-1"><a class="header-anchor" href="#_2-3-2-payload" aria-hidden="true">#</a> 2.3.2 Payload</h4><p>The second part of the token is the payload, which contains the claims. Claims are statements about an entity (typically, the user) and additional data. There are three types of claims: <em>registered</em>,<em>public</em>, and <em>private</em> claims</p>`,15),v=n("p",null,[n("strong",null,"Registered claims"),s(": These are a set of predefined claims which are not mandantory but recommended, to provide a set of useful, interoperable claims. Some of them are:")],-1),m=n("li",null,[n("strong",null,"iss"),s(": issuer")],-1),b=n("li",null,[n("strong",null,"exp"),s(": expiration time")],-1),g=n("li",null,[n("strong",null,"sub"),s(": subject")],-1),h=n("li",null,[n("strong",null,"aud"),s(": audience")],-1),f={href:"https://tools.ietf.org/html/rfc7519#section-4.1",target:"_blank",rel:"noopener noreferrer"},w=n("p",null,"Notice that the claim names are only three characters long as JWT is meant to be compact",-1),y=n("strong",null,"Public claims",-1),T={href:"https://www.iana.org/assignments/jwt/jwt.xhtml",target:"_blank",rel:"noopener noreferrer"},x=n("li",null,[n("p",null,[n("strong",null,"Private claims"),s(": These are the custom claims created to share informaion between parties that agree on using them and are neither "),n("em",null,"registered"),s(" or "),n("em",null,"public"),s(" claims")])],-1),q=t(`<p>An example payload could be :</p><div class="language-JSON line-numbers-mode" data-ext="JSON"><pre class="language-JSON"><code>{
  &quot;sub&quot;: &quot;1234567890&quot;,
  &quot;name&quot;: &quot;John Doe&quot;,
  &quot;admin&quot;: true
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The payload is then <strong>Base64Url</strong> encoded to form the second part of the JSON Web Token</p><p><strong>NOTE</strong></p><p>Do note that for signed tokens this information, though protected against tampering, is readable by anyone. Do not put secret information in the payload or header elements of a JWT unless it is encrypted.</p><h4 id="_2-3-3-signature" tabindex="-1"><a class="header-anchor" href="#_2-3-3-signature" aria-hidden="true">#</a> 2.3.3 Signature</h4><p>To create the signature part you have to take the encoded header, the encoded payload, a secret, the algorithm specified in the header, and sign that</p><p>For example if you want to use the HMAC SHA256 algorithm, the signature will be created in the following way:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>HMACSHA256(
  base64UrlEncode(header) + &quot;.&quot; +
  base64UrlEncode(payload),
  secret)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The signature is used to verify the message wasn’t changed along the way, and , in the case of tokens signed with a private key, it can also verify that the sender of the JWT is who it says it is.</p><h4 id="_2-3-4-putting-all-together" tabindex="-1"><a class="header-anchor" href="#_2-3-4-putting-all-together" aria-hidden="true">#</a> 2.3.4 Putting all together</h4><p>The output is three Base64-URL strings separated by dots that can be easily passed in HTML and HTTP environments, while being more compact when compared to XML-based standards such as SAML</p><p>The following shows a JWT that has the previous header and payload encoded, and it is singed with a secret</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVc2VybmFtZSI6Imtlc2EiLCJQYXNzd29yZCI6IjEyMyIsImlzcyI6Imtlc2EiLCJleHAiOjE2Mzg1MjE2OTl9.PECoPr7AxpmPFTdS8E-hn46xU5D065mklVGxODmYMiQ
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_2-4-how-do-json-web-tokens-work" tabindex="-1"><a class="header-anchor" href="#_2-4-how-do-json-web-tokens-work" aria-hidden="true">#</a> 2.4 How do JSON Web Tokens work</h3><p>In authentication, when the user successfully logs in using their credentials, a JSON Web Token will be returned. Since tokens are credentials, great care must be taken to prevent security issues. In general, you should not keep tokens longer than required.</p>`,16),_={href:"https://cheatsheetseries.owasp.org/cheatsheets/HTML5_Security_Cheat_Sheet.html#local-storage",target:"_blank",rel:"noopener noreferrer"},I=t(`<p>Whenever the user wants to access a protected route or resource, the user agent should send the JWT, typically in the <strong>Authorization</strong> header using the <strong>Bearer</strong> schema. The content of the header should look like the following:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Authorization: Bearer &lt;token&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>This can be, in certain cases, a stateless authorization mechanism. The server&#39;s protected routes will check for a valid JWT in the <code>Authorization</code> header, and if it&#39;s present, the user will be allowed to access protected resources. If the JWT contains the necessary data, the need to query the database for certain operations may be reduced, though this may not always be the case.</p><p>If the token is sent in the <code>Authorization</code> header, Cross-Origin Resource Sharing (CORS) won&#39;t be an issue as it doesn&#39;t use cookies.</p><p>The following diagram shows how a JWT is obtained and used to access APIs or resources:</p><figure><img src="https://raw.githubusercontent.com/dreamjz/pics/main/pics/2023/client-credentials-grant.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>`,6),S={href:"http://openid.net/connect/",target:"_blank",rel:"noopener noreferrer"},j=n("code",null,"/oauth/authorize",-1),E={href:"http://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth",target:"_blank",rel:"noopener noreferrer"},C=n("li",null,"When the authorization is granted, the authorization server returns an access token to the application.",-1),O=n("li",null,"The application uses the access token to access a protected resource (like an API).",-1),J=t('<p>Do note that with signed tokens, all the information contained within the token is exposed to users or other parties, even though they are unable to change it. This means you should not put secret information within the token.</p><p>###2.5 Why should we use JSON Web Tokens?</p><p>Let&#39;s talk about the benefits of <strong>JSON Web Tokens (JWT)</strong> when compared to <strong>Simple Web Tokens (SWT)</strong> and <strong>Security Assertion Markup Language Tokens (SAML)</strong>.</p><p>As JSON is less verbose than XML, when it is encoded its size is also smaller, making JWT more compact than SAML. This makes JWT a good choice to be passed in HTML and HTTP environments.</p><p>Security-wise, SWT can only be symmetrically signed by a shared secret using the HMAC algorithm. However, JWT and SAML tokens can use a public/private key pair in the form of a X.509 certificate for signing. Signing XML with XML Digital Signature without introducing obscure security holes is very difficult when compared to the simplicity of signing JSON.</p><p>JSON parsers are common in most programming languages because they map directly to objects. Conversely, XML doesn&#39;t have a natural document-to-object mapping. This makes it easier to work with JWT than SAML assertions.</p><p>Regarding usage, JWT is used at Internet scale. This highlights the ease of client-side processing of the JSON Web token on multiple platforms, especially mobile.</p><p><img src="https://raw.githubusercontent.com/dreamjz/pics/main/pics/2023/comparing-jwt-vs-saml2.png" alt="" loading="lazy"> <em>Comparison of the length of an encoded JWT and an encoded SAML</em></p><h2 id="_3-jwt-go" tabindex="-1"><a class="header-anchor" href="#_3-jwt-go" aria-hidden="true">#</a> 3. Jwt-go</h2><p>在了解完 JWT 及其使用场景之后，这里采用一个示例来具体实践下</p>',10),U={href:"https://github.com/dreamjz/golang-notes/tree/main/go-jwt",target:"_blank",rel:"noopener noreferrer"},R=t(`<p>下面的例子将创建一个 application 简单实现登录，接口权限验证功能</p><h3 id="_3-1-目录结构" tabindex="-1"><a class="header-anchor" href="#_3-1-目录结构" aria-hidden="true">#</a> 3.1 目录结构</h3><p>基于 go mod 初始化 application</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>go mod init go-jwt-note
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>创建如下目录</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>go-jwt
├── api
│   └── v1
├── initialize
├── middleware
├── routers
├── utils
├── global
├── go.mod
└── main.go
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>api/v1</code>: RESTFul API 接口，v1 为 version 1 ，也可以不用指定版本</li><li><code>initialize</code>: application 初始化，如 gin，redis 等</li><li><code>middleware</code>: 中间件</li><li><code>routers</code>: 路由</li><li><code>utils</code>: 工具包</li><li><code>global</code>: 全局变量</li><li><code>main.go</code>: application 入口</li></ul><h3 id="_3-2-login" tabindex="-1"><a class="header-anchor" href="#_3-2-login" aria-hidden="true">#</a> 3.2 Login</h3><p>首先创建 RESTFul API</p><p>引入 Gin Framework 和 endless (用于优雅启动应用)</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>go get <span class="token parameter variable">-u</span> github.com/gin-gonic/gin github.com/fvbock/endless
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在 <code>initilize</code> 下创建 <code>server.go</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    publicGroup <span class="token operator">:=</span> router<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
    routers<span class="token punctuation">.</span><span class="token function">InintializePulicGroup</span><span class="token punctuation">(</span>publicGroup<span class="token punctuation">)</span>
    server <span class="token operator">:=</span> endless<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token string">&quot;:9090&quot;</span><span class="token punctuation">,</span>router<span class="token punctuation">)</span>
    server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>publicGroup</code>: 公共路由组，无需鉴权</li><li><code>privateGroup</code>: 私有路由组，需要鉴权</li><li><code>InintializePulicGroup</code> : 初始化公共路由组，注册路由</li></ul><p>在 <code>api/v1</code> 下创建 <code>public.go</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Ping</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span><span class="token string">&quot;pong&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Login</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    name <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">PostForm</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span>
    pass <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">PostForm</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> name <span class="token operator">!=</span> <span class="token string">&quot;kesa&quot;</span> <span class="token operator">||</span> pass <span class="token operator">!=</span> <span class="token string">&quot;123&quot;</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span><span class="token string">&quot;please provide valid login details&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    token<span class="token punctuation">,</span>err <span class="token operator">:=</span> utils<span class="token punctuation">.</span><span class="token function">GenerateToken</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnprocessableEntity<span class="token punctuation">,</span><span class="token string">&quot;generate token error&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span>gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
        <span class="token string">&quot;token&quot;</span><span class="token punctuation">:</span> token<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上例流程如下：</p><ul><li>从 post form 中获取登录信息</li><li>验证登录信息是否正确，这里简单起见使用固定用户名和密码，一般会去持久层查询后验证</li><li>使用用户名和密码生成 jwt</li><li>将 jwt 返回给客户端</li></ul><p>引入 go-jwt , 用于生成和解析 jwt</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>go get <span class="token parameter variable">-u</span> github.com/golang-jwt/jwt/v4
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在 <code>utils</code> 下创建 <code>jwt.go</code>， 定义生成 jwt 的函数</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">const</span> <span class="token punctuation">(</span>
	secret <span class="token operator">=</span> <span class="token string">&quot;my-secret&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
    ErrGenerateToken <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;generate token error&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> UserClaims <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Username <span class="token builtin">string</span> <span class="token string">\`json:&quot;username&quot;\`</span>
    jwt<span class="token punctuation">.</span>RegisteredClaims
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">GenerateToken</span><span class="token punctuation">(</span>username <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span><span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    expireTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">15</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span>
    claims <span class="token operator">:=</span> UserClaims<span class="token punctuation">{</span>
        Username<span class="token punctuation">:</span> username<span class="token punctuation">,</span>
        RegisteredClaims<span class="token punctuation">:</span> jwt<span class="token punctuation">.</span>RegisteredClaims<span class="token punctuation">{</span>
            Issuer<span class="token punctuation">:</span> <span class="token string">&quot;jwt-demo&quot;</span><span class="token punctuation">,</span>
            ExpiresAt<span class="token punctuation">:</span> jwt<span class="token punctuation">.</span><span class="token function">NewNumericDate</span><span class="token punctuation">(</span>expireTime<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    token<span class="token punctuation">,</span>err <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">NewWithClaims</span><span class="token punctuation">(</span>jwt<span class="token punctuation">.</span>SingingMethodHS256<span class="token punctuation">,</span>claims<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SingedString</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Generate token failed for user: %s ,err: %s&quot;</span><span class="token punctuation">,</span>username<span class="token punctuation">,</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>ErrGenerateToken
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> token<span class="token punctuation">,</span><span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 <code>routers</code> 下创建 <code>public.go</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">InitializePublicGroup</span><span class="token punctuation">(</span>router <span class="token operator">*</span>gin<span class="token punctuation">.</span>RouterGroup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    publicRouter <span class="token operator">:=</span> router<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">&quot;/public&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        publicRouter<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/ping&quot;</span><span class="token punctuation">,</span>v1<span class="token punctuation">.</span>Ping<span class="token punctuation">)</span>
        publicRouter<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span>v1<span class="token punctuation">.</span>Login<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改 <code>main.go</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    initilize<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>目录结构如下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>go-jwt
├── api
│   └── v1
│       └── public.go
├── initialize
│   └── server.go
├── middleware
├── routers
│   └── public.go
├── utils
│   └── jwt.go
├── global
├── go.mod
├── go.sum
└── main.go
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Run and test</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token string">&#39;http://localhost:9090/public/ping&#39;</span>
pong
$ <span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token string">&#39;http://localhost:9090/public/login&#39;</span> <span class="token parameter variable">-d</span> <span class="token string">&#39;username=kesa&amp;&amp;password=123&#39;</span>
<span class="token punctuation">{</span><span class="token string">&quot;token&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVc2VybmFtZSI6Imtlc2EiLCJpc3MiOiJqd3QtZGVtbyIsImV4cCI6MTYzODY3ODMyM30.FSmWi3ew6QdhzB87TLXeZQVp9bAEBaIj_bdB6CN3XbQ&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,30),A={href:"https://jwt.io/",target:"_blank",rel:"noopener noreferrer"},M=t(`<h3 id="_3-3-loopholes" tabindex="-1"><a class="header-anchor" href="#_3-3-loopholes" aria-hidden="true">#</a> 3.3 Loopholes</h3><p>至此，我们已经实现了登录并返回 jwt 到客户端的功能，但是会有以下问题:</p><ul><li>生成的 jwt 只会在到达过期时间时才会生效，若用户登录之后在有效时间内登出，jwt 是不会马上失效的</li><li>jwt 会被攻击者劫持并利用，而用户在 jwt 失效之前无法进行处理</li><li>用户在 jwt 失效之后将需要重新登录，使得用户体验很差</li></ul><p>我们分两步来解决这些问题：</p><ul><li>使用持久层来保存 jwt ，这样可以使得我们可以在用户登出时主动使 jwt 失效，并且能够提高安全性</li><li>使用 refresh token 来重新生成 access token ,在 access token 失效后自动生成以提高用户体验 只有在 refresh token 失效时用户才需要重新登录</li></ul><h3 id="_3-4-using-redis" tabindex="-1"><a class="header-anchor" href="#_3-4-using-redis" aria-hidden="true">#</a> 3.4 Using redis</h3><p>这里推荐使用 redis 作为持久层来保存 jwt，因为 jwt 拥有失效时间的特性，而 redis 可以设置 key 的失效时间，可以在 jwt 失效时将其删除， 并且 redis 读写性能较高适合用于保存 jwt</p><p>因为 redis 以 key-value 形式存储数据， key 必须是唯一的，这里我们使用 UUID 来作为 key</p><p>引入 redis-go 和 uuid</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>go get <span class="token parameter variable">-u</span> github.com/google/uuid github.com/go-redis/redis/v8
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在 <code>global</code> 下创建 <code>global.go</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> <span class="token punctuation">(</span>
	RedisDB <span class="token operator">*</span>redis<span class="token punctuation">.</span>Client
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 <code>initilize</code> 下创建 <code>redis.go</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rdb <span class="token operator">:=</span> redis<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>redis<span class="token punctuation">.</span>Options<span class="token punctuation">{</span>
		Addr<span class="token punctuation">:</span>     <span class="token string">&quot;localhost:6379&quot;</span><span class="token punctuation">,</span>
		Password<span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
		DB<span class="token punctuation">:</span>       <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Ping</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span><span class="token string">&quot;failed to connect redis: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Connect redis success&quot;</span><span class="token punctuation">)</span>
    global<span class="token punctuation">.</span>RedisDB <span class="token operator">=</span> rdb
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 <code>utils/jwt</code> 中定义新的 <code>struct</code> 包含 access token 和 refresh token 及其 失效时间</p><p>重写 <code>GenerateToken</code> 函数</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> tokenDetails <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	AccessToken  <span class="token builtin">string</span>
	RefreshToken <span class="token builtin">string</span>
	AccessUUID   <span class="token builtin">string</span>
	RefreshUUID  <span class="token builtin">string</span>
	<span class="token comment">// access token expires time</span>
	AtExpires time<span class="token punctuation">.</span>Time
	<span class="token comment">// refresh token expires time</span>
	RtExpires time<span class="token punctuation">.</span>Time
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">GenerateToken</span><span class="token punctuation">(</span>username <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>tokenDetails<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rtExpiresTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">7</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span>
	atExpireTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">15</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span>
	atUUID <span class="token operator">:=</span> uuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	rtUUID <span class="token operator">:=</span> uuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	accessToken<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">createToken</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token string">&quot;access&quot;</span><span class="token punctuation">,</span> atUUID<span class="token punctuation">,</span> atExpireTime<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ErrGenerateToken
	<span class="token punctuation">}</span>
	refreshToken<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">createToken</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token string">&quot;refresh&quot;</span><span class="token punctuation">,</span> rtUUID<span class="token punctuation">,</span> rtExpiresTime<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ErrGenerateToken
	<span class="token punctuation">}</span>
	td <span class="token operator">:=</span> <span class="token operator">&amp;</span>tokenDetails<span class="token punctuation">{</span>
		AccessToken<span class="token punctuation">:</span>  accessToken<span class="token punctuation">,</span>
		RefreshToken<span class="token punctuation">:</span> refreshToken<span class="token punctuation">,</span>
		AccessUUID<span class="token punctuation">:</span>   atUUID<span class="token punctuation">,</span>
		RefreshUUID<span class="token punctuation">:</span>  rtUUID<span class="token punctuation">,</span>
		AtExpires<span class="token punctuation">:</span>    atExpireTime<span class="token punctuation">,</span>
		RtExpires<span class="token punctuation">:</span>    rtExpiresTime<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> td<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">createToken</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> tokenType<span class="token punctuation">,</span> tokenUUID <span class="token builtin">string</span><span class="token punctuation">,</span> expiresTime time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	claims <span class="token operator">:=</span> UserClaims<span class="token punctuation">{</span>
		Username<span class="token punctuation">:</span>  username<span class="token punctuation">,</span>
		UUID<span class="token punctuation">:</span>      tokenUUID<span class="token punctuation">,</span>
		TokenType<span class="token punctuation">:</span> tokenType<span class="token punctuation">,</span>
		RegisteredClaims<span class="token punctuation">:</span> jwt<span class="token punctuation">.</span>RegisteredClaims<span class="token punctuation">{</span>
			Issuer<span class="token punctuation">:</span>    <span class="token string">&quot;jwt-demo&quot;</span><span class="token punctuation">,</span>
			ExpiresAt<span class="token punctuation">:</span> jwt<span class="token punctuation">.</span><span class="token function">NewNumericDate</span><span class="token punctuation">(</span>expiresTime<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	token<span class="token punctuation">,</span> err <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">NewWithClaims</span><span class="token punctuation">(</span>jwt<span class="token punctuation">.</span>SigningMethodHS256<span class="token punctuation">,</span> claims<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SignedString</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Generate token for user: %s, err: %s&quot;</span><span class="token punctuation">,</span> username<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> token<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述函数分别生成了 access token 和 refresh token 并将 access token 超市设为 15 分钟， refresh token 超时设为 7 天</p><p>创建 <code>utils/redis.go</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	ErrSaveToken <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;save token error&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">SaveUserTokens</span><span class="token punctuation">(</span>username <span class="token builtin">string</span><span class="token punctuation">,</span> td <span class="token operator">*</span>tokenDetails<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	rdb <span class="token operator">:=</span> global<span class="token punctuation">.</span>RedisDB
	now <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	atExp <span class="token operator">:=</span> td<span class="token punctuation">.</span>AtExpires<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span>
	rtExp <span class="token operator">:=</span> td<span class="token punctuation">.</span>RtExpires<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span>

	err <span class="token operator">:=</span> rdb<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> td<span class="token punctuation">.</span>AccessUUID<span class="token punctuation">,</span> username<span class="token punctuation">,</span> atExp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Save access token failed: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ErrSaveToken
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> rdb<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> td<span class="token punctuation">.</span>RefreshUUID<span class="token punctuation">,</span> username<span class="token punctuation">,</span> rtExp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Save refresh token failed: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ErrSaveToken
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将 token 对应的 UUID 作为 key， username 作为 value (一般使用 user ID 这里简单使用 username)，超时时间作为 key 的过期时间， 过期后将删除</p><p>修改 <code>api/v1/public</code> 的 <code>Login</code> 函数</p><p>新增 <code>UserTokens</code> 结构体</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> UserTokens <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	AccessToken  <span class="token builtin">string</span> <span class="token string">\`json:&quot;accessToken&quot;\`</span>
	RefreshToken <span class="token builtin">string</span> <span class="token string">\`json:&quot;refreshToken&quot;\`</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Login</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	name <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">PostForm</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span>
	pass <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">PostForm</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> name <span class="token operator">!=</span> <span class="token string">&quot;kesa&quot;</span> <span class="token operator">||</span> pass <span class="token operator">!=</span> <span class="token string">&quot;123&quot;</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span> <span class="token string">&quot;please provide valid login details&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	td<span class="token punctuation">,</span> err <span class="token operator">:=</span> utils<span class="token punctuation">.</span><span class="token function">GenerateToken</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnprocessableEntity<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">SaveUserTokens</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> td<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnprocessableEntity<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	tokens <span class="token operator">:=</span> UserTokens<span class="token punctuation">{</span>
		AccessToken<span class="token punctuation">:</span>  td<span class="token punctuation">.</span>AccessToken<span class="token punctuation">,</span>
		RefreshToken<span class="token punctuation">:</span> td<span class="token punctuation">.</span>RefreshToken<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> tokens<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Login</code> 函数获取 access token 和 refresh token 相关信息后存储至 redis 中，并将两个 token 返回给客户端</p><p>Run and test</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token string">&#39;http://localhost:9090/public/login&#39;</span> <span class="token parameter variable">-d</span> <span class="token string">&#39;username=kesa&amp;&amp;password=123&#39;</span>
<span class="token punctuation">{</span><span class="token string">&quot;accessToken&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Imtlc2EiLCJ1dWlkIjoiN2ZlOTk5MjktNzcyZi00NjcwLWIxYTAtNjM3YjdiNzQxMTAzIiwidHlwZSI6ImFjY2VzcyIsImlzcyI6Imp3dC1kZW1vIiwiZXhwIjoxNjM4Njg4MDkzfQ.KYchLZsv46c2EX0OS_WBqs5vHHArGa716Rn1WFQM2q4&quot;</span>,<span class="token string">&quot;refreshToken&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Imtlc2EiLCJ1dWlkIjoiYjVhMjVmMjctMzllZC00NTAyLTg2YWUtZTY5OWIyZmYyNWJkIiwidHlwZSI6InJlZnJlc2giLCJpc3MiOiJqd3QtZGVtbyIsImV4cCI6MTYzOTI5MTk5M30.FQhlMVj7ZjAqZek2cIXET6zjttWdfxPOtkGH6XmfLjQ&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>当前目录结构</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>go-jwt
├── api
│   └── v1
│       └── public.go
├── global
│   └── global.go
├── initialize
│   ├── redis.go
│   └── server.go
├── middleware
├── routers
│   └── public.go
├── utils
│   ├── jwt.go
│   └── redis.go
├── go.mod
├── go.sum
└── main.go
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，已经完成了登录获取 token 的流程，接下来将通过自定中间件来实现路由验证</p><h3 id="_3-5-verify-token" tabindex="-1"><a class="header-anchor" href="#_3-5-verify-token" aria-hidden="true">#</a> 3.5 Verify Token</h3><p>服务器已经将生成 token 返回给了客户端，而客户端将会在 request Headers 的 <code>Authorization</code> 附上验证用的 token 来验证</p><p><code>utils/redis.go</code> 新增获取用户信息（本例中只有用户名）</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> <span class="token punctuation">(</span>
	ErrSaveToken  <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;save token error&quot;</span><span class="token punctuation">)</span>
	ErrFetchToken <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;fetch token error&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>


<span class="token keyword">func</span> <span class="token function">FetchAuth</span><span class="token punctuation">(</span>details <span class="token operator">*</span>AuthDetails<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	username<span class="token punctuation">,</span> err <span class="token operator">:=</span> global<span class="token punctuation">.</span>RedisDB<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> details<span class="token punctuation">.</span>UUID<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Get token failed: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> ErrFetchToken
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> username<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>利用 token 对应的 UUID 来获取用户信息</p><p><code>utils/jwt.go</code>中新增 token 解析和验证</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ParseToken</span><span class="token punctuation">(</span>token <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	tokenClaims<span class="token punctuation">,</span> err <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">ParseWithClaims</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token operator">&amp;</span>UserClaims<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>token <span class="token operator">*</span>jwt<span class="token punctuation">.</span>Token<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Parse token failed: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> ErrParseToken
	<span class="token punctuation">}</span>

	claims<span class="token punctuation">,</span> ok <span class="token operator">:=</span> tokenClaims<span class="token punctuation">.</span>Claims<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>UserClaims<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> ErrParseToken
	<span class="token punctuation">}</span>
	username<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">FetchAuth</span><span class="token punctuation">(</span>claims<span class="token punctuation">.</span>UUID<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> username<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建 <code>middleware/jwt.go</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Jwt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> gin<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		token <span class="token operator">:=</span> utils<span class="token punctuation">.</span><span class="token function">ExtractToken</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Token: &quot;</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span>
		userClaims<span class="token punctuation">,</span> err <span class="token operator">:=</span> utils<span class="token punctuation">.</span><span class="token function">ParseToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusForbidden<span class="token punctuation">,</span> <span class="token string">&quot;unauthorized&quot;</span><span class="token punctuation">)</span>
			c<span class="token punctuation">.</span><span class="token function">Abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		err <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">FetchAuth</span><span class="token punctuation">(</span>userClaims<span class="token punctuation">.</span>UUID<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusForbidden<span class="token punctuation">,</span> <span class="token string">&quot;unauthorized&quot;</span><span class="token punctuation">)</span>
			c<span class="token punctuation">.</span><span class="token function">Abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;userClaims&quot;</span><span class="token punctuation">,</span> userClaims<span class="token punctuation">)</span>
		c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>c.Set(&quot;username&quot;, username)</code>: 设置变量交由下游路由处理</li></ul><p><code>utils/jwt.go</code> 新增提取 token</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ExtractToken</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	authHeader <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">GetHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">)</span>
	token <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">TrimPrefix</span><span class="token punctuation">(</span>authHeader<span class="token punctuation">,</span> <span class="token string">&quot;Bearer &quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> token
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>api/v1/user.go</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Welcome</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	userClaims<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">MustGet</span><span class="token punctuation">(</span><span class="token string">&quot;userClaims&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>utils<span class="token punctuation">.</span>UserClaims<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">&quot;Welcome ! %s&quot;</span><span class="token punctuation">,</span> userClaims<span class="token punctuation">.</span>Username<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>router/user.go</code> 注册路由</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">InitializeUserRouter</span><span class="token punctuation">(</span>router <span class="token operator">*</span>gin<span class="token punctuation">.</span>RouterGroup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	userRouter <span class="token operator">:=</span> router<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">&quot;/user&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		userRouter<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/welcome&quot;</span><span class="token punctuation">,</span> v1<span class="token punctuation">.</span>Welcome<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>initilize/server.go</code>创建私有路由组，使用中间件</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// public router</span>
	publicGroup <span class="token operator">:=</span> router<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
	routers<span class="token punctuation">.</span><span class="token function">InitializePublicGroup</span><span class="token punctuation">(</span>publicGroup<span class="token punctuation">)</span>
	<span class="token comment">// private router, needs authorization</span>
	privateGroup <span class="token operator">:=</span> router<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
	privateGroup<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>middleware<span class="token punctuation">.</span><span class="token function">Jwt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	routers<span class="token punctuation">.</span><span class="token function">InitializeUserRouter</span><span class="token punctuation">(</span>privateGroup<span class="token punctuation">)</span>
	server <span class="token operator">:=</span> endless<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token string">&quot;:9090&quot;</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Start server failed: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当前目录结构</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>go-jwt
├── api
│   └── v1
│       ├── public.go
│       └── user.go
├── global
│   └── global.go
├── initialize
│   ├── redis.go
│   └── server.go
├── middleware
│   └── jwt.go
├── routers
│   ├── public.go
│   └── user.go
├── utils
│   ├── jwt.go
│   └── redis.go
├── go.mod
├── go.sum
└── main.go
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Run and test</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token parameter variable">-d</span> <span class="token string">&#39;username=kesa&amp;&amp;password=123&#39;</span> <span class="token string">&#39;http://localhost:9090/public/login&#39;</span>
<span class="token punctuation">{</span><span class="token string">&quot;accessToken&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Imtlc2EiLCJ1dWlkIjoiMzY5ZWE1OGYtMjYzYS00M2FmLTlkMTItNmUzMGM2MWM5YzdmIiwidHlwZSI6ImFjY2VzcyIsImlzcyI6Imp3dC1kZW1vIiwiZXhwIjoxNjM4Njk0ODE0fQ.KnRmoZYZV2QlbMSSXdaTRLVSml4tULCwmQ9bHrlDIR8&quot;</span>,<span class="token string">&quot;refreshToken&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Imtlc2EiLCJ1dWlkIjoiNjVlNGJhYzItMDM4My00NGY3LWE5ODMtNjQ2ZjNlZDVjOWM2IiwidHlwZSI6InJlZnJlc2giLCJpc3MiOiJqd3QtZGVtbyIsImV4cCI6MTYzODY5NTA1NH0.7hY1hj3zsYOX4fvI8OtRsQa2tPl4PzADaLyM9vnYMpc&quot;</span><span class="token punctuation">}</span>
$ <span class="token function">curl</span> <span class="token string">&#39;http://localhost:9090/user/welcome&#39;</span> <span class="token parameter variable">-H</span> <span class="token string">&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Imtlc2EiLCJ1dWlkIjoiMzY5ZWE1OGYtMjYzYS00M2FmLTlkMTItNmUzMGM2MWM5YzdmIiwidHlwZSI6ImFjY2VzcyIsImlzcyI6Imp3dC1kZW1vIiwiZXhwIjoxNjM4Njk0ODE0fQ.KnRmoZYZV2QlbMSSXdaTRLVSml4tULCwmQ9bHrlDIR8&#39;</span>
Welcome <span class="token operator">!</span> kesa
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-6-logout" tabindex="-1"><a class="header-anchor" href="#_3-6-logout" aria-hidden="true">#</a> 3.6 Logout</h3><p>前面我们已经实现了登录获取 jwt 并且将其用于鉴权路由，接下来实现用户登出的功能</p><p><code>utils/redis.go</code>,定义函数删除保存的用户 access token</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">RemoveAuth</span><span class="token punctuation">(</span>tokenUUID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	deleted<span class="token punctuation">,</span> err <span class="token operator">:=</span> global<span class="token punctuation">.</span>RedisDB<span class="token punctuation">.</span><span class="token function">Del</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> tokenUUID<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Remove token failed: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> ErrRemoveToken
	<span class="token punctuation">}</span>
	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d keys deleted&quot;</span><span class="token punctuation">,</span> deleted<span class="token punctuation">)</span>
	<span class="token keyword">return</span> deleted<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>api/v1/user.go</code> 新增 Logout</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Logout</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	userClaims<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">MustGet</span><span class="token punctuation">(</span><span class="token string">&quot;userClaims&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>utils<span class="token punctuation">.</span>UserClaims<span class="token punctuation">)</span>
	deleted<span class="token punctuation">,</span> err <span class="token operator">:=</span> utils<span class="token punctuation">.</span><span class="token function">RemoveAuth</span><span class="token punctuation">(</span>userClaims<span class="token punctuation">.</span>UUID<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> deleted <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span> <span class="token string">&quot;unauthorized&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">&quot;Logout success&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>routers/user.go</code> 注册路由</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>		userRouter<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/logout&quot;</span><span class="token punctuation">,</span> v1<span class="token punctuation">.</span>Logout<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_3-7-refreshing-token" tabindex="-1"><a class="header-anchor" href="#_3-7-refreshing-token" aria-hidden="true">#</a> 3.7 Refreshing token</h3><p>至此我们已经完成了 access token 的生成和使用以及用户的登出，但是用户在登出后手动登录或者在 access token 失效后需要用户手动进行登录，为了提升用户体验我们可以使用 refresh token 来实现自动登录</p><p><code>api/v1/public.go</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">RefreshToken</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	token <span class="token operator">:=</span> utils<span class="token punctuation">.</span><span class="token function">ExtractToken</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	userClaims<span class="token punctuation">,</span> err <span class="token operator">:=</span> utils<span class="token punctuation">.</span><span class="token function">ParseToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">FetchAuth</span><span class="token punctuation">(</span>userClaims<span class="token punctuation">.</span>UUID<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// refresh token valid</span>
	<span class="token comment">// delete previous refresh token</span>
	name <span class="token operator">:=</span> userClaims<span class="token punctuation">.</span>Username
	deleted<span class="token punctuation">,</span> err <span class="token operator">:=</span> utils<span class="token punctuation">.</span><span class="token function">RemoveAuth</span><span class="token punctuation">(</span>userClaims<span class="token punctuation">.</span>UUID<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> deleted <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// generate new access token and refresh token</span>
	td<span class="token punctuation">,</span> err <span class="token operator">:=</span> utils<span class="token punctuation">.</span><span class="token function">GenerateToken</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnprocessableEntity<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">SaveUserTokens</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> td<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnprocessableEntity<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	tokens <span class="token operator">:=</span> UserTokens<span class="token punctuation">{</span>
		AccessToken<span class="token punctuation">:</span>  td<span class="token punctuation">.</span>AccessToken<span class="token punctuation">,</span>
		RefreshToken<span class="token punctuation">:</span> td<span class="token punctuation">.</span>RefreshToken<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> tokens<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>流程如下</p><ul><li>判断 refresh token 是否有效，失效则无法刷新，需要用户重新登录</li><li>删除之前的 refresh token</li><li>重新生成新的 access token 和 refresh token</li></ul><p><code>routers/public.go</code> 注册路由</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>		publicRouter<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/refresh&quot;</span><span class="token punctuation">,</span> v1<span class="token punctuation">.</span>RefreshToken<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>至此，我们的 go-jwt 的示例应用就完成了</p><p>这里以调用<code>user/welcome</code> 接口整理以下流程图</p>`,70),N=t(`<h2 id="_4-deploy-to-docker" tabindex="-1"><a class="header-anchor" href="#_4-deploy-to-docker" aria-hidden="true">#</a> 4. Deploy to Docker</h2><p>完成 application 之后将其部署至 docker</p><p>在编写 DockerFile 之前先看下 golang 镜像的大小</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>golang                     alpine         6f9d081b1170   36 hours ago   315MB
golang                     latest         d939cc1fb139   4 weeks ago    941MB
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>官方镜像接近 1GiB, 而 alpine 也有 315MB，对 golang application 来说不需要这么大的镜像（这些镜像包含各种编译环境和库）</p>`,5),z={href:"https://github.com/GoogleContainerTools",target:"_blank",rel:"noopener noreferrer"},G={href:"https://github.com/GoogleContainerTools/distroless",target:"_blank",rel:"noopener noreferrer"},D={href:"https://github.com/GoogleContainerTools/distroless",target:"_blank",rel:"noopener noreferrer"},W=t(`<p>下面是两种镜像的介绍</p><blockquote><p>Documentation for <code>gcr.io/distroless/base</code> and <code>gcr.io/distroless/static</code></p><h2 id="image-contents" tabindex="-1"><a class="header-anchor" href="#image-contents" aria-hidden="true">#</a> Image Contents</h2><p>This image contains a minimal Linux, glibc-based system. It is intended for use directly by &quot;mostly-statically compiled&quot; languages like Go, Rust or D.</p><p>Statically compiled applications (Go) that do not require libc can use the <code>gcr.io/distroless/static</code> image, which contains:</p><ul><li>ca-certificates</li><li>A /etc/passwd entry for a root user</li><li>A /tmp directory</li><li>tzdata</li></ul><p>Most other applications (and Go apps that require libc/cgo) should start with <code>gcr.io/distroless/base</code>, which contains all of the packages in <code>gcr.io/distroless/static</code>, and</p><ul><li>glibc</li><li>libssl</li><li>openssl</li></ul><h2 id="usage" tabindex="-1"><a class="header-anchor" href="#usage" aria-hidden="true">#</a> Usage</h2><p>Users are expected to include their compiled application and set the correct cmd in their image.</p></blockquote><h3 id="_4-1-proxy" tabindex="-1"><a class="header-anchor" href="#_4-1-proxy" aria-hidden="true">#</a> 4.1 Proxy</h3><p>因为 <code>gcr.io</code> 属于 Google 服务，之前配置的网易镜像适用于 <code>dockerhub</code></p><p>这里直接配置 docker 代理</p><ol><li><p>Create a systemd drop-in directory for the docker service:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>$ sudo mkdir -p /etc/systemd/system/docker.service.d
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>Create a file named <code>/etc/systemd/system/docker.service.d/http-proxy.conf</code> that adds the <code>HTTP_PROXY</code> environment variable:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>[Service]
Environment=&quot;HTTP_PROXY=http://proxy.example.com:80&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>If you are behind an HTTPS proxy server, set the <code>HTTPS_PROXY</code> environment variable:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>[Service]
Environment=&quot;HTTPS_PROXY=https://proxy.example.com:443&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>Multiple environment variables can be set; to set both a non-HTTPS and a HTTPs proxy;</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>[Service]
Environment=&quot;HTTP_PROXY=http://proxy.example.com:80&quot;
Environment=&quot;HTTPS_PROXY=https://proxy.example.com:443&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>Flush changes and restart Docker</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>$ sudo systemctl daemon-reload
$ sudo systemctl restart docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>Verify that the configuration has been loaded and matches the changes you made, for example:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>$ sudo systemctl show --property=Environment docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ol><p>上述配置是针对 docker 本身的网络代理，下面配置针对容器的网络代理</p><p>创建 <code>~/.docker/config.json</code></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;default&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;proxies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;httpProxy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://127.0.0.1:7890&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;httpsProxy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://127.0.0.1:7890&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动容器并查看环境变量</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> run <span class="token parameter variable">-it</span> centos /bin/bash
<span class="token punctuation">[</span>root@44baac59b55d /<span class="token punctuation">]</span><span class="token comment"># env</span>
<span class="token assign-left variable">HTTP_PROXY</span><span class="token operator">=</span>http://127.0.0.1:7890
<span class="token assign-left variable">https_proxy</span><span class="token operator">=</span>http://127.0.0.1:7890
<span class="token assign-left variable">http_proxy</span><span class="token operator">=</span>http://127.0.0.1:7890
<span class="token assign-left variable">HTTPS_PROXY</span><span class="token operator">=</span>http://127.0.0.1:7890
<span class="token punctuation">[</span>root@44baac59b55d /<span class="token punctuation">]</span><span class="token comment"># curl google.com</span>
<span class="token comment"># no response</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但是直接启动容器是无法使用 host 的网络代理，因为 docker 默认为桥接模式，需要使用<code>--network host</code>来使用 host 网络</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">--network</span> <span class="token function">host</span> centos /bin/bash
<span class="token punctuation">[</span>root@kesa-PC /<span class="token punctuation">]</span><span class="token comment"># curl google.com</span>
<span class="token operator">&lt;</span>HTML<span class="token operator">&gt;</span><span class="token operator">&lt;</span>HEAD<span class="token operator">&gt;</span><span class="token operator">&lt;</span>meta http-equiv<span class="token operator">=</span><span class="token string">&quot;content-type&quot;</span> <span class="token assign-left variable">content</span><span class="token operator">=</span><span class="token string">&quot;text/html;charset=utf-8&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>TITLE<span class="token operator">&gt;</span><span class="token number">301</span> Moved<span class="token operator">&lt;</span>/TITLE<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/HEAD<span class="token operator">&gt;</span><span class="token operator">&lt;</span>BODY<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>H<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token number">301</span> Moved<span class="token operator">&lt;</span>/H<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>
The document has moved
<span class="token operator">&lt;</span>A <span class="token assign-left variable">HREF</span><span class="token operator">=</span><span class="token string">&quot;http://www.google.com/&quot;</span><span class="token operator">&gt;</span>here<span class="token operator">&lt;</span>/A<span class="token operator">&gt;</span>.
<span class="token operator">&lt;</span>/BODY<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/HTML<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，docker 和 docker container 的网络代理都配置好了</p><h3 id="_4-2-dockerfile" tabindex="-1"><a class="header-anchor" href="#_4-2-dockerfile" aria-hidden="true">#</a> 4.2 DockerFile</h3><p>为了缩小镜像的大小，使用多阶段构建，在 <code>golang:alpine</code> 中编译再将可执行文件复制到 <code>gcr.io/distroless/static</code> 中</p><div class="language-docker line-numbers-mode" data-ext="docker"><pre class="language-docker"><code><span class="token comment">#</span>
<span class="token comment"># Build</span>
<span class="token comment">#</span>
<span class="token instruction"><span class="token keyword">FROM</span> golang:alpine <span class="token keyword">AS</span> build-env</span>
<span class="token comment"># set golang proxy</span>
<span class="token instruction"><span class="token keyword">ENV</span> GOPROXY https://goproxy.cn,direct</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
<span class="token instruction"><span class="token keyword">COPY</span> . /app</span>
<span class="token instruction"><span class="token keyword">RUN</span> go mod download <span class="token operator">\\</span>
	&amp;&amp; CGO_ENABLED=0 GOOS=linux go build -o /go-jwt-demo</span>
<span class="token comment">#</span>
<span class="token comment"># Deploy</span>
<span class="token comment">#</span>
<span class="token instruction"><span class="token keyword">FROM</span> gcr.io/distroless/static</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">build-env</span></span> /go-jwt-demo /</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 9090</span>
<span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">&quot;/go-jwt-demos&quot;</span>]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>CGO_ENABLED=0 GOOS=linux go build -o /go-jwt-demo</code> 因为要使用没有 C 库的环境，这里使用静态编译，CGO_ENABLED=0 表示不适用动态链接，GOOS=linux 指定环境为 linux</li><li><code>ENV GOPROXY https://goproxy.cn,direct</code>: golang 代理，这里使用国内的代理 如果没有配置这个，可以在后续构建过程中使用宿主机的网络代理直接下载</li></ul><p>创建镜像</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> build <span class="token parameter variable">--network</span><span class="token operator">=</span>host <span class="token parameter variable">-t</span> go-jwt-demo <span class="token builtin class-name">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这里注意使用 host 模式，为了使用宿主机的代理下载 go package</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> images
REPOSITORY                 TAG            IMAGE ID       CREATED         SIZE
go-jwt-demo                latest         45735a238f38   <span class="token number">9</span> minutes ago   <span class="token number">18</span>.6MB
golang                     alpine         6f9d081b1170   <span class="token number">38</span> hours ago    315MB
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到构建的镜像仅有 18.6 MiB</p><p>现在程序还无法运行，缺少 redis 支持，下面接着配置 redis</p><h3 id="_4-3-docker-redis" tabindex="-1"><a class="header-anchor" href="#_4-3-docker-redis" aria-hidden="true">#</a> 4.3 Docker Redis</h3><p>下载镜像</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> pull redis
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>启动容器</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--rm</span> <span class="token parameter variable">--name</span> <span class="token parameter variable">-p</span> <span class="token number">16379</span>:6379 redis-test redis
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><code>--rm</code>: 容器停止后自动删除容器</li></ul><p>测试</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ redis-cli <span class="token parameter variable">-h</span> localhost <span class="token parameter variable">-p</span> <span class="token number">16379</span>
localhost:1637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token function">ping</span>
PONG
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-container-connection" tabindex="-1"><a class="header-anchor" href="#_4-4-container-connection" aria-hidden="true">#</a> 4.4 Container Connection</h3><p>现在已经有了 golang 和 redis 容器，需要将其互联起来</p><p><code>docker run </code>的 <code>--link</code> 选项可以实现容器一对一的连接，但是不建议使用</p><p>下面将创建自定义的 docker 网络来连接多个容器</p><p>创建网络</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> network create <span class="token parameter variable">-d</span> bridge my-net
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><code>-d</code>: 指定网络类型，这里使用桥接模式</li></ul><p>修改下 <code>initilize/redis.go</code>（建议将配置写在配置文件中，使用 viper 来读取）</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>	rdb <span class="token operator">:=</span> redis<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>redis<span class="token punctuation">.</span>Options<span class="token punctuation">{</span>
		Addr<span class="token punctuation">:</span>     <span class="token string">&quot;my-redis:6379&quot;</span><span class="token punctuation">,</span>
		Password<span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
		DB<span class="token punctuation">:</span>       <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>go-jwt-redis</code>: 将作为我们 redis 容器的名字</li></ul><p>删除之前的镜像并重新构建</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> image <span class="token function">rm</span> go-jwt-demo:latest
Untagged: go-jwt-demo:latest
<span class="token comment"># ...</span>
$ <span class="token function">docker</span> build <span class="token parameter variable">--network</span> <span class="token function">host</span> <span class="token parameter variable">-t</span> go-jwt-demo <span class="token builtin class-name">.</span>
<span class="token comment"># ...</span>
$ <span class="token function">docker</span> images
REPOSITORY                 TAG            IMAGE ID       CREATED         SIZE
go-jwt-demo                latest         4ddd03c488b7   <span class="token number">4</span> seconds ago   <span class="token number">18</span>.6MB
<span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>         dd4ac9b09c0b   <span class="token number">6</span> seconds ago   557MB
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到使用<code>multi-stage</code>构建会产生 TAG <code>&lt;none&gt;</code> 的镜像</p><p>需要使用 <code>docker image prune</code> 清除，为了避免每次手动删除，创建 shell 脚本</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token shebang important">#!/usr/bin/env sh</span>
<span class="token comment"># build image</span>
<span class="token function">docker</span> build <span class="token parameter variable">--network</span> <span class="token function">host</span> <span class="token parameter variable">-t</span> go-jwt-demo <span class="token builtin class-name">.</span>
<span class="token function">yes</span><span class="token operator">|</span><span class="token function">docker</span> image prune
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下载官方的 redis 配置文件</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">curl</span> https://raw.githubusercontent.com/redis/redis/6.2/redis.conf <span class="token operator">&gt;</span> redis.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>接下来创建启动脚本，启动 golang application 和 redis</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token shebang important">#!/usr/bin/env sh</span>
<span class="token comment"># start redis container</span>
<span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\\</span>
    <span class="token parameter variable">-p</span> <span class="token number">16379</span>:6379 <span class="token punctuation">\\</span>
    <span class="token parameter variable">--name</span> my-redis <span class="token punctuation">\\</span>
    <span class="token parameter variable">--restart</span> always <span class="token punctuation">\\</span>
    <span class="token parameter variable">--network</span> my-net <span class="token punctuation">\\</span>
    <span class="token parameter variable">-v</span> <span class="token environment constant">$HOME</span>/my-docker-apps/redis/data:/data <span class="token punctuation">\\</span>
    <span class="token parameter variable">-v</span> <span class="token environment constant">$HOME</span>/my-docker-apps/redis/conf:/etc/redis <span class="token punctuation">\\</span>
    <span class="token parameter variable">-v</span> /etc/localtime:/etc/localtime:ro <span class="token punctuation">\\</span>
    redis:alpine <span class="token punctuation">\\</span>
    redis-server <span class="token parameter variable">--appendonly</span> <span class="token function">yes</span>
<span class="token comment"># start golang app</span>
<span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\\</span>
    <span class="token parameter variable">-p</span> <span class="token number">19090</span>:9090 <span class="token punctuation">\\</span>
    <span class="token parameter variable">--name</span> go-jwt-demo <span class="token punctuation">\\</span>
    <span class="token parameter variable">--restart</span> always <span class="token punctuation">\\</span>
    <span class="token parameter variable">--network</span> my-net <span class="token punctuation">\\</span>
    go-jwt-demo
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>--restart always</code>: 容器将会随着 docker 启动</li><li><code>--network my-net</code>: 使用自定义的网络</li><li><code>-v /etc/localtime:/etc/localtime:ro</code>: 同步宿主机时区</li></ul><p>启动脚本后即可测试</p><h2 id="reference" tabindex="-1"><a class="header-anchor" href="#reference" aria-hidden="true">#</a> Reference</h2>`,54),P={href:"https://jwt.io/introduction",target:"_blank",rel:"noopener noreferrer"},L={href:"http://jwt.io",target:"_blank",rel:"noopener noreferrer"},H={href:"https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html",target:"_blank",rel:"noopener noreferrer"},Y={href:"https://www.ruanyifeng.com/",target:"_blank",rel:"noopener noreferrer"},F={href:"https://pkg.go.dev/github.com/golang-jwt/jwt/v4@v4.1.0",target:"_blank",rel:"noopener noreferrer"},V={href:"https://learn.vonage.com/blog/2020/03/13/using-jwt-for-authentication-in-a-golang-application-dr/",target:"_blank",rel:"noopener noreferrer"},Z={href:"https://docs.docker.com/language/golang/build-images/",target:"_blank",rel:"noopener noreferrer"},X={href:"https://github.com/GoogleContainerTools/distroless/blob/main/examples/go/Dockerfile",target:"_blank",rel:"noopener noreferrer"},B={href:"https://github.com/GoogleContainerTools",target:"_blank",rel:"noopener noreferrer"},Q={href:"https://github.com/GoogleContainerTools/distroless",target:"_blank",rel:"noopener noreferrer"},$={href:"https://docs.docker.com/config/daemon/systemd/",target:"_blank",rel:"noopener noreferrer"},K={href:"https://docs.docker.com/engine/reference/commandline/cli/",target:"_blank",rel:"noopener noreferrer"};function nn(sn,an){const e=o("ExternalLinkIcon"),p=o("FlowChart");return c(),l("div",null,[r,n("p",null,[s("JSON Web Token (JWT) is an open standard ("),n("a",d,[s("RFC 7519"),a(e)]),s(") that defines a compact and self-contained way for securely transmitting information between parties as a JSON objec. This information can be verified and trusted because it is digitally signed. JWTs can be signed using a secret (with the HMAC algorithm) or a pulic/private key pair using RSA or ECDSA")]),k,n("ul",null,[n("li",null,[v,n("ul",null,[m,b,g,h,n("li",null,[n("a",f,[s("others"),a(e)])])]),w]),n("li",null,[n("p",null,[y,s(": These can be defined at will by those using JWTs. But to avoid collisions they should be defined in the "),n("a",T,[s("IANA JSON Web Token Registry"),a(e)]),s(" or be defined as a URI that contains a collision resistant namespace")])]),x]),q,n("p",null,[s("You also "),n("a",_,[s("should not store sensitive session data in browser storage due to lack of security"),a(e)]),s(".")]),I,n("ol",null,[n("li",null,[s("The application or client requests authorization to the authorization server. This is performed through one of the different authorization flows. For example, a typical "),n("a",S,[s("OpenID Connect"),a(e)]),s(" compliant web application will go through the "),j,s(" endpoint using the "),n("a",E,[s("authorization code flow"),a(e)]),s(".")]),C,O]),J,n("p",null,[s("代码可以在这里找到"),n("a",U,[s("go-jwt-note"),a(e)])]),R,n("p",null,[s("生成 jwt 成功， 可以在 "),n("a",A,[s("jwt.io"),a(e)]),s(" 上解析 token 验证")]),M,a(p,{id:"flowchart-652",code:"eJxljzFuwzAMRXedgmMKVIM9GrA69QQ9gWqxqdCEFES6QW9fWkqCGFlEiXyf+l/mIBqrTvCxFYdzQEoTvFNyeQ6Zyqq8qp0TtAesgpXiGSFSghJFLlyT4zLMgQvWqJlpgiMqxGVBEeUfpAZX/Koo39A6bmFKptlK7prO9zH8xlNO8NawcYft1tw5LkY9GKjoj0jb05w+Ln52kk25C9orXPC0sAW9JXbiQ/b2yeCbn6FnOPyhvNhk9AGvHWJrNOfd/xUxjwfl0m5dPBr6+smqfLYuun/BYou5",preset:"vue"}),N,n("p",null,[s("我们可以使用 scratch 构建或者使用 "),n("a",z,[s("GoogleContainerTools"),a(e)]),s("/**"),n("a",G,[s("distroless"),a(e)]),s("**来构建")]),n("p",null,[s("这里采用 docker 官方推荐的 "),n("strong",null,[n("a",D,[s("distroless"),a(e)])]),s(" 来进行构建")]),W,n("ol",null,[n("li",null,[n("a",P,[s("jwt"),a(e)]),s(),n("a",L,[s("jwt.io"),a(e)])]),n("li",null,[n("a",H,[s("JSON Web Token 入门教程"),a(e)]),s(),n("a",Y,[s("阮一峰"),a(e)])]),n("li",null,[n("a",F,[s("jwt-go"),a(e)]),s(" go docs")]),n("li",null,[n("a",V,[s("using jwt in golang application"),a(e)]),s(" victor steven")]),n("li",null,[n("a",Z,[s("build golang image"),a(e)]),s(" docker docs")]),n("li",null,[n("a",X,[s("distroless example golang dockerfile"),a(e)]),s(),n("a",B,[s("GoogleContainerTools"),a(e)]),s("/"),n("strong",null,[n("a",Q,[s("distroless"),a(e)])])]),n("li",null,[n("a",$,[s("docker set http and https proxy"),a(e)]),s(" docker docs")]),n("li",null,[n("a",K,[s("Automatic proxy configuration for containers"),a(e)]),s(" docker cli docs")])])])}const tn=i(u,[["render",nn],["__file","go-jwt.html.vue"]]);export{tn as default};
