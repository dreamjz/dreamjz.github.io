(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{618:function(s,a,n){"use strict";n.r(a);var t=n(5),e=Object(t.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[s._v("在之前的步骤中，我们完成了基本的文章增删改查功能，接下来就将其部署到 Docker 上")]),s._v(" "),n("p",[s._v("之前已经在 nginx 上部署了一个 vuepress 项目，这次就在另一个 nginx 上部署本项目")]),s._v(" "),n("p",[s._v("前端项目通过反向代理实现在同一域名下不同路径访问不同的应用：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("localhost/")]),s._v(":  为 vuepress blog")]),s._v(" "),n("li",[n("code",[s._v("localhost/app/")]),s._v(": 为本应用")])]),s._v(" "),n("p",[s._v("后端项目通过创建一个负载均衡 nginx 来转发前端的请求")]),s._v(" "),n("h2",{attrs:{id:"_1-fontend-deploy"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-fontend-deploy"}},[s._v("#")]),s._v(" 1. Fontend deploy")]),s._v(" "),n("h3",{attrs:{id:"_1-1-配置目录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-配置目录"}},[s._v("#")]),s._v(" 1.1 配置目录")]),s._v(" "),n("p",[s._v("创建资源文件夹，这里 conf 文件夹不用手动创建，后面从容器中复制一份出来")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("MyDockerApps\n└── blog-app\n    ├── app\n    │   ├── conf\n    │   ├── data\n    │   └── logs\n    └── blog\n        ├── conf\n        ├── data\n        └── logs\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("ul",[n("li",[n("code",[s._v("blog-app")]),s._v(": 应用根路径")]),s._v(" "),n("li",[n("code",[s._v("app")]),s._v(": 本应用")]),s._v(" "),n("li",[n("code",[s._v("blog")]),s._v(": vuepress blog 应用")]),s._v(" "),n("li",[n("code",[s._v("conf")]),s._v(": nginx 配置")]),s._v(" "),n("li",[n("code",[s._v("data")]),s._v(": 资源路径")]),s._v(" "),n("li",[n("code",[s._v("logs")]),s._v(": nginx 日志")])]),s._v(" "),n("p",[s._v("启动 nginx 并复制配置文件")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("$ docker run -d --rm --name test-nginx nginx\n$ docker container "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" test-nginx:/etc/nginx/ ./app\n$ docker container "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" test-nginx:/etc/nginx/ ./blog\n$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" ./app/nginx ./app/conf\n$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" ./blog/nginx ./blog/conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("ul",[n("li",[n("code",[s._v("--rm")]),s._v(": stop 容器时，容器自动删除")]),s._v(" "),n("li",[n("code",[s._v("docker container cp container:dir destDir")]),s._v(": 将容器内的文件复制到指定目录")])]),s._v(" "),n("h3",{attrs:{id:"_1-2-配置反向代理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-配置反向代理"}},[s._v("#")]),s._v(" 1.2 配置反向代理")]),s._v(" "),n("p",[s._v("修改"),n("code",[s._v("./blog/conf/conf.d/default.conf")]),s._v(", 建议将 "),n("code",[s._v("default")]),s._v(" 改为自定义的域名 "),n("code",[s._v("servername")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("server {\n    listen       80;\n    listen  [::]:80;\n    server_name  localhost;\n\n    access_log  /var/log/nginx/host.access.log  main;\n\n    location / {\n        root   /usr/share/nginx/html;\n        index  index.html index.htm;\n    }\n\n    location /app/ {\n         proxy_pass http://app/;\n    }\n    \n    error_page  404 /404.html;\n\n    # redirect server error pages to the static page /50x.html\n    error_page   500 502 503 504  /50x.html;\n    location = /50x.html {\n        root   /usr/share/nginx/html;\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])]),n("ul",[n("li",[n("code",[s._v("location /app/")]),s._v("  : URI 匹配，"),n("code",[s._v("proxy_pass")]),s._v(" 将 "),n("code",[s._v("/app/")]),s._v(" 的请求代理到指定地址\n需要注意的是 "),n("code",[s._v("http://app/")]),s._v(" 和 "),n("code",[s._v("http://app")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("http://app/")]),s._v(": 将会把 URI 去除前缀后追加至代理路径\n例如："),n("code",[s._v("htpp://localhost:/app/article")]),s._v(" 将被代理至 "),n("code",[s._v("http://app-nginx/article")])]),s._v(" "),n("li",[n("code",[s._v("http://app")]),s._v(": 将完整匹配的 URI 追加至代理路径\n例如： "),n("code",[s._v("htpp://localhost:/app/article")]),s._v(" 将被代理至 "),n("code",[s._v("http://app-nginx/app/article")])])])])]),s._v(" "),n("p",[n("code",[s._v("./blog/conf/nginx.conf")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('\nuser  nginx;\nworker_processes  auto;\n\nerror_log  /var/log/nginx/error.log notice;\npid        /var/run/nginx.pid;\n\n\nevents {\n    worker_connections  1024;\n}\n\n\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    log_format  main  \'$remote_addr - $remote_user [$time_local] "$request" \'\n                      \'$status $body_bytes_sent "$http_referer" \'\n                      \'"$http_user_agent" "$http_x_forwarded_for"\';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile        on;\n    #tcp_nopush     on;\n\n    keepalive_timeout  65;\n\n    #gzip  on;\n\n    include /etc/nginx/conf.d/*.conf;\n\n    upstream app {\n        server app-nginx:80;\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br")])]),n("ul",[n("li",[n("code",[s._v("upstream")]),s._v(": 配置上游服务\n"),n("ul",[n("li",[n("code",[s._v("app")]),s._v(": 名称")]),s._v(" "),n("li",[n("code",[s._v("server")]),s._v(": 指定地址，"),n("code",[s._v("app-nginx")]),s._v(" 为部署本应用的容器名，在容器加入同一网络之后，其将作为容器的域名")])])])]),s._v(" "),n("p",[n("code",[s._v("./app/conf/conf.d/default.conf")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("server {\n    listen       80; \n    listen  [::]:80;\n    server_name  localhost;\n\n    access_log  /var/log/nginx/host.access.log  main;\n\n    location / { \n        root   /usr/share/nginx/html;\n        index  index.html index.htm;\n    }   \n\n    error_page  404              /404.html;\n\n    # redirect server error pages to the static page /50x.html\n    error_page   500 502 503 504  /50x.html;\n    location = /50x.html {\n        root   /usr/share/nginx/html;\n    }   \n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])]),n("h3",{attrs:{id:"_1-4-docker-network"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-docker-network"}},[s._v("#")]),s._v(" 1.4 Docker Network")]),s._v(" "),n("p",[s._v("两个 nginx 容器需要使用 docker network 互联，创建 network")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("$ docker network create -d bridge blog-app-net\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[n("code",[s._v("-d")]),s._v(": 网络模式， "),n("code",[s._v("bridge")]),s._v(" 为桥接模式")])]),s._v(" "),n("h3",{attrs:{id:"_1-3-简单测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-简单测试"}},[s._v("#")]),s._v(" 1.3 简单测试")]),s._v(" "),n("p",[s._v("现在简单测试下反向代理的效果，为了方便可以编写启动容器的脚本")]),s._v(" "),n("p",[n("code",[s._v("start-app.sh")])]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/usr/bin/env sh")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# app-nginx ")]),s._v("\ndocker run -d "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        --name app-nginx "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -v "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/MyDockerApps/blog-app/app/conf:/etc/nginx:ro "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -v "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/MyDockerApps/blog-app/app/logs:/var/log/nginx "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -v "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/MyDockerApps/blog-app/app/data/dist:/usr/share/nginx/html "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -v /etc/localtime:/etc/localtime:ro "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        --network blog-app-net "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        --restart always "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        nginx \n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# blog-nginx")]),s._v("\ndocker run -d "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        --name blog-nginx "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -p "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18080")]),s._v(":80 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -v "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/MyDockerApps/blog-app/blog/conf:/etc/nginx:ro "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -v "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/MyDockerApps/blog-app/blog/logs:/var/log/nginx "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -v "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/MyDockerApps/blog-app/blog/data/dist:/usr/share/nginx/html "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -v /etc/localtime:/etc/localtime:ro "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        --network blog-app-net "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        --restart always "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        nginx \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])]),n("ul",[n("li",[n("code",[s._v("-v /etc/localtime:/etc/localtime:ro")]),s._v(": 同步宿主机时区")])]),s._v(" "),n("p",[n("code",[s._v("recreate-app.sh")])]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/usr/bin/env sh")]),s._v("\ndocker "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -f  blog-nginx app-nginx\n./start-app.sh\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[n("code",[s._v("restart-app.sh")])]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/usr/bin/env sh")]),s._v("\ndocker restart app-nginx blog-nginx \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("写入测试用的页面：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" ./blog/data/dist ./app/data/dist\n$ "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'HELLO BLOG'")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" ./blog/data/dist/index.html\n$ "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'HELLO APP'")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" ./app/data/dist/index.html\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("启动容器，并测试")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("$ ./start-app.sh\n$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://localhost:18080'")]),s._v("\nHELLO BLOG\n$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://localhost:18080/app/'")]),s._v("\nHELLO APP\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h3",{attrs:{id:"_1-4-deploy"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-deploy"}},[s._v("#")]),s._v(" 1.4 Deploy")]),s._v(" "),n("p",[s._v("测试反向代理成功后就可以部署前端应用了，vuepress 的项目可以使用上述的 "),n("code",[s._v("./blog/data/dist/index.html")]),s._v(" 替代")]),s._v(" "),n("h4",{attrs:{id:"_1-4-1-配置public-path"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-1-配置public-path"}},[s._v("#")]),s._v(" 1.4.1 配置Public Path")]),s._v(" "),n("p",[s._v("Vue CLI 默认认为应用部署在域名根路径，若需要部署在非根目录则需要修改 "),n("code",[s._v("publicPath")]),s._v(" 为对应的路径, 以及 router 和 axios 的baseurl")]),s._v(" "),n("p",[s._v("我们将不同的变量放在环境配置中，这样就可以根据环境使用不同的配置了，比如："),n("code",[s._v("dev")]),s._v(" 环境使用 "),n("code",[s._v("publicPath: '/'")]),s._v(" 即可而部署是可以改为 "),n("code",[s._v("‘/app/’")])]),s._v(" "),n("p",[s._v("修改"),n("code",[s._v(".env.production")]),s._v(" ,添加 "),n("code",[s._v("PUBLIC_PATH")]),s._v(" 并修改 server 参数")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# public path\nPUBLIC_PATH = '/app/'\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("将"),n("code",[s._v("vue.config.js")]),s._v(" 的 "),n("code",[s._v("publicPath")]),s._v(" 修改为环境变量")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" pulicPath "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" process"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("PUBLIC_PATH")]),s._v("\nmodule"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("export "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tpublicPath"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" pulicPath"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("  \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" baseURL "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" process"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("PUBLIC_PATH")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[s._v("createRouter")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Router")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    base"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" baseURL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// mode: 'history', // require service support")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[s._v("scrollBehavior")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" y"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    routes"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" constantRoutes\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" baseURL "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" process"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("PUBLIC_PATH")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" process"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("VUE_APP_BASE_API")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// create an axios instance")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" service "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" axios"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("create")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  baseURL"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" baseURL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// url = base url + request url")]),s._v("\n  withCredentials"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// send cookies when cross-domain requests")]),s._v("\n  timeout"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// request timeout")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("h4",{attrs:{id:"_1-4-2-部署脚本"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-2-部署脚本"}},[s._v("#")]),s._v(" 1.4.2 部署脚本")]),s._v(" "),n("p",[s._v("在前端项目根目录创建"),n("code",[s._v("deploy/deploy.sh")])]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/usr/bin/env sh")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" -e\n\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("yellowFront")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\e[33m'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("redFront")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\e[31m'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("greenFront")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\e[32m'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("restoe")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\e[0m'")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$yellowFront")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Start Deploy'")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$restoe")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" run build:prod\n    "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("distPath")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'dist'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("appPath")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/MyDockerApps/blog-app/app/data\n    "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$greenFront")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("' Deploying resources ...'")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$restoe")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" -d  "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$appPath")]),s._v("/dist "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$redFront")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'  Deleting exists resources ...'")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$restoe")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -rf "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$appPath")]),s._v("/dist\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" -r "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$distPath")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$appPath")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$greenFront")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("' Restart'")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("docker restart app-nginx"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$restoe")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$yellowFront")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Deploy Done'")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$restoe")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])]),n("p",[s._v("简单流程如下：")]),s._v(" "),n("ul",[n("li",[s._v("构建项目生成"),n("code",[s._v("dist")]),s._v("目录")]),s._v(" "),n("li",[s._v("删除原有的静态资源（若存在），将"),n("code",[s._v("dist")]),s._v("目录复制到资源目录")]),s._v(" "),n("li",[s._v("重启容器")])]),s._v(" "),n("p",[s._v("在"),n("code",[s._v("package.json")]),s._v("中添加指令")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('"deploy": "sh ./deploy/deploy.sh"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("执行部署脚本")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" run deploy\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("浏览器访问"),n("code",[s._v("http://localhost:18080/app/")]),s._v("可以成功进入 Dashboard 页面")]),s._v(" "),n("p",[s._v("现阶段项目的构建都是在本地环境的，但是对于每个人来说本地环境不尽相同，不能够保证构建结果一致")]),s._v(" "),n("p",[s._v("更好的做法是采用多阶段构建(mulit-stage build)在使用 docker 镜像进行编译构建以保证环境的一致性")]),s._v(" "),n("h2",{attrs:{id:"_2-load-balancer"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-load-balancer"}},[s._v("#")]),s._v(" 2. Load Balancer")]),s._v(" "),n("p",[s._v("本节将添加一个 nginx 作为负载均衡服务器并采用轮询策略将请求转发至三个后台服务")]),s._v(" "),n("p",[s._v("和上面类似，将配置文件挂载到本地")]),s._v(" "),n("p",[n("code",[s._v("start-load-banlancer.sh")])]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/usr/bin/env sh")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# load-balancer-nginx")]),s._v("\ndocker run -d "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -p "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19090")]),s._v(":80 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        --name load-balancer-nginx "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -v "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/MyDockerApps/blog-app/load-balancer/logs:/var/log/nginx "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -v "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/MyDockerApps/blog-app/load-balancer/conf:/etc/nginx "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -v /etc/localtime:/etc/localtime "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        --restart always "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        --network blog-app-net "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        nginx\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("修改配置文件"),n("code",[s._v("./load-balancer/conf/conf.d/localhost.conf")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("server {\n    listen       19090;\n    listen  [::]:19090;\n    server_name  localhost;\n\n    access_log  /var/log/nginx/host.access.log  main;\n\n    location / { \n        root   /usr/share/nginx/html;\n        index  index.html index.htm;\n    }   \n\n    error_page  404              /404.html;\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("配置负载均衡"),n("code",[s._v("./load-balancer/conf/nginx.conf")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('http {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    log_format  main  \'$remote_addr - $remote_user [$time_local] "$request" \'\n                      \'$status $body_bytes_sent "$http_referer" \'\n                      \'"$http_user_agent" "$http_x_forwarded_for"\';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile        on;\n    #tcp_nopush     on;\n\n    keepalive_timeout  65;\n\n    #gzip  on;\n\n    include /etc/nginx/conf.d/*.conf;\n\n    upstream go-server {\n        server blog-app-server-01:19091;\n        server blog-app-server-02:19092;\n        server blog-app-server-03:19093;\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br")])]),n("p",[n("code",[s._v("upstream go-server")]),s._v(": 设置了三个服务，默认是权重为 1 的加权轮询策略")]),s._v(" "),n("p",[s._v("至此，负载均衡服务就完成了，接下来部署后台服务")]),s._v(" "),n("h2",{attrs:{id:"_3-mysql-deploy"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-mysql-deploy"}},[s._v("#")]),s._v(" 3. Mysql Deploy")]),s._v(" "),n("p",[s._v("类似的，创建资源目录")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("blog-app\n└── mysql\n    ├── conf\n    └── data\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("ul",[n("li",[n("code",[s._v("conf")]),s._v(": mysql 配置")]),s._v(" "),n("li",[n("code",[s._v("data")]),s._v(": 存储 mysql 数据")])]),s._v(" "),n("p",[n("code",[s._v("start-mysql.sh")])]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/usr/bin/env sh")]),s._v("\n  \n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# blog-app-mysql")]),s._v("\ndocker run -d "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --name blog-app-mysql "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -v "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/MyDockerApps/blog-app/mysql/conf:/etc/mysql/conf.d "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -v "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/MyDockerApps/blog-app/mysql/data:/var/lib/mysql "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -v /etc/localtime:/etc/localtime:ro "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -e "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MYSQL_ROOT_PASSWORD")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pass "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --network blog-app-net "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --restart always "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    mysql\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("ul",[n("li",[n("code",[s._v("-v $HOME/MyDockerApps/blog-app/mysql/conf:/etc/mysql/conf.d")]),s._v(": 挂载自定义配置")]),s._v(" "),n("li",[n("code",[s._v("-v $HOME/MyDockerApps/blog-app/mysql/data:/var/lib/mysql")]),s._v(": 挂载数据库文件")]),s._v(" "),n("li",[n("code",[s._v("-e MYSQL_ROOT_PASSWORD=pass")]),s._v(": 设置 ROOT 用户密码")])]),s._v(" "),n("h3",{attrs:{id:"_3-1-初始化数据库"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-初始化数据库"}},[s._v("#")]),s._v(" 3.1 初始化数据库")]),s._v(" "),n("p",[s._v("启动容器后，执行 sql 脚本")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("$ docker "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -i blog-app-mysql "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" -c "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql -uroot -p${MYSQL_ROOT_PASSWORD}'")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" blog.sql\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[n("code",[s._v("sh -c")]),s._v(": "),n("code",[s._v("-c")]),s._v("后面的字符串讲作为 shell 的命令执行")])]),s._v(" "),n("p",[s._v("可以直接进入 容器访问 mysql")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("$ docker "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it blog-app-mysql "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\nmysql -u root -p\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("也可以启动一个同一 docker network 的临时 mysql 实例作为 client 进行访问")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("$ docker run -it --rm --network blog-app-net mysql mysql -hblog-app-mysql -uroot -p\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h2",{attrs:{id:"_4-backend-deploy"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-backend-deploy"}},[s._v("#")]),s._v(" 4. Backend Deploy")]),s._v(" "),n("h3",{attrs:{id:"_4-1-本地编译"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-本地编译"}},[s._v("#")]),s._v(" 4.1 本地编译")]),s._v(" "),n("p",[s._v("部署之前，先在本地编译好可执行文件")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("$ "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CGO_ENABLED")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GOOS")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("linux go build -o ./bin/blog-app-server main.go\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[n("code",[s._v("CGO_ENABLED=0")]),s._v(": 禁用 CGO 动态链接，采用静态链接库，因为运行环境在 scratch 镜像中")]),s._v(" "),n("li",[n("code",[s._v("GOOS")]),s._v(": 声明程序构建环境的目标操作系统")])]),s._v(" "),n("h3",{attrs:{id:"_4-2-dockerfile"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-dockerfile"}},[s._v("#")]),s._v(" 4.2 Dockerfile")]),s._v(" "),n("p",[s._v("创建 Dockerfile，这里使用 "),n("code",[s._v("scratch")]),s._v(" 镜像，这样构建的镜像会非常小")]),s._v(" "),n("div",{staticClass:"language-dockerfile line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[n("code",[n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" scratch")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app/config")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" ./bin/blog-app-server /app")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENV")]),s._v(" APP_ENV=docker")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 9090")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENTRYPOINT")]),s._v(" ["),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/app/blog-app-server"')]),s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("注意 scratch 中没有 shell ，无法直接使用 mkdir 创建目录")]),s._v(" "),n("p",[s._v("可以使用 WORKDIR 来创建目录， 或者在多阶段构建中从其他容器中复制过来")]),s._v(" "),n("p",[s._v("需要注意的是在 "),n("code",[s._v("WORKDIR /app/config")]),s._v(" 之后再次使用 "),n("code",[s._v("WORKDIR /app")]),s._v(" 将工作目录切换到了 "),n("code",[s._v("/app")])]),s._v(" "),n("p",[s._v("若切换的话，启动容器时应用会到"),n("code",[s._v("/app/config/config")]),s._v("下寻找配置文件，和预期不符")]),s._v(" "),n("p",[s._v("构建镜像并查看")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("$ docker build -t blog-app-server:local\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("$ docker image "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\nREPOSITORY                 TAG       IMAGE ID       CREATED          SIZE\nblog-app-server            "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v("    93827d1581c0   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" seconds ago   \t 18MB\ngolang                     alpine    6f9d081b1170   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" days ago      315MB\ngolang                     latest    d939cc1fb139   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" weeks ago      941MB\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("这里可以对比下 golang 官方和 goalng:alpine 的大小，使用 "),n("code",[s._v("scratch")]),s._v(" 镜像非常小")]),s._v(" "),n("p",[s._v("因为这些官方镜像包含了各种编译环境、库和工具等所以大小会比较大")]),s._v(" "),n("p",[s._v("也可以使用官方教程中使用的 "),n("code",[s._v("gcr.io/distroless/static")]),s._v(" 或 "),n("code",[s._v("gcr.io/distroless/base")]),s._v(" 参见 "),n("a",{attrs:{href:"https://github.com/GoogleContainerTools/distroless/blob/main/base/README.md",target:"_blank",rel:"noopener noreferrer"}},[s._v("Documentation for "),n("code",[s._v("gcr.io/distroless/base")]),s._v(" and "),n("code",[s._v("gcr.io/distroless/static")]),n("OutboundLink")],1),s._v("， 相比于 scratch 有着更好的安全性")]),s._v(" "),n("h3",{attrs:{id:"_4-3-资源目录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-资源目录"}},[s._v("#")]),s._v(" 4.3 资源目录")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("blog-app\n└── server\n    └── conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("创建配置文件 "),n("code",[s._v("./conf/config.docker.yaml")])]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("server")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9090")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("readTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10s\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("readHeaderTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10ms\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("writeTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10s\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("host")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" blog"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("mysql\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("username")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" root\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pass\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("database")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" gin_blog\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("charset")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" utf8\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("gorm")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tablePrefix")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" blog_\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("maxIdleConns")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("maxOpenConns")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("logLevel")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" error\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("ul",[n("li",[n("code",[s._v("host: blog-app-mysql")]),s._v(": 容器和 mysql 容器在同一网络下，容器名将作为域名")]),s._v(" "),n("li",[n("code",[s._v("logLevel: warn")]),s._v(": 生产环境可以提高 log level")])]),s._v(" "),n("h4",{attrs:{id:"_4-3-启动-container"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-启动-container"}},[s._v("#")]),s._v(" 4.3 启动 Container")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/usr/bin/env sh")]),s._v("\n  \n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("serverName")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"blog-app-server0"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("port")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19090")]),s._v("\n  \n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("((")]),s._v(" i"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")])]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("let")]),s._v(" port++\n    docker run -d "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        --name "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$serverName")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -p "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$port")]),s._v(":9090 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -v "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/MyDockerApps/blog-app/server/conf:/app/config "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -v /etc/localtime:/etc/localtime "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -e "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("APP_ENV")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("docker "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        --network blog-app-net "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        --restart always "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        blog-app-server:v1\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("上述脚本将启动三个后端容器")]),s._v(" "),n("h2",{attrs:{id:"_5-muli-stage-builds"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-muli-stage-builds"}},[s._v("#")]),s._v(" 5. Muli-stage builds")]),s._v(" "),n("p",[s._v("在上面的例子中，我们都是采用本地编译/构建然后将资源部署至本地挂载的目录中。但是这样有一个弊端，不能保证不同的环境编译或构建的结果，因为每个人的编译环境不尽相同不能保证其编译结果；若是个人项目的话只在单个设备上运行问题不大，若是需要部署到不同的环境中则需要保证结果的一致性。")]),s._v(" "),n("p",[s._v("多阶段构建 (Multi-stage build) 不仅可以解决上述问题，还可以有效的降低镜像的大小 （将构建结果直接复制到极小的镜像中运行，不必带入构建过程中的需要的工具，库等）")]),s._v(" "),n("p",[s._v("下面就来将前端和后端项目采用 Multi-stage 来构建镜像")]),s._v(" "),n("h3",{attrs:{id:"_5-1-front-end"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-front-end"}},[s._v("#")]),s._v(" 5.1 Front end")]),s._v(" "),n("p",[s._v("创建 "),n("code",[s._v(".dockerignore")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("**/dist\n**/node_modules\nyarn.lock\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("忽略掉不需要的文件和目录")]),s._v(" "),n("p",[s._v("创建"),n("code",[s._v("Dockerfile")])]),s._v(" "),n("div",{staticClass:"language-dockerfile line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Build")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node:17 "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" build-env")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" ./ /app")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENV")]),s._v(" NODE_OPTIONS=--openssl-legacy-provider")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" yarn config set registry https://registry.npm.taobao.org "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    && yarn config set proxy http://127.0.0.1:7890 "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    && yarn config set https-proxy http://127.0.0.1:7890 "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    && yarn install "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    && yarn run build:prod")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Deploy")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" nginx:alpine")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token options"}},[n("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("build-env")])]),s._v(" /app/dist /app")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("p",[n("code",[s._v("ENV NODE_OPTIONS=--openssl-legacy-provider")]),s._v(" 用于解决 "),n("code",[s._v("Error:0308010C")]),s._v(", 详情参见"),n("a",{attrs:{href:"https://stackoverflow.com/questions/69692842/error-message-error0308010cdigital-envelope-routinesunsupported",target:"_blank",rel:"noopener noreferrer"}},[s._v('Error message "error:0308010C:digital envelope routines::unsupported"'),n("OutboundLink")],1)]),s._v(" "),n("p",[s._v("构建镜像")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("$ docker build --network "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" -t app-blog:v1 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"_5-2-backend"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-backend"}},[s._v("#")]),s._v(" 5.2 Backend")]),s._v(" "),n("p",[s._v("创建 "),n("code",[s._v(".dockerignore")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("bin/\nconfig/\nblog.sql\nREADME.md\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[n("code",[s._v("Dockerfile")])]),s._v(" "),n("div",{staticClass:"language-dockerfile line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Build")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" golang:alpine "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" build-env")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Set proxy")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENV")]),s._v(" GOPROXY https://goproxy.cn,direct")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . /app")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" go mod download "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    && CGO_ENABLED=0 GOOS=linux go build -o /blog-app-server")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Deploy")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" gcr.io/distroless/static:latest")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app/config")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token options"}},[n("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("build-env")])]),s._v(" /blog-app-server /app")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 9090")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENTRYPOINT")]),s._v(" ["),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/app/blog-app-server"')]),s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])]),n("p",[s._v("构建镜像")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("$ docker build --network "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" -t blog-app-server:v1 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"_5-3-编写启动脚本"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-编写启动脚本"}},[s._v("#")]),s._v(" 5.3 编写启动脚本")]),s._v(" "),n("p",[s._v("在上面的步骤中我们都是一个个启动容器的，比较繁琐，现在我们优化一下启动脚本")]),s._v(" "),n("p",[s._v("在 "),n("code",[s._v("blog-app")]),s._v(" 目录下创建 "),n("code",[s._v("scripts")]),s._v(",并将之前的启动脚本放在这里并编写新的脚本一次启动所有容器")]),s._v(" "),n("p",[n("code",[s._v("start-apps.sh")])]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/usr/bin/env sh")]),s._v("\n  \n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# run all container")]),s._v("\n./app.sh\n./mysql.sh\n./server.sh\n./load-balancer.sh\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("这样就能一次性启动所有容器了")]),s._v(" "),n("h2",{attrs:{id:"_6-docker-compose"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-docker-compose"}},[s._v("#")]),s._v(" 6. Docker Compose")]),s._v(" "),n("p",[s._v("之前的步骤中我们使用了脚本来一次启动所有容器，但是如果需要重新启动，重新构建，配置网络等步骤需要编写更加复杂的脚本。当需要启动的容器数量越多，管理就越复杂")]),s._v(" "),n("p",[s._v("此时就需要用到 Docker Compose 来管理多个容器所构成的应用，具体介绍可以参见"),n("a",{attrs:{href:"https://docs.docker.com/compose/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Docker Compose"),n("OutboundLink")],1)]),s._v(" "),n("h3",{attrs:{id:"_6-1-compose-file"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-compose-file"}},[s._v("#")]),s._v(" 6.1 Compose File")]),s._v(" "),n("p",[s._v("在项目资源目录创建"),n("code",[s._v("/blog-app/docker-compose.yaml")]),s._v(", 不建议将其放在项目根目录，因为 Docker Compose 是用于编排和管理多个容器，不应和单个项目糅合在一起")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3.9"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("blog-nginx")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("alpine\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"18080:80"')]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bind\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${BLOG_NGINX_PATH}/conf"')]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/nginx \n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("read_only")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bind\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${BLOG_NGINX_PATH}/logs"')]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/log/nginx \n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bind \n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${BLOG_NGINX_PATH}/data/dist"')]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /usr/share/nginx/html\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bind\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/localtime\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/localtime\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("read_only")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("depends_on")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("nginx\n\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app-nginx")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("alpine\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bind\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${APP_NGINX_PATH}/conf"')]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/nginx \n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("read_only")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bind\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${APP_NGINX_PATH}/logs"')]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/log/nginx \n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bind \n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${APP_NGINX_PATH}/data/dist"')]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /usr/share/nginx/html\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bind\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/localtime\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/localtime\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("read_only")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("depends_on")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" load"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("balancer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("nginx\n\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("load-balancer-nginx")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("alpine\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"19090:80"')]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bind\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${LOAD_BALANCER_NGINX_PATH}/conf"')]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/nginx \n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("read_only")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bind\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${LOAD_BALANCER_NGINX_PATH}/logs"')]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/log/nginx \n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bind\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/localtime\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/localtime\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("read_only")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("depends_on")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" blog"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("server\n\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("server")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("build")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${BACKEND_PATH}/"')]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"9090"')]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bind\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${SERVER_PATH}/config"')]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /app/config\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bind\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/localtime\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/localtime\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("read_only")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always  \n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("depends_on")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" msyql"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("db\n\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql-db")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" mysql"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.0")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("MYSQL_ROOT_PASSWORD")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${MYSQL_ROOT_PASSWORD}"')]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bind\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${MYSQL_PATH}/conf"')]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/mysql/conf.d \n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("read_only")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bind\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${MYSQL_PATH}/data"')]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/lib/mysql \n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bind\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/localtime\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/localtime\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("read_only")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bind\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${MYSQL_PATH}/init"')]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /docker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("entrypoint"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("initdb.d\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br"),n("span",{staticClass:"line-number"},[s._v("91")]),n("br"),n("span",{staticClass:"line-number"},[s._v("92")]),n("br"),n("span",{staticClass:"line-number"},[s._v("93")]),n("br"),n("span",{staticClass:"line-number"},[s._v("94")]),n("br"),n("span",{staticClass:"line-number"},[s._v("95")]),n("br"),n("span",{staticClass:"line-number"},[s._v("96")]),n("br"),n("span",{staticClass:"line-number"},[s._v("97")]),n("br"),n("span",{staticClass:"line-number"},[s._v("98")]),n("br"),n("span",{staticClass:"line-number"},[s._v("99")]),n("br"),n("span",{staticClass:"line-number"},[s._v("100")]),n("br"),n("span",{staticClass:"line-number"},[s._v("101")]),n("br"),n("span",{staticClass:"line-number"},[s._v("102")]),n("br")])]),n("ul",[n("li",[n("code",[s._v("depends_on")]),s._v(": 仅表示依赖关系，但容器并不会等待依赖容器完全启动后再启动")])]),s._v(" "),n("h3",{attrs:{id:"_6-2-env-file"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-env-file"}},[s._v("#")]),s._v(" 6.2 "),n("code",[s._v(".env")]),s._v(" file")]),s._v(" "),n("p",[s._v("编写"),n("code",[s._v(".env")]),s._v(" 文件设置上面出现的环境变量")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("BLOG_NGINX_PATH=sample path\nAPP_NGINX_PATH=sample path\nLOAD_BALANCER_NGINX_PATH=sample path\nSERVER_PATH=sample path\nMYSQL_ROOT_PASSWORD=root pass\nMYSQL_PATH=sample path\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h3",{attrs:{id:"_6-3-启动服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-启动服务"}},[s._v("#")]),s._v(" 6.3 启动服务")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("$ docker compose -p ba up -d --scale "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("server")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[n("code",[s._v("-p")]),s._v(": 指定 project 名称，默认为当前目录的名称（例如 blog-app），启动的容器名格式为 "),n("code",[s._v("project-service-No.")]),s._v(", 例如 "),n("code",[s._v("ba-server-1")])]),s._v(" "),n("li",[n("code",[s._v("-d")]),s._v(": detached, 服务在后台运行")]),s._v(" "),n("li",[n("code",[s._v("--scale service=num")]),s._v(": 指定启动服务容器的数量，这里启动了三个后台服务")])]),s._v(" "),n("p",[s._v("至此完整的服务部署就完成了，在浏览器中访问 "),n("code",[s._v("http://localhost:18080/app/")]),s._v(" 即可访问")]),s._v(" "),n("h2",{attrs:{id:"reference"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#reference"}},[s._v("#")]),s._v(" Reference")]),s._v(" "),n("ol",[n("li",[n("a",{attrs:{href:"https://nginx.org/en/docs/",target:"_blank",rel:"noopener noreferrer"}},[s._v("nginx"),n("OutboundLink")],1),s._v(" nginx docs")]),s._v(" "),n("li",[n("a",{attrs:{href:"https://hub.docker.com/_/nginx",target:"_blank",rel:"noopener noreferrer"}},[s._v("docker nginx"),n("OutboundLink")],1),s._v(" docker hub")]),s._v(" "),n("li",[n("a",{attrs:{href:"https://cli.vuejs.org/zh/config/",target:"_blank",rel:"noopener noreferrer"}},[s._v("config"),n("OutboundLink")],1),s._v(" vue-cli docs")]),s._v(" "),n("li",[n("a",{attrs:{href:"https://router.vuejs.org/zh/guide/essentials/history-mode.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("history mode"),n("OutboundLink")],1),s._v(" vue-router docs")]),s._v(" "),n("li",[n("a",{attrs:{href:"https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/",target:"_blank",rel:"noopener noreferrer"}},[s._v("HTTP Load Balancing"),n("OutboundLink")],1),s._v(" nginx docs")]),s._v(" "),n("li",[n("a",{attrs:{href:"https://github.com/GoogleContainerTools/distroless/blob/main/base/README.md",target:"_blank",rel:"noopener noreferrer"}},[s._v("Documentation for "),n("code",[s._v("gcr.io/distroless/base")]),s._v(" and "),n("code",[s._v("gcr.io/distroless/static")]),n("OutboundLink")],1)]),s._v(" "),n("li",[n("a",{attrs:{href:"https://hub.docker.com/_/mysql",target:"_blank",rel:"noopener noreferrer"}},[s._v("docker mysql"),n("OutboundLink")],1),s._v(" docker hub")]),s._v(" "),n("li",[n("a",{attrs:{href:"https://docs.docker.com/develop/develop-images/multistage-build/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Use multi-stage builds"),n("OutboundLink")],1),s._v(" docker docs")]),s._v(" "),n("li",[n("a",{attrs:{href:"https://stackoverflow.com/questions/69692842/error-message-error0308010cdigital-envelope-routinesunsupported",target:"_blank",rel:"noopener noreferrer"}},[s._v('Error message "error:0308010C:digital envelope routines::unsupported"'),n("OutboundLink")],1),s._v(" stackoverflow")]),s._v(" "),n("li",[n("a",{attrs:{href:"https://docs.docker.com/compose/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Docker Compose"),n("OutboundLink")],1),s._v(" Docker docs")])])])}),[],!1,null,null,null);a.default=e.exports}}]);